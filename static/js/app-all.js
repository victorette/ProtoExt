/*
Copyright(c) 2012 CeRTAE
*/
function verifyMeta(h,b,f){var c=_MetaObjects[b];var e,j,g,d,a;if(!c){return h}if(c.lists&&(_SM.typeOf(c.lists)=="array")){for(a in c.lists){j=c.lists[a];if(typeof(j)!="string"){continue}e=_MetaObjects[j]||{};h[j]=_SM.verifyList(h[j],e.prpDefault);if(f){g={text:j,__ptType:j,__ptConfig:{__ptType:j},children:[]};f.children.push(g)}}}if(c.objects&&(_SM.typeOf(c.objects)=="array")){for(a in c.objects){j=c.objects[a];if(typeof(j)!="string"){continue}d=h[j];if(_SM.typeOf(d)!="object"){d={}}if(f){g=getNodeBase(j,j,{__ptType:j});f.children.push(g);h[j]=verifyMeta(d,j,g)}else{h[j]=verifyMeta(d,j)}}}return h}function clearPhantonProps(c,d){var a=_MetaObjects[d]||{};for(var b in c){if(!a.properties){continue}if(!(b in _SM.objConv(a.properties.concat(["name","__ptValue","__ptList","__ptType"])))){delete c[b]}}return c}_versionMeta="13.1201";_MetaObjects={pcl:{description:"Meta definition",properties:["viewCode","viewEntity","viewIcon","description","shortTitle","localSort","pageSize","sheetSelector","pciStyle","helpPath","idProperty","jsonField","returnField","updateTime","metaVersion","userVersion","protoEntity","protoEntityId","pciType"],objects:["gridConfig","gridSets","formConfig","usrDefProps","custom","businessRules"],lists:["fields","fieldsBase","fieldsAdm","actions","detailsConfig","sheetConfig"],roProperties:["viewCode","viewEntity","idProperty","updateTime","metaVersion","protoEntity","protoEntityId"]},fields:{description:"Store fields definition",listOf:"field"},fieldsBase:{description:"Base store fields definition",listOf:"field"},fieldsAdm:{description:"Admin store fields definition",listOf:"field"},field:{description:"A store field element",properties:["name","required","prpLength","prpScale","prpDefault","fieldLabel","format","header","sortable","searchable","flex","tooltip","cellLink","wordWrap","primary","crudType","readOnly","hidden","choices","fkId","fkField","cellLink","zoomModel","zoomFilter","zoomMultiple","cpFromField","cpFromZoom","physicalName","type","xtype","vType"],roProperties:[]},formField:{description:"A field element",properties:["name","tooltip","fieldLabel","labelWidth","labelAlign","hideLabel","required","readOnly","hidden","prpDefault","format","prpLength","collapsed","choices","fkId","fkField","zoomModel","zoomFilter","zoomMultiple","cellLink","type","xtype","vType"],roProperties:["type "]},gridConfig:{description:"Grid configuration properties",properties:["hideRowNumbers","gridSelectionMode","exportCsv","hideSheet","denyAutoPrint","filterSetABC"],lists:["listDisplay","baseFilter","initialFilter","initialSort","searchFields","sortFields","hiddenFields","readOnlyFields"],objects:[]},colShortcuts:{description:"Column configuration shortcuts",lists:["searchFields","sortFields","hiddenFields","readOnlyFields"]},gridSets:{description:"Additional settings ( filters, sorters, userViews )",lists:["listDisplaySet","filtersSet","sortersSet"]},custom:{description:"custom user configurations",lists:["listDisplay","listDisplaySet","filtersSet","sortersSet"]},baseFilter:{description:'Default defined filter. No user-modifiable, e.g. { "status__exact":"0" } ',listOf:"filterDef",allowAdd:true},customFilter:{description:"Predefined filter ",listOf:"filterDef",allowAdd:true},initialFilter:{description:'Initial filter  Ej: { "status__exact":"0" } ',listOf:"filterDef",allowAdd:true},initialSort:{description:'Default ordering  Ej: [{"direction":"ASC","property":"code"}, ... ] ',listOf:"sorterDef",allowAdd:true},sorterDef:{description:"Sort definition",addPrompt:"Please enter the name of the property for your sorter:",allowDel:true,nodeName:"property",properties:["property","direction"]},sortersSet:{description:"Sorter set",listOf:"sortersSetDef",allowAdd:true},sortersSetDef:{description:"Sorter set definition",addPrompt:"Please enter the name of the sorter:",allowDel:true,properties:["name","description"],lists:["customSort"]},customSort:{description:"User ordering",listOf:"sorterDef",allowAdd:true},filterDef:{description:"Predefined filter definition",addPrompt:"Please enter the name of the property for your filter:",allowDel:true,nodeName:"property",properties:["property","filterStmt"]},filtersSet:{description:"Predefined filter set ( *x*, ><=, !=,  aa:bb ) ",listOf:"filtersSetDef",allowAdd:true},filtersSetDef:{description:"Filter set definition",addPrompt:"Please enter the name of the filterSet:",allowDel:true,properties:["name","menuText"],lists:["customFilter"]},listDisplaySet:{description:"Alternative configuration for the grid ( it appears under the icon 'ViewCols' of the main bar )",listOf:"listDisplayDef",allowAdd:true},listDisplayDef:{description:"Predefined column set (view)",addPrompt:"Please enter the name of the columnSet:",allowDel:true,properties:["name","hideRowNumbers","description"],lists:["listDisplay"]},hiddenFields:{description:"List of hidden fields",__ptStyle:"colList"},listDisplay:{description:"List of fields to display in the grid",addPrompt:"Please enter the name for your alternative listDisplay:",__ptStyle:"colList"},readOnlyFields:{description:"List of fields to marked as ReadOnly ( the property ReadOnly can also be used )",__ptStyle:"colList"},searchFields:{description:"Search-enabled fields",__ptStyle:"colList"},sortFields:{description:"Order-enabled fields",__ptStyle:"colList"},detailsConfig:{description:"Details definition (Master-Detail relationship)",listOf:"detailDef",allowAdd:true},detailDef:{description:"Master-Detail relationship definition",properties:["menuText","conceptDetail","masterField","detailField","detailName","detailTitleLbl","masterTitleField","detailTitleField"],addPrompt:"Please enter the name for your detail:",allowDel:true},usrDefProps:{description:"User defined properties ( Fields created by the user, they do not participe in search and sort)",properties:["udpTable","propertyRef","keyField","propertyPrefix","propertyName","propertyValue"]},sheetConfig:{description:"Information templates in HTML that are fed by data from the database",listOf:"sheetDef",allowAdd:true},sheetDef:{description:"Templates definition ( the name is the selector )",properties:["name","template","title","viewIcon","sheetType","templateFp","templateBb","templateEr","templateAb","templateLp"],lists:["sheetDetails"],addPrompt:"Please enter the name for your sheet:",allowDel:true},sheetDetails:{description:"Lista de detalles por hoja ( sheet )",listOf:"sheetDetail",allowAdd:true},sheetDetail:{description:"Sheet detail configuration",properties:["name","detailName","detailSort","templateBb","templateEr","templateAb"],lists:["sheetDetails"],addPrompt:"Please enter the detailName:",allowDel:true},formConfig:{hideItems:true,description:"Form definition",properties:["title","tooltip","height","maxHeight","minHeight","width","maxWidth","minWidth","viewIcon","helpPath"]},fieldset:{hideItems:true,description:"A Fieldset, containing field elements",properties:["title","fsLayout","autoscroll","border","collapsible","collapsed","labelWidth","labelAlign","hideLabel","height","maxHeight","minHeight"]},htmlset:{hideItems:true,description:"A Fieldset, containing HtmlField elements",properties:["title","collapsible","collapsed","flex","height","maxHeight","minHeight"]},protoGrid:{description:"A detail grid",properties:["viewCode","menuText","height","maxHeight","minHeight","minWidth"]},panel:{hideItems:true,description:"A simple panel with fit layout",properties:["title","height","maxHeight","minHeight"]},tabpanel:{hideItems:true,description:"A Tab Container with many tabs",properties:["layout","activeItem","height","maxHeight","minHeight"]},actions:{description:"Actions list (Actions menu)",listOf:"actionDef",allowAdd:true},actionDef:{description:"Actions definition (backend)",properties:["name","title","actionType","selectionMode","refreshOnComplete"],lists:["actionParams"],addPrompt:"Please enter the name for your action:",allowDel:true},actionParams:{description:"Actions definition parameters",listOf:"actionParam",allowAdd:true},actionParam:{properties:["name","tooltip","fieldLabel","prpDefault","required","readOnly","format","choices","fkId","fkField","zoomModel","zoomFilter","cellLink","type","xtype","vType"],addPrompt:"Action parameter",allowDel:true},businessRules:{properties:["dblClick","afterCellUpdate","afterRowDelete","afterSave","beforeCellEdit","beforeCellUpdate","beforeRowDelete","beforeRowInsert","beforeOpSave","beforeValidate","zoomConfigure","zoomReturn","issRowLoad","reposition","getLinkFilter","validationComplete"]},businessRule:{properties:["name","handler","src","type","field"],addPrompt:"Action parameters",allowDel:true},businessRulesText:{description:"Business rules",properties:["afterCellUpdate","afterRowDelete","BeforeCellEdit","BeforeCellUpdate","BeforeRowDelete","BeforeRowInsert","dblClick","issZoomConfigure","issBeforeVslidateVr","issHelpReturn","issRowLoad","reposition","getLinkFilter","afterOpSave","beforeOpSave","issValidationComplete"]}};function verifyPrpType(c,b){var a=_MetaProperties[c+".type"];if(!a){if(typeof(b)=="string"){return b.replace(/~+$/,"")}else{return b}}if(a==typeof(b)){return b}switch(a){case"boolean":if((typeof(b)=="number")){b=b.toString()}if((typeof(b)=="string")){if(b.substr(0,1).toLowerCase() in _SM.objConv(["y","s","1","o","t"])){return true}else{return false}}else{return false}case"number":return parseFloat(b);case"null":return null;default:return b}}_MetaProperties={"metaVersion.help":"Internal meta version","userVersion.help":"Application version","exportCsv.help":"Csv export enabled?","exportCsv.type":"boolean","localSort.help":"local sort?, (n/a for prototypes)",localSorttype:"boolean","pageSize,help":"Page size","pageSize.type":"number","qbeHelp.type":"boolean","qbeHelp.help":"visible trigger for select distinct (interne)","required.type":"boolean","readOnly.type":"boolean","primary.type":"boolean","viewEntity.help":"Backend model (Django)","viewCode.help":"Definicion de view code -  app.model.view","description.help":"Description","viewIcon.help":"iconName  (css name)","shortTitle.help":"Menu and form title","idProperty.help":"Id property (future use)","protoEntity.help":"Default prototype entity ( prototype.protoTable.xxx )  (Internal use with protoEntityId)",pciStyle:"grid","pciStyle.help":"Presentation mode [ form,  grid, tree]","pciStyle.choices":["grid","form","tree"],"gridSelectionMode.choices":["multi","simple","single"],"gridSelectionMode.help":"multi*: multiple selection with check; simple: selection on/off ; single: Last selected","denyAutoPrint.type":"boolean","denyAutoPrint.help":"deny auto print (future use)",masterField:"pk","menuText.help":"Menu title ( toolbar )","detailName.help":"Detail key (for report detail)","conceptDetail.help":"Detail concept ( [App.]Model o [App.]Model.View )","masterField.help":"Master field for MD navigation (normaly Pk)","detailField.help":"Detail field for filter (normaly conceptName)","detailTitleLbl.help":"Detail title for filter","masterTitleField.help":"Master field title (filter name)","detailTitleField.help":"Master field title (copy from master title in detail edition)",propertyPrefix:"udp","propertyPrefix.help":"udp prefix (upd__xxxxx)","propertyName.help":"udp property name","propertyValue.help":"udp property value","propertyRef.help":"udp concept ref","keyField.help":"udp source<br>** Only for non MD udp (internal use)","udpTable.help":"udp concept name , <b>** if direct link then related_name, normaly udpTable","sheetSelector.help":"field sheet selecto, null for DEFAULT sheet","template.help":"template definition","templateFp.help":"Templante FirstPage","templateLp.help":"Templante LastPage","templateBb.help":"Templante BeforeBlock","templateAb.help":"Templante AfterBlock",templateBb:"<spam>------------------------------------</spam><br>",templateAb:"<spam>====================================</spam><br>","templateEr.help":"EveryRow",templateFp:'<!DOCTYPE html><html><head><meta content="text/html; charset=UTF-8" http-equiv="Content-Type" /><link href="/static/css/print.css" rel="stylesheet" type="text/css" media="screen,print" /><title>PtReport : {{reportTitle}}</title></head><body>',templateLp:"</body></html>",direction:"sort order","direction.choices":["ASC","DESC"],"physicalName.help":"phisical name or function  @str( f1,f2 )",required:false,"required.help":"Required field","allowDecimals.help":"Dont use!!! : allow decimal (internal use)",autoscroll:true,"autoscroll.help":"t/f","choices.help":"comma separed values for combo selection",collapsed:false,"collapsed.help":"t/f collapsed","collapsed.type":"boolean",zoomMultiple:false,"zoomMultiple.type":"boolean","zoomMultiple.help":"Multiple selection on add",collapsible:false,"collapsible.help":"t/f","collapsible.type":"boolean","cellToolTip.help":"Use this field form line tooltip","cellToolTip.type":"boolean","cellLink.help":"Is a cellLink?","cellLink.type":"boolean","xtype.help":"frontend widget (use vType also)","xtype.choices":["","textfield","combobox","checkbox","numberfield","textarea","datefield"],prpScale:0,"prpScale.help":"Decimal scale ( 0 int, 2 dec )","prpDefault.help":"Default value","fieldLabel.help":"Field label (in form)","format.help":"input mask (automatic for date, time and numbers) (future use)",fsLayout:"fluid","fsLayout.choices":["fluid","1col","2col","3col"],"fsLayout.help":"Automatic layout distribution","header.help":"Column header (grid)  default for fieldLabel","height.type":"number","height.help":"The height value in pixels","helpPath.help":"/help/xxxx.html  real: /static/help","hidden.help":"Hiden field (future use)","hidden.type":"boolean","hideLabel.help":"Hide label? (ex: firstName, lastName)","hideSheet.help":"Hide sheet?","hideRowNumbers.help":"Hide row numbers?","hideRowNumbers.type":"boolean","hideCheckSelect.type":"boolean","hideCheckSelect.help":"Hide check select?","filterSetABC.help":"Auto alphabetic filter",labelAlign:"left","labelAlign.choices":["left","top"],"labelAlign.help":"Label align (left, top)","labelWidth.help":"Label width","maxHeight.help":"The max value in pixels","maxWidth.help":"The max value in pixels","maxHeight.type":"number","maxWidth.type":"number","minHeight.help":"The minimum value in pixels","minWidth.help":"The minimum value in pixels","minHeight.type":"number","minWidth.type":"number","height.type":"number","width.type":"number","flex.type":"number","flex.help":"Flex width eqivalence",readOnly:false,"readOnly.help":"ReadOnly field?","title.help":"Title","tooltip.help":"Microhelp","sortable.help":"Sortable?","sortable.type":"boolean","searchable.help":"Searchable?","searchable.type":"boolean","type.help":"Field type","type.choices":["","string","text","bool","int","decimal","combo","date","datetime","time","autofield","html","foreignid","foreigntext"],"vType.help":"Validation type","vType.choices":["","email","ip4","ip6","tel","postalCodeCA","postalCodeUSA"],"width.help":"The width value in pixels","wordWrap.type":"boolean","wordWrap.help":"Auto wordWrap (more than one line)","sheetType.help":"Sheet type (Grid, Report)","sheetType.choices":["","printerOnly","gridOnly"],"detailName.help":"Detail name (used in MD definition)","actionType.help":"Action type (backend function)","actionType.choices":["user","insTrigger","updTrigger","delTrigger","wflow"],"refreshOnComplete.type":"boolean","paramType.help":"Parameter type","paramType.choices":["","string","bool","number"],"cpFromField.help":"Derived by copy","cpFromZoom.help":"Derived form zoom (fk property)? ","crudType.help":"Crud type","crudType.choices":["","editable","screenOnly","storeOnly","insertOnly","updateOnly","linked","copied"],"selectionMode.help":"Grid selection mode for actions","selectionMode.choices":["none","single","multiple"]};_SM={};_SM._ROW_ST={REFONLY:"REF_ONLY",ERROR:"ROWST_ERR",NEWROW:"ROWST_NEW"};_SM._requiredField='<span style="color:red;font-weight:bold" data-qtip="Required">*</span>';_SM._versionProto="";_SM._siteTitle="Portrait du logiciel libre dans l'administration publique de Qu&eacute;bec";_SM._siteTitleCollapsed=false;_SM.footerExtraContent='<div class="centre"><div id="pied"><div class="confidentialite"><a href="http://www.gouv.qc.ca/portail/quebec/pgs/commun/informationsutiles/confidentialite/?lang=fr">Politique de confidentialit&eacute;</a></div><a href="http://www.gouv.qc.ca" title="Lien vers un autre site. Cliquer sur le bouton droit pour l\'ouvrir dans une nouvelle fenetre." target="_Blank"><img src="protoExt/static/img/quebw1.gif" alt="Signature du gouvernement du Qu&eacute;bec." name="logoqc" width="105" height="32" border="0" id="logoqc"/></a><div class="droits" >&copy; <a href="http://www.droitauteur.gouv.qc.ca/copyright.php" target="_Blank">Gouvernement du Qu&eacute;bec, 2012</a></div></div></div>';_SM.__language={};_SM._PConfig={urlMenu:"protoLib/protoGetMenuData/",urlGetPCI:"protoLib/protoGetPCI/",urlSaveProtoObj:"protoLib/protoSaveProtoObj/",urlGetFieldTree:"protoLib/protoGetFieldTree/",urlGetDetailsTree:"protoLib/protoGetDetailsTree/",urlGetUserRights:"protoLib/protoGetUserRights/",urlGetPasswordRecovery:"protoLib/protoGetPasswordRecovery/",urlSubmitChangePassword:"protoLib/submitChangePassword/",urlGetSheetReport:"protoLib/sheetConfigRep/",urlGetProtoCsv:"protoLib/protoCsv/",urlDoAction:"protoLib/protoDoActions/",urlHelpQbe:"protoLib/protoGetHelpQbe/",urlLogOut:"protoLib/protoLogout/",urlGetNextIncrement:"protoLib/getFieldIncrement/",clsBaseModel:"ProtoUL.model."};_SM._HELPpath="resources/help/index.html";_SM._cllPCI={};_SM._gridTypeEditor={"int":"numberfield","float":"numberfield",string:"textfield",text:"textarea",date:"datefield","boolean":"checkbox"};_SM._PAGESIZE=50;_SM._ComboPageSize=[["25"],["50"],["100"],["500"]];_SM._AUTOLOAD_PCI=[];_SM._MENU_COLLAPSED=false;_SM._defaultViewIcon="default_view";_SM._mainWin=null;_SM._winX=10;_SM._winY=10;_SM.DesignerPanels={tbar:[{tooltip:"Update definition",iconCls:"icon-save",itemId:"save"},{iconCls:"icon-update",tooltip:"Redraw",itemId:"redraw"},"-",{tooltip:"Delete curren node",iconCls:"icon-nodeDelete",disabled:false,itemId:"delete"},"->",{iconCls:"icon-error",tooltip:"Show or hide(clear) error tab",itemId:"error",hidden:true,enableToggle:true,errors:[],errorCount:0,maxErrors:60}],toolsTabs:[{xtype:"tabpanel",activeTab:0,border:false,defaults:{layout:"fit"},items:[{title:"Tools",itemId:"toolsTree",tooltip:"Design your ui by selecting elements from this tab",layout:"fit",autoScroll:true},{title:"Properties",tooltip:"Object properties",itemId:"properties",autoScroll:true,border:false}]}],toolsTree:[{text:"Fields",children:[]},{text:"Containers",children:[{text:"fieldset",qtip:"A Fieldset, containing other form elements",__ptType:"fieldset",children:[],__ptConfig:{__ptType:"fieldset"}},{text:"htmlset",qtip:"A Fieldset, containing HML elements",__ptType:"htmlset",children:[],__ptConfig:{__ptType:"htmlset"}}]},{text:"Details",children:[]}]};_SM.typeOf=function(b){var a=typeof b;if(a==="object"){if(b){if(Object.prototype.toString.call(b)=="[object Array]"){a="array"}}else{a="null"}}return a};_SM.objConv=function(b){var d={};if(!b){return d}for(var c=0;c<b.length;c++){d[b[c]]=""}return d};_SM.OpenFile=function(a){};_SM.copyProps=function(g,f,e,d,c){if(!e){e=true}var b=_SM.clone(g,0,c);for(var a in f){if(e||!g[a]){if(!d||a in _SM.objConv(d)){b[a]=f[a]}}}return b};_SM.clone=function(f,h,d,c){if(h){h=h+1}else{h=1}if(h>5){return f}if(null==f||"object"!=typeof f){return f}if(f instanceof Date){var g=new Date();g.setTime(f.getTime());return g}else{if(f instanceof Array){var g=[];var b=f.length;for(var e=0;e<b;++e){g[e]=_SM.clone(f[e],h,d,c)}return g}else{if(f.$class){var g={};if(f.hasOwnProperty("initialConfig")){g.initialConfig=_SM.clone(f.initialConfig,h,d,c)}return g}else{if(f instanceof Object){var g={};for(var a in f){if(a in _SM.objConv(["events","renderer"])){continue}if((d)&&(a in _SM.objConv(d))){continue}if((c)&&!(a in _SM.objConv(c))){continue}if(f.hasOwnProperty(a)){g[a]=_SM.clone(f[a],h,d,c)}}return g}else{}}}}};_SM.FormatJSON=function(a,h){var b="&nbsp; &nbsp; ";var d="<br>";if(!h){h=""}else{if(h==" "){b="";d=""}}var e=_SM.typeOf(a);if(e=="array"){if(a.length==0){return"[]"}var c="["}else{var f=0;for(var g in a){f++;break}if(f==0){return"{}"}var c="{"}var f=0;for(var k in a){var j=a[k];if(f>0){c+=","}if(e=="array"){c+=(d+h+b)}else{c+=(d+h+b+'"'+k+'": ')}switch(_SM.typeOf(j)){case"array":case"object":c+=_SM.FormatJSON(j,(h+b));break;case"boolean":if(j){c+="true"}else{c+="false"}break;case"number":c+=j.toString();break;case"null":c+="null";break;case"string":j=j.replace(/'/g,"\\'").replace(/"/g,'\\"');if(h!=" "){j=j.replace(/</g,"&lt;").replace(/>/g,"&gt;")}c+=('"'+j+'"');break;default:c+=("TYPEOF: "+_SM.typeOf(j))}f++}if(e=="array"){c+=(d+h+"]")}else{c+=(d+h+"}")}return c};_SM.VerifyLast=function(a,b){if(!b){b=","}if(a[a.length-1]==b){a=a.substring(0,a.length-1)}return a};_SM.FormatJsonStr=function(a){var d={};if(!a){return d}try{d=Ext.decode(a)}catch(c){}var b=_SM.FormatJSON(d);return b};_SM.charCount=function(a,b){if(a){return a.split(b).length}else{return 0}};_SM.clearProps=function(b){for(var a in b){if(!b[a]&&b[a]!=false){delete b[a]}else{if(_SM.typeOf(b[a])=="string"&&b[a].trim()==""){delete b[a]}}}return b};_SM.errorMessage=function(a,b){_SM.__StBar.showError(b,a)};_SM.updateWinPosition=function(b,a){_SM._winX+=40;_SM._winY+=20;if((_SM._winX+b)>_SM._mainWin.width||(_SM._winY+a)>_SM._mainWin.height){_SM._winX=10;_SM._winY=10}};_SM.savePclCache=function(a,b,c){b.viewCode=a;_SM.DefineProtoModel(b);_SM._cllPCI[a]=b;if(c){_SM.CloseProtoTab(a);_SM._mainWin.loadPciFromMenu(a)}};_SM.getModelName=function(a){return _SM._PConfig.clsBaseModel+a};_SM.getSafeMeta=function(b){var a={viewCode:b.viewCode,viewEntity:b.viewEntity,localSort:b.localSort||false,protoEntityId:b.protoEntityId,jsonField:b.jsonField||"",idProperty:b.idProperty,gridConfig:{searchFields:_SM.clone(b.gridConfig.searchFields)},fields:_SM.clone(b.fields,0,[],["name","type","zoomModel","fkId","crudType","cpFromField","cpFromZoom","physicalName"]),usrDefProps:_SM.clone(b.usrDefProps)};return Ext.encode(a)};_SM.getGridColumn=function(d,c){for(var a in d.myColumns){var b=d.myColumns[a];if(b.dataIndex==c){return b}}};_SM.showConfig=function(c,b){var a=Ext.create("Ext.window.MessageBox",{minHeight:200,maxHeight:500,defaultMinHeight:200,defaultMaxHeight:500,defaultTextHeight:250,styleHtmlContent:true});var d=_SM.FormatJSON(b," ");a.show({width:800,multiline:true,value:d,title:c})};_SM.getCurrentTime=function(){return Ext.Date.format(new Date(),"Y-m-d H:i:s")};_SM.verifyList=function(b,a){if((!a)||(_SM.typeOf(a)!="array")){a=[]}if(_SM.typeOf(b)!="array"){b=a}else{if(b.length==0){b=a}}return b};_SM.verifyObj=function(b,a){if((!a)||(_SM.typeOf(a)!="object")){a={}}if(_SM.typeOf(b)!="object"){b=a}else{b=Ext.apply(a,b)}return b};_SM.obj2tx=function(c){var a=typeof c;if(a=="string"){a=c}else{try{a=Ext.encode(c)}catch(b){a="[]"}}return a};_SM.ptPrompt=function(b,a){return prompt(a)};_SM.openScript=function(b){var a=document.createElement("script");a.src=b;document.head.appendChild(a)};_SM.fireEvent=function(type,myMeta,eventData,scope,fn){me=scope;var code=myMeta.businessRules[type]||null;eventData.type=type;_SM.eventData=eventData;_SM.eventData.cancel=false;if(code!=null){if(type=="DblClick"||type=="default"){_SM.eventData.HDataField=scope._extGrid.columns[_SM.eventData.cellIndex].dataIndex}eval(code);if(!_SM.eventData.cancel){fn()}}else{fn()}};_SM.GetRowValue=function(c){try{var a=_SM.eventData.record.get(c);return a}catch(b){return null}};_SM.CloseProtoTab=function(a){_SM.__TabContainer.closeProtoTab(a)};_SM.Product=function(f){var g=f[0];var e=f.slice(1);if(g){var b=[];if(e.length>0){var a=_SM.Product(e);for(var d=0;d<a.length;d++){for(var c=0;c<g.length;c++){b.push([g[c]].concat(a[d]))}}}else{for(var c=0;c<g.length;c++){b.push([g[c]])}}return b}else{return[]}};_SM.getStoreDefinition=function(a){var b=Ext.create("Ext.data.Store",{viewCode:a.viewCode,model:_SM.getModelName(a.viewCode),autoLoad:a.autoLoad,pageSize:a.pageSize,remoteSort:!(a.localSort||false),sorters:a.sorters,defaultSortDirection:"ASC",sortOnLoad:true,autoSync:true,proxy:_SM.getProxyDefinition(a),storeDefinition:a,myLoadData:function(e,d,c){if(c){this.protoMasterId=c}if(e){this.clearFilter();this.getProxy().extraParams.protoFilter=_SM.obj2tx(e);this.load()}else{if(d){this.sort(d)}}},mySetBaseFilter:function(c){this.clearFilter();this.getProxy().extraParams.protoFilter=_SM.obj2tx([]);this.getProxy().extraParams.baseFilter=_SM.obj2tx(c.concat(this.storeDefinition.baseFilter));this.load()},listeners:{beforeload:function(d,c,e){_SM.__StBar.showBusy(_SM.__language.StatusBar_Message_Loading+d.viewCode,"beforeLoad")},beforesync:function(c,d){_SM.__StBar.showBusy(_SM.__language.StatusBar_Message_Sync+this.viewCode,"beforeSync")},datachanged:function(c,f){_SM.__StBar.clear(c.viewCode,"dataChanged");try{var d=_SM.clone(c.getSorters(),0,[],["property","direction"]);c.proxy.extraParams.sort=Ext.encode(d)}catch(g){}},write:function(f,e,g){var d;for(d in e.records){var j=e.resultSet.records[d],c=e.records[d];if(j){if(e.action=="create"){c.data=j.data}else{if(e.action=="destroy"){if(j.data._ptStatus!==""){f.insert(0,j)}}}}var h=c.get("_ptStatus");if(h){c.dirty=true;if(!c.getId()){c.phantom=true}}}}}});return b};_SM.getProxyDefinition=function(a){return{type:"ajax",batchActions:true,batchOrder:"create,update,destroy",api:{read:"protoLib/protoList/",create:"protoLib/protoAdd/",update:"protoLib/protoUpd/",destroy:"protoLib/protoDel/"},actionMethods:{create:"POST",read:"POST",update:"POST",destroy:"POST"},reader:{type:"json",root:"rows",successProperty:"success",totalProperty:"totalCount",messageProperty:"message"},writer:{type:"json",root:"rows",allowSingle:false,writeAllFields:true,encode:true,messageProperty:"message"},extraParams:{viewCode:a.viewCode,protoFilter:_SM.obj2tx(a.protoFilter),baseFilter:_SM.obj2tx(a.baseFilter),protoMeta:_SM.obj2tx(a.sProtoMeta)},listeners:{exception:function(d,c,b){var f,e=b.getError();if(typeof(e)=="string"){f=e}else{f="REMOTE EXCEPTION: ("+e.status+") "+e.statusText}_SM.__StBar.showError(f,"storeException")}}}};_SM.getTreeStoreDefinition=function(a){var b=Ext.create("Ext.data.TreeStore",{viewCode:a.viewCode,model:_SM.getModelName(a.viewCode),autoLoad:a.autoLoad,pageSize:a.pageSize,sorters:a.sorters,proxy:_SM.getProxyDefinition(a),remoteSort:true,autoSync:true,root:{expanded:true}});return b};_SM.getNewRecord=function(b,d){function c(){var f={},e,g;for(e in b.fields){vFld=b.fields[e];if(!vFld.prpDefault){continue}f[vFld.name]=vFld.prpDefault}return f}var a=new d.model(c());a.store=d;return a};_SM.getRecordByDataIx=function(d,c,b){var a=d.findExact(c,b);if(a===-1){return}return d.getAt(a)};_SM.IsAdmField=function(b,a){if(/_id$/.test(b.name)){return true}if(a.jsonField==b.name){return true}if(a.protoEntityId){if(b.name in _SM.objConv(["smCreatedBy","smModifiedBy","smCreatedOn","smWflowStatus","smRegStatus"])){return true}if(b.name=="id"){return true}if(b.name=="entity"){return true}}return false};_SM.DefineProtoModel=function(f){f=verifyMeta(f,"pcl");var c=[];var e=[],b=[],d={};for(var a in f.fields){var g=f.fields[a];if(_SM.IsAdmField(g,f)){b.push(g)}else{e.push(g)}if(!g.type){g.type="string"}d={name:g.name,type:g.type};if(!g.type in _SM.objConv(["string","text","html","bool","int","decimal","combo","date","datetime","time","protoN2N","autofield","foreignid","foreigntext"])){g.type="string";d.type="string";d.readOnly=true}if(g.name in _SM.objConv(f.gridConfig.hiddenFields)){d.hidden=true;g.hidden=true}if(g.name in _SM.objConv(f.gridConfig.readOnlyFields)){d.readOnly=true;g.readOnly=true}if(g.name in _SM.objConv(f.gridConfig.sortFields)){g.sortable=true}switch(g.type){case"decimal":d.type="number";break;case"jsonfield":d.readOnly=true;d.type="json";break;case"date":d.type="date";d.dateFormat="Y-m-d";break;case"datetime":d.type="string";break;case"time":d.type="date";d.dateFormat="H:i:s";break}c.push(d)}d={name:"_ptStatus",type:"string"};c.push(d);d={name:"_ptId",type:"string"};c.push(d);Ext.define(_SM.getModelName(f.viewCode),{extend:"Ext.data.Model",fields:c});f.fieldsBase=e;f.fieldsAdm=b};_SM.getFieldDict=function(b){var d={};for(var a in b.fields){var c=b.fields[a];c.idProtoGrid=b.idProtoGrid;d[c.name]=c}return d};_SM.getColDefinition=function(d){if(!d.header){d.header=d.name}var h,k,e;h={dataIndex:d.name,text:d.header};k=["flex","width","minWidth","sortable","hidden","xtype","readOnly","render","align","format","tooltip","idProtoGrid"];h=_SM.copyProps(h,d,true,k);k=["prpDefault","required","readOnly","minLength","minLengthText","maxLength","maxLengthText","step","minValue","minText","maxValue","maxText","disabledDays","disabledDaysText","zoomModel","zoomMultiple","fkId","zoomFilter","cpFromField","cpFromZoom","idProtoGrid"];e=_SM.copyProps({},d,true,k);if(d.required===true){h.allowBlank=false;e.allowBlank=false;h.allowOnlyWhitespace=false;e.allowOnlyWhitespace=false}if(!d.type){d.type="string"}if(d.choices&&d.choices.split(",").length>1){d.type="combo"}switch(d.type){case"string":if(!h.flex){h.flex=1}break;case"text":if(!h.flex){h.flex=2}h.renderer=b;break;case"int":case"secuence":h.xtype="numbercolumn";h.align="right";h.format="0,000";e.xtype="numberfield";e.format=h.format;e.align="right";e.allowDecimals=false;break;case"decimal":case"money":h.xtype="numbercolumn";h.align="right";h.format="0,000.00";e.xtype="numberfield";e.format=h.format;e.align="right";e.allowDecimals=true;e.decimalPrecision=2;break;case"date":h.xtype="datecolumn";h.format="Y/m/d";e.xtype="datefield";e.format=h.format;break;case"datetime":break;case"time":h.xtype="datecolumn";h.format="H:i";e.xtype="timefield";e.format=h.format;break;case"bool":h.xtype="mycheckcolumn";h.editable=false;h.inGrid=true;e.xtype="checkbox";break;case"combo":e.xtype="combobox";e.typeAhead=true;e.triggerAction="all";e.selectOnTab=true;var g=d.choices;if(_SM.typeOf(g)=="string"){g=g.split(",")}else{g=[]}e.store=g;e.lazyRender=true;e.listClass="x-combo-list-small";break;case"foreigntext":if(!h.flex){h.flex=1}d.cellLink=true;e.xtype="protoZoom";e.editable=false;break;case"foreignid":e.xtype="numberfield";e.hidden=true;break;case"autofield":break}if(!h.minWidth){h.minWidth=70}switch(h.xtype){case"mycheckcolumn":case"datecolumn":case"numbercolumn":break;case"checkbox":h.xtype="mycheckcolumn";break;case"datefield":h.xtype="datecolumn";break;case"numberfield":h.xtype="numbercolumn";break;default:delete h.xtype}if(((d.type=="autofield")||d.readOnly)&&(d.type!="bool")){h.renderer=j}else{h.editor=e}if(d.wordWrap===true){h.renderer=b}if(d.cellToolTip){h.renderer=c}if(d.cellLink){h.renderer=f}if(d.vType){if(d.vType=="stopLight"){h.renderer=a}}if(!h.sortable){h.sortable=false}return h;function b(l){return'<div style="white-space:normal; text-align:justify !important";>'+l+"</div>"}function c(q,n,m,r,p,o,l){n.tdAttr='data-qtip="'+q+'"';return q}function j(q,n,m,r,p,o,l){return'<span style="color:grey;">'+q+"</span>"}function f(l){return'<a href="#">'+l+"</a>"}function a(q,l,n,o,s,r,p){var m=Ext.baseCSSPrefix,t=[];if(q>66){t.push(m+"grid-stopligth-green")}else{if(q>33){t.push(m+"grid-stopligth-yellow")}else{if(q>0){t.push(m+"grid-stopligth-red")}}}return'<div class="'+t.join(" ")+'">&#160;'+q+"</div>"}};_SM.getFormFieldDefinition=function(c){var b=_SM.getColDefinition(c),a={readOnly:true};if(b.editor){a=b.editor}a.name=c.name;a.fieldLabel=c.fieldLabel||c.header||c.name;a.fieldLabel=a.fieldLabel.replace("<b>","").replace("</b>","");if(c.required){a.fieldLabel="<b>"+a.fieldLabel+"</b>"}if(c.primary){a.afterLabelTextTpl=_SM._requiredField}a.fieldLabel=Ext.util.Format.capitalize(a.fieldLabel);if(c.required&&!c.fkId){a.listeners={blur:function(){this.setValue(Ext.String.trim(this.getValue()))},render:function(d){}}}switch(c.type){case"text":a.xtype="textarea";a.height=100;a.labelAlign="top";break;case"html":a.xtype="textarea";a.height=100;a.labelAlign="top";break}a.__ptType="formField";if(!a.xtype){a.xtype="textfield"}return a};_SM.loadPci=function(a,c,b){b=b||{};var d=_SM._cllPCI[a];if(d&&Ext.ClassManager.isCreated(_SM.getModelName(a))){d.viewCode=a;return true}else{if(!c){return false}Ext.applyIf(b,{scope:this,success:Ext.emptyFn,failure:Ext.emptyFn});Ext.Ajax.request({method:"POST",url:_SM._PConfig.urlGetPCI,params:{viewCode:a},scope:this,success:function(e,g){var f=Ext.decode(e.responseText);if(f.success){_SM.savePclCache(a,f.protoMeta);_SM._UserInfo.perms[a]=f.permissions;b.success.call(b.scope,e,g)}else{_SM.errorMessage("loadPC",f.message);b.failure.call(b.scope,e,g)}},failure:function(e,f){_SM.errorMessage("loadPC","");b.failure.call(b.scope,e,f)}});return false}};_SM.savePci=function(d,c){if(!d){return}var a=d.viewCode;d.updateTime=_SM.getCurrentTime();if(d.fieldsBase){d=_SM.clone(d);delete d.fieldsBase;delete d.fieldsAdm;delete d.custom}var b=Ext.encode(d);_SM.saveProtoObj(a,b,c)};_SM.saveProtoObj=function(a,b,c){c=c||{};Ext.applyIf(c,{scope:this,success:Ext.emptyFn,failure:Ext.emptyFn});Ext.Ajax.request({method:"POST",url:_SM._PConfig.urlSaveProtoObj,params:{viewCode:a,protoMeta:b},success:function(d,f){var e=Ext.decode(d.responseText);if(e.success){c.success.call(c.scope,d,f)}else{c.failure.call(c.scope,d,f);_SM.errorMessage(_SM.__language.Message_Error_SaveProtoObj,e.message)}},failure:function(d,e){_SM.errorMessage(_SM.__language.Message_Error_SaveProtoObj,d.status+" "+d.statusText);c.failure.call(c.scope,d,e)},scope:this,timeout:30000})};_SM.loadJsonConfig=function(b,a){a=a||{};Ext.applyIf(a,{scope:this,success:Ext.emptyFn,failure:Ext.emptyFn});Ext.Ajax.request({method:"POST",url:"/resources/"+b,scope:a.scope,success:function(c,d){a.success.call(a.scope,c,d)},failure:function(c,d){_SM.errorMessage("LoadJsonConfig",c.status+" "+c.statusText);a.failure.call(a.scope,c,d)}})};_SM.defineProtoPclTreeModel=function(){Ext.define("Proto.PclTreeNode",{extend:"Ext.data.Model",fields:[{name:"__ptType",type:"string"},{name:"text",type:"string"},{name:"id",type:"string"},{name:"__ptConfig"}]})};_SM.getSheeReport=function(a,c,d,b){b=b||{};Ext.applyIf(b,{scope:this,success:Ext.emptyFn,failure:Ext.emptyFn});Ext.Ajax.request({method:"POST",url:_SM._PConfig.urlGetSheetReport,params:{viewCode:a,sheetName:c,selectedKeys:Ext.encode(d)},success:function(e,f){b.success.call(b.scope,e,f)},failure:function(e,f){_SM.errorMessage(_SM.__language.Message_Error_Reporting,e.status+" "+e.statusText);b.failure.call(b.scope,e,f)},scope:this,timeout:60000})};_SM.doProtoActions=function(b,a,e,d,f,c){d=d||[];c=c||{};Ext.applyIf(c,{scope:this,success:Ext.emptyFn,failure:Ext.emptyFn});Ext.Ajax.request({method:"POST",url:_SM._PConfig.urlDoAction,params:{viewCode:b,actionName:a,parameters:Ext.encode(d),actionDef:Ext.encode(f),selectedKeys:Ext.encode(e)},success:function(g,h){c.success.call(c.scope,g,h)},failure:function(g,h){_SM.errorMessage("ActionReport Failed",g.status+" "+g.statusText);c.failure.call(c.scope,g,h)},scope:this,timeout:60000})};_SM.sortObjByName=function(d,c){var f=d.name.toLowerCase(),e=c.name.toLowerCase();if(f<e){return -1}if(f>e){return 1}return 0};_SM.__language={Text_Validate_Login_Button:"se connecter",Text_change_Password_Button:"changer le mot de passe",Text_Forgotten_Password:"mot de passe perdu",Textfield_User_Login:"utilisateur",Textfield_User_Email:"courriel",Textfield_Password_Login:"mot de passe",Textfield_New_Password:"nouveau mot de passe",Textfield_Confirm_Password:"confirmer le mot de passe",Title_Window_Email_Request:"Récupérer le mot de passe perdu",Title_Window_Password_Change:"Changez votre mot de passe",Text_Send_Button:"Envoyer",Message_Enter_Email:"Entrez votre courriel",Message_Success:"Succès",Message_Email_Forgotten_Password:"Un courriel a été envoyé avec les instructions",Message_Email_New_Password:"Un courriel a été envoyé avec votre nouveau mot de passe",Message_Success_Password_Change:"Le mot de passe a été changé avec succès",Message_Error:"Error",Message_Error_Login:"Impossible de se connecter",StatusBar_Message_Loading:"Loading"};Ext.define("ProtoUL.UI.ConfigController",{extend:"Ext.Base",myMeta:null,constructor:function(a){Ext.apply(this,a||{});this.getProtoConfigBar()},getProtoConfigBar:function(){var f=this;function d(g){f.configAction(g.prCfgAction)}function b(j,g,h){var k=Ext.create("Ext.Action",{text:g,iconCls:h,prCfgAction:j,scope:f,handler:d});return k}var a=[],e=this.__MasterDetail;this.viewCode=this.myMeta.viewCode;var c=_SM._UserInfo.perms[this.viewCode];if(c.config){a.push(b("Form",_SM.__language.MetaConfig_Form_Config,"icon-configForm"));a.push(b("Fields",_SM.__language.MetaConfig_Add_Fields,"icon-configFields"));a.push(b("Details",_SM.__language.MetaConfig_Add_Details,"icon-configDetails"));a.push(b("Config",_SM.__language.MetaConfig_Base_Config,"icon-configCustom"));a.push(b("Meta",_SM.__language.MetaConfig_Meta_Config,"icon-configMeta"))}else{if(c.custom){a.push(b("Custom",_SM.__language.MetaConfig_Custom_Config,"icon-configCustom"))}}if(a.length>0){e.tbConfigOpts=Ext.create("Ext.toolbar.Toolbar",{dock:"top",hidden:true,enableOverflow:true,items:[{xtype:"tbtext",text:"<strong>"+_SM.__language.Text_Config+"</strong>"}]});e.tbConfigOpts.add(a);e.myConfigOpts=a;e.protoMasterGrid.addDocked(e.tbConfigOpts)}},configAction:function(a){switch(a){case"Meta":this.showMetaConfig();break;case"Custom":this.showCustomConfig(false);break;case"Config":this.showCustomConfig(true);break;case"Form":this.showProtoDesigner();break;case"Fields":this.showFieldTree();break;case"Details":this.showDetailsTree();break}},showMetaConfig:function(){var b=_SM._cllPCI[this.viewCode];if(!b){return}var a=Ext.widget("protoPcl",{myMeta:b,editable:true});this.showConfigWin(a)},showCustomConfig:function(d){var b=_SM._cllPCI[this.viewCode],c;if(!b){return}var a=Ext.widget("protoPcl",{myMeta:b,custom:true,metaConfig:d,editable:true});if(d){c="Base Config"}else{c="Custom Config"}this.showConfigWin(a)},showFieldTree:function(){var a=_SM._cllPCI[this.viewCode];if(!a){return}var b=Ext.create("ProtoUL.proto.ProtoFieldSelector",{viewCode:this.viewCode,myMeta:a});this.showConfigWin(b)},showProtoDesigner:function(){var b=_SM._cllPCI[this.viewCode];if(!b){return}var a=Ext.widget("protoDesigner",{myMeta:b,viewCode:this.viewCode});this.showConfigWin(a)},showDetailsTree:function(){var b=_SM._cllPCI[this.viewCode];if(!b){return}var a=Ext.create("ProtoUL.proto.ProtoDetailSelector",{myMeta:b,viewCode:this.viewCode});this.showConfigWin(a)},showConfigWin:function(c,b){if(!b){b="MetaDefinition"}var a=Ext.widget("window",{constrain:true,title:b+" [ "+this.viewCode+" ]",width:900,height:600,minHeight:400,minWidth:400,layout:"fit",constrainHeader:true,resizable:true,maximizable:true,collapsible:true,items:c});a.show()}});Ext.define("ProtoUL.UI.FormController",{extend:"Ext.Base",myMeta:null,myMetaDict:null,viewCode:null,isReadOnly:false,formLoaded:false,myWidth:620,myHeight:460,newForm:false,constructor:function(a){Ext.apply(this,a||{});this.myMetaDict={}},_loadFormDefinition:function(){function a(j,g){var h={scope:j,success:function(m,k,l){j._waitForDetails(j,g)},failure:function(m,k,l){j._waitForDetails(j,g);_SM.errorMessage("ProtoDefinition Error :",g+": protoDefinition not found")}};if(_SM.loadPci(g,true,h)){j._waitForDetails(j,g)}}Ext.suspendLayouts();this.myMetaDict[this.myMeta.viewCode]=false;var e=this,d=e.myMeta.detailsConfig,f,b,c;for(f in d){b=d[f];this.myMetaDict[b.conceptDetail]=false}e.loaded=false;for(c in e.myMetaDict){if(c in _SM._cllPCI){e.myMetaDict[c]=true}else{a(e,c)}}if(!e.loaded){e._waitForDetails(e)}Ext.resumeLayouts(true)},_waitForDetails:function(b,a){if(a){b.myMetaDict[a]=true}for(a in b.myMetaDict){if(!b.myMetaDict[a]){return}}if(b.loaded){return}b.loaded=true;b.newProtoForm.call(b);b.myForm.setActiveRecord(this.myRecordBase);b.myForm.store=this.myRecordBase.store;if(b.isReadOnly){b.myForm.setFormReadOnly(true)}else{b.myForm.setReadOnlyFields(true,b.myMeta.gridConfig.readOnlyFields)}b.newWindowLoad.call(b,b);b.myWin.show();b.myForm.setDetailsTilte()},newProtoForm:function(){this.defineFormLayout();this.myForm=Ext.widget("protoform",{myMeta:this.myMeta,newForm:this.newForm,myFormController:this,prFormLayout:this.prFormLayout});return this.myForm},newWindow:function(a){a._loadFormDefinition()},newWindowLoad:function(b){_SM.updateWinPosition(b.myWidth,b.myHeight);var a="";if(b.newForm){a=" *"}b.myForm.setZoomEditMode(b.myForm);b.myWin=Ext.widget("window",{title:b.myMeta.viewCode+a,closeAction:"hide",width:b.myWidth,height:b.myHeight,style:"z-index: -1;",x:_SM._winX,y:_SM._winY,minHeight:400,minWidth:400,layout:"fit",constrainHeader:true,maximizable:true,resizable:true,modal:true,items:b.myForm});b.myForm.on({close:function(){b.myWin.close()},hide:function(){b.myWin.hide()},scope:b})},openNewForm:function(b){this.isReadOnly=false;this.newForm=true;this.myStore=b;var a=_SM.getNewRecord(this.myMeta,b);this.openForm(a)},openLinkedForm:function(a,b){this.newForm=false;this.isReadOnly=b;this.openForm(a)},openForm:function(a){if(!a){_SM.errorMessage("Form Error","Undefined input record");return}this.myRecordBase=a;this.newWindow(this)},openProtoForm:function(b,a,c){this.viewCode=b;this.isReadOnly=!c;if(!a){_SM.errorMessage("LinkedForm Error : "+b,"not fkId field definition found");return}this._getFormDefinition(a)},_getFormDefinition:function(a){var b={scope:this,success:function(e,c,d){this._openAndLoad(this.viewCode,a)},failure:function(e,c,d){_SM.errorMessage("ProtoDefinition Error :",this.viewCode+": protoDefinition not found")}};if(_SM.loadPci(this.viewCode,true,b)){this._openAndLoad(this.viewCode,a)}},_openAndLoad:function(b,a){this.myMeta=_SM._cllPCI[b];this.formLoaded=true;this._loadFormData(a)},_loadFormData:function(a){if(!this.formLoaded){return}var d=[{property:"pk",filterStmt:a}],c={viewCode:this.viewCode,autoLoad:true,baseFilter:d,sProtoMeta:_SM.getSafeMeta(this.myMeta)},e=_SM.getStoreDefinition(c),b;if(a>=0){e.load();e.on({load:function(g,f,j,h){if(this.myWin){return}this.openLinkedForm(f[0],this.isReadOnly)},scope:this})}else{b=_SM.getNewRecord(this.myMeta,e);this.openForm(b)}},defineFormLayout:function(){function g(t,w,l,o){var r,x,u,p=_SM.typeOf(l);if(p=="object"){if(!l.__ptConfig){l.__ptConfig=getSimpleProperties(l)}if(!l.__ptConfig.name){l.__ptConfig.name=o}u=l.__ptConfig.__ptType||l.__ptType;if(!u){return{}}else{if(u=="formField"){o=l.name||l.__ptConfig.name;var n=c[o];if(n){x=getTemplate(u,true,n);if(n.required&&!n.fkId&&t.newForm){x.__ptConfig.listeners.render=function(y){Ext.Ajax.request({url:_SM._PConfig.urlGetNextIncrement,method:"GET",params:{fieldName:n.name,viewEntity:t.myMeta.viewEntity},success:function(z,B){var A=Ext.decode(z.responseText);y.setValue(A.increment)},failure:function(){console.log("failure on get increment")}})}}r=Ext.apply(x.__ptConfig,l.__ptConfig);if(r.xtype=="protoZoom"){r.readOnlyCls="protoLink"}else{if(r.xtype=="checkbox"){}else{r.readOnlyCls="protofield-readonly"}}}else{r={text:o,xtype:"label",margin:"4",padding:"4",border:1,tooltip:"field definition not found",style:{borderColor:"red",borderStyle:"solid",bodyStyle:";border-right:none;border-left:none;border-top:none;"}}}}else{if(u=="protoGrid"){if(_SM.loadPci(l.viewCode,false)){x=getTemplate(u,true);r=Ext.apply(x.__ptConfig,l.__ptConfig);if((!r.minWidth)||(r.minWidth<100)){r.minWidth=250}r.initialFilter=[{property:"pk",filterStmt:-1}];delete l.__ptConfig.name}else{r={xtype:"label",margin:"4",padding:"4",border:1,text:"ERROR: grid definition not found "+l.viewCode,style:{borderColor:"red",borderStyle:"solid",bodyStyle:";border-right:none;border-left:none;border-top:none;"}};_SM.errorMessage("defineProtoFormItem",l.viewCode+" not found!!")}}else{if(u=="htmlset"){x=getTemplate(u,true);r=Ext.apply(x.__ptConfig,l.__ptConfig);r.htlmFields=l.items;delete l.__ptConfig.name}else{x=getTemplate(u,true);r=Ext.apply(x.__ptConfig,l.__ptConfig);r.items=[];var j=l.items,m;for(m in j){if(m.indexOf("__pt")==0){continue}var q=j[m];var v=g(t,l,q,m);if(v){r.items.push(v)}}}}}}var k=r.fsLayout;if(k){r.defaultType="textfield";r.layout="column";r.defaults={padding:"2 2"};if(k=="1col"){r.defaults.columnWidth=1}else{if(k=="2col"){r.defaults.columnWidth=0.5}else{if(k=="3col"){r.defaults.columnWidth=0.33}}}delete r.fsLayout;r.fieldDefaults={};s(r,"labelAlign");s(r,"labelWidth");s(r,"hideLabel")}if(r.tooltip){r.listeners={render:function(y){Ext.create("Ext.tip.ToolTip",{target:y.getEl(),trackMouse:true,html:r.tooltip})}}}}else{if(p=="array"){r=[];for(var m in l){var q=l[m];var v=g(t,w,q,m);if(v){r.push(v)}}}}return r;function s(A,z){var y=A[z];if(y){A.fieldDefaults[z]=y}}}var d=this,a=_SM.clone(this.myMeta.formConfig),f=this.myMeta,c=_SM.getFieldDict(f);d.prFormLayout=[];for(var e in a.items){var h=a.items[e];var b=g(d,{__ptType:"panel"},h);d.prFormLayout.push(b)}}});Ext.define("ProtoUL.UI.GridController",{extend:"Ext.Base",myMeta:null,myGrid:null,store:null,constructor:function(a){Ext.apply(this,a||{})},addNavigationPanel:function(){var d=this.myGrid,b=["-"];var c=new Ext.form.ComboBox({name:"perpage",width:60,store:new Ext.data.ArrayStore({fields:["id"],data:_SM._ComboPageSize}),mode:"local",value:"50",listWidth:60,triggerAction:"all",displayField:"id",valueField:"id",editable:false,forceSelection:true});c.on("select",function(g,f){d.store.pageSize=parseInt(g.getValue(),10);d.store.load();if(d.store.currentPage!=1){d.store.loadPage(1)}},d);if(d.protoIsDetailGrid){b.push({text:_SM.__language.GridNav_In_New_Tab,iconCls:"icon-promote",handler:e})}b.push(c,_SM.__language.GridNav_PageSize);var a={xtype:"pagingtoolbar",border:false,dock:"bottom",store:d.store,displayInfo:true,items:b,afterPageText:_SM.__language.GridNav_Total+" {0}",beforePageText:_SM.__language.GridNav_Page,firstText:_SM.__language.GridNav_First_Page,nextText:_SM.__language.GridNav_Next_Page,prevText:_SM.__language.GridNav_Previous_Page,lastText:_SM.__language.GridNav_Last_Page,refreshText:_SM.__language.GridNav_Refresh,displayMsg:_SM.__language.GridNav_Current+" : {0} - {1} "+_SM.__language.GridNav_Total+" {2}"};d.addDocked(a);function e(){var f=d.detailDefinition;_SM.__TabContainer.addTabPanel(d.store.viewCode,d.protoFilter,d.detailTitle)}},addGridTools:function(c){var b=!c,a;a=[{itemId:"toolFormAdd",tooltip:_SM.__language.GridBtn_Ttip_Add_Form,type:"formAdd",width:20,hidden:b,scope:this,handler:this.onEditAction},{itemId:"toolFormUpd",tooltip:_SM.__language.GridBtn_Ttip_Edit_Form,hidden:b,type:"formUpd",width:20,scope:this,handler:this.onEditAction},{itemId:"toolRowDel",type:"rowDel",tooltip:_SM.__language.GridBtn_Ttip_Del_Record,hidden:b,width:30,scope:this,handler:this.onEditAction},{itemId:"toolFormView",tooltip:_SM.__language.GridBtn_Ttip_Read_Only,type:"formView",width:20,scope:this,handler:this.onEditAction},{itemId:"toolRowCopy",tooltip:_SM.__language.GridBtn_Ttip_Copy_Row,type:"rowCopy",hidden:b,width:20,scope:this,handler:this.onEditAction}];this.myGrid.addTools(a);this.setEditMode(c)},setToolMode:function(a,c){var b=this.myGrid._extGrid;if(c){b.down(a).show()}else{b.down(a).hide()}},setEditMode:function(g){var f=this,d,a,e,b,c;b=_SM._UserInfo.perms[this.myMeta.viewCode];c=f.myGrid._extGrid;this.myGrid.editable=g;if(!(b.add||b.change||b["delete"])){d=false}else{d=g&&f.myGrid.selected;if(d){a=f.myGrid.selected;e=a.get("_ptStatus");d=!(e&&e===_SM._ROW_ST.REFONLY)}}this.setEditToolBar(g,d,b)},setEditToolBar:function(d,b,a){var c=this;c.setToolMode("#toolRowCopy",d&&a.add);c.setToolMode("#toolFormAdd",d&&a.add);c.setToolMode("#toolFormUpd",b&&a.change);c.setToolMode("#toolRowDel",b&&a["delete"])},onEditAction:function(d,f,b,a){if(!this.formController){this.formController=Ext.create("ProtoUL.UI.FormController",{myMeta:this.myMeta})}this.myGrid.fireStartEdition(a.itemId);switch(a.itemId){case"toolFormAdd":this.formController.openNewForm(this.myGrid.store);break;case"toolFormUpd":if(_SM.validaSelected(this.myGrid.selected)){this.formController.openLinkedForm(this.myGrid.selected)}break;case"toolFormView":if(_SM.validaSelected(this.myGrid.selected)){this.formController.openLinkedForm(this.myGrid.selected,true)}break;case"toolRowCopy":this.myGrid.duplicateRecord();break;case"toolRowDel":var c=this;function e(g){if(g==="yes"){c.myGrid.deleteCurrentRecord()}}Ext.MessageBox.confirm(_SM.__language.Title_Msg_Confirm_Delete,_SM.__language.Msg_Confirm_Delete_Operation,e);break}}});_SM.validaSelected=function(a){if(!a){_SM.errorMessage(_SM.__language.Title_Form_Panel,_SM.__language.GridAction_NoRecord);return false}return true};Ext.define("ProtoUL.UI.GridSheetController",{extend:"Ext.Base",myGrid:null,constructor:function(a){Ext.apply(this,a||{})},getSheetConfig:function(){var c=this.myGrid,d=c.myMeta,a,e;var b=true;for(a in d.sheetConfig){e=d.sheetConfig[a].sheetType;if(e=="gridOnly"){continue}b=false;break}if(b){d.gridConfig.hideSheet=true}if(!(c.initialConfig.hideSheet||d.gridConfig.hideSheet)){c.IdeSheet=Ext.id();this.pSheetsProps={};return{region:"east",id:c.IdeSheet,collapsible:true,collapsed:true,split:true,flex:1,layout:"fit",minSize:50,autoScroll:true,border:false}}},prepareSheet:function(){var l=this.myGrid,b=l.myMeta;if(l.initialConfig.hideSheet||b.gridConfig.hideSheet){return}if(!l.rowData){g("","");return}var d=b.sheetConfig,n=b.sheetSelector||"",j=l.rowData[n],m=undefined,c;for(c in d){if(d[c].sheetType=="printerOnly"){continue}m=d[c];if(m.name==j){break}}if(m===undefined){return}var a=m.template||"";var f=this.pSheetsProps[m.name];if(!f){f=[];for(c in b.fields){var h=b.fields[c].name;if(a.indexOf("{{"+h+"}}")>-1){f.push(h)}}this.pSheetsProps[m.name]=f}for(c in f){var e=f[c];var k="{{"+e+"}}";var o=l.rowData[e];if(e=="metaDefinition"){o=_SM.FormatJsonStr(o)}a=a.split(k).join(o)}g(m.title,a);function g(r,q){var p=Ext.getCmp(l.IdeSheet);p.setTitle(r);p.update(a);l.sheetHtml=a}}});Ext.define("ProtoUL.UI.MDActionsController",{extend:"Ext.Base",myMeta:null,constructor:function(a){Ext.apply(this,a||{});this.getProtoActionsBar()},getProtoActionsBar:function(){var b=_SM._UserInfo.perms[this.myMeta.viewCode];if(!(b.add||b.change||b["delete"])){return}var f=this,e=[],d=this.__MasterDetail;if(this.myMeta.WFlowActions){for(var a in this.myMeta.WFlowActions){var g=this.myMeta.WFlowActions[a];g.menuText=g.menuText||g.name;g.actionType="wflow";g.selectionMode="multiple";g.refreshOnComplete=true;if(g.admMessagePropmt){g.actionParams=[{name:"admMessage",tooltip:g.description,fieldLabel:g.admMessagePropmt,type:"string",required:true}]}else{g.actionParams=[]}e.push(new Ext.Action({text:g.menuText,actionName:g.name,iconCls:g.viewIcon,tooltip:g.description,actionDef:g,scope:f,handler:c}))}}for(var a in this.myMeta.actions){var g=this.myMeta.actions[a];g.menuText=g.menuText||g.name;e.push(new Ext.Action({text:g.menuText,actionName:g.name,iconCls:g.viewIcon,tooltip:g.description,actionDef:g,scope:f,handler:c}))}if(e.length>0){d.tbProtoActions=Ext.create("Ext.toolbar.Toolbar",{dock:"top",hidden:true,enableOverflow:true,items:[{xtype:"tbtext",text:"<strong>Actions : </strong>"}]});d.tbProtoActions.add(e);d.myProtoActions=e;d.protoMasterGrid.addDocked(d.tbProtoActions)}function c(l){var j=d.protoMasterGrid;var m=j.getSelectedIds();var k=l.actionDef;if((k.selectionMode=="single")&&(m.length!=1)){_SM.__StBar.showMessage("TITLE_ACTION_SELECTION_SINLGLE",l.actionName,3000);return}else{if((k.selectionMode=="multiple")&&(m.length<1)){_SM.__StBar.showMessage("TITLE_ACTION_SELECTION_MULTI",l.actionName,3000);return}}k.actionParams=_SM.verifyList(k.actionParams);if(k.actionParams.length==0){this.doAction(f,j.viewCode,l.actionDef,m,[])}else{var h={scope:f,acceptFn:function(o){this.doAction(f,j.viewCode,l.actionDef,m,o)}};var n=Ext.create("ProtoUL.ux.parameterWin",{parameters:k.actionParams,title:l.actionName+" - "+j.rowData.__str__,options:h});n.show()}}},doAction:function(d,a,f,e,c){var b={scope:d,success:function(g,j){var h=Ext.decode(g.responseText);_SM.__StBar.showMessage(f.name+" "+h.message,"MDActionsController",3000);if(h.success&&f.refreshOnComplete){this.__MasterDetail.mdGridReload()}if(h.fileName){_SM.getFile(h.fileName,true)}},failure:function(g,h){_SM.__StBar.showError(f.name+" "+g.statusText,"MDActionsController")}};_SM.__StBar.showMessage("executing  "+f.name+"...","MDActionsController");_SM.doProtoActions(a,f.name,e,c,f,b)}});Ext.define("ProtoUL.UI.MDDetailsController",{extend:"Ext.Base",myMeta:null,constructor:function(a){Ext.apply(this,a||{});this.getDetailsTBar()},getDetailsTBar:function(){var h=this,d=h.__MasterDetail,a=[];for(var k in d.myMeta.detailsConfig){var e=d.myMeta.detailsConfig[k];if(e.menuText===undefined){continue}var f=new Ext.Action({text:e.menuText,hidden:true,scope:h,handler:b,detailKey:e.conceptDetail,detailDefinition:e});a.push(f);j(f.initialConfig,f)}if(a.length>0){d.tbDetails=Ext.create("Ext.toolbar.Toolbar",{dock:"bottom",border:true,enableOverflow:true,items:[{text:"<strong>"+_SM.__language.Grid_Detail_Title+"</strong>",iconCls:"icon-panelDown",enableToggle:false,scope:d,handler:d.hideDetailPanel}]});d.myDetails=a;d.tbDetails.add(a);d.protoMasterGrid.addDocked(d.tbDetails,0)}function j(m,n){var l={scope:h,success:function(q,o,p){c(m,n)},failure:function(q,o,p){g(m,n)}};if(_SM.loadPci(m.detailDefinition.conceptDetail,true,l)){c(m,n)}}function g(l,m){d.protoTabs.add({html:_SM.__language.Grid_Detail_Error+" :"+l.detailKey,ixDetail:d.protoTabs.items.length})}function c(n,q){function m(t,r,s){q.initialConfig[t]=s;q.callEach(r,[s])}var l=n.detailDefinition;var p=Ext.create("ProtoUL.view.ProtoGrid",{border:false,viewCode:l.conceptDetail,protoIsDetailGrid:true,detailDefinition:l,autoLoad:false,isDetail:true,_MasterDetail:d});p.store.detailDefinition=l;n.ixDetail=d.protoTabs.items.length;d.protoTabs.add(p);p.ixDetail=n.ixDetail;d.cllStoreDet[n.ixDetail]=p.store;var o=p.myMeta;m("tooltip","setTooltip",l.menuText);m("iconCls","setIconCls",o.viewIcon);m("width","setWidth",100);q.show()}function b(l){d.ixActiveDetail=l.initialConfig.ixDetail;d.protoTabs.getLayout().setActiveItem(d.ixActiveDetail);d.linkDetail();d.showDetailPanel();if(l.hasOwnProperty("toggle")){l.toggle(true)}}}});Ext.define("ProtoUL.UI.MDPrintOptsController",{extend:"Ext.Base",myMeta:null,constructor:function(a){Ext.apply(this,a||{});this.getPrinterOptsBar()},getPrinterOptsBar:function(){var g=this;var d=[];var k=this.__MasterDetail;if(this.myMeta.gridConfig.exportCsv){d.push(new Ext.Action({text:_SM.__language.Grid_ExportCSV,iconCls:"icon-printGrid",tooltip:_SM.__language.Grid_ExportCSV_Ttip,scope:g,handler:e}))}if(!this.myMeta.gridConfig.denyAutoPrint){d.push(new Ext.Action({text:_SM.__language.Text_Grid,iconCls:"icon-printGrid",scope:g,handler:b}));if(k.protoMasterGrid.IdeSheet!=undefined){d.push(new Ext.Action({text:"Fiche",iconCls:"icon-printSheet",scope:g,handler:h}))}}if(this.myMeta.sheetConfig.length>0){for(var c in this.myMeta.sheetConfig){var a=this.myMeta.sheetConfig[c];if(a.sheetStyle=="gridOnly"){continue}d.push(new Ext.Action({text:a.name,sheetName:a.name,iconCls:a.viewIcon||"icon-printSheet",tooltip:a.title,scope:g,handler:j}))}}if(d.length>0){k.tbPrinterOpts=Ext.create("Ext.toolbar.Toolbar",{dock:"top",hidden:true,enableOverflow:true,items:[{xtype:"tbtext",text:"<strong>"+_SM.__language.Text_Print+"</strong>"}]});k.tbPrinterOpts.add(d);k.myPrinterOpts=d;k.protoMasterGrid.addDocked(k.tbPrinterOpts)}function f(l){}function b(l){var m=ProtoUL.ux.Printer;m.gridPrint(k.protoMasterGrid._extGrid)}function h(m){var n=ProtoUL.ux.Printer,l=k.protoMasterGrid;if((!l)||(!l.sheetHtml)){_SM.__StBar.showWarning(_SM.__language.GridAction_NoRecord,"MdPrintOptsController");return}g.openHtmlWin(l.sheetHtml)}function j(n){var q=ProtoUL.ux.Printer,l=k.protoMasterGrid;var p=window.open("","printgrid");var o=l.getSelectedIds();var m={scope:g,success:function(r,s){q.reportPrint(p,r.responseText)}};_SM.getSheeReport(l.viewCode,n.sheetName,o,m)}function e(m){var l=k.protoMasterGrid;Ext.Ajax.request({method:"POST",url:_SM._PConfig.urlGetProtoCsv,params:l.store.proxy.extraParams,success:function(n,p){var o=Ext.decode(n.responseText);_SM.getFile(o.message,false)},failure:function(n,o){_SM.errorMessage(_SM.__language.Grid_ExportCSV_Err,n.status+" "+n.statusText)},scope:this,timeout:60000})}},openHtmlWin:function(b){var a=window.open("","printgrid");a.document.write(b);if(this.printAutomatically){a.print()}}});_SM.getFile=function(b,a){var c="getFile/"+b;if(a){window.open(c)}else{window.location=c}};Ext.define("ProtoUL.UI.MDSetFiltersController",{extend:"Ext.Base",myMeta:null,constructor:function(a){Ext.apply(this,a||{});this.getCustomOptsBar()},getCustomOptsBar:function(){var d=[],b,g,a,f,e=this.__MasterDetail,c=this.myMeta.gridSets.filtersSet.concat(this.myMeta.custom.filtersSet);if((c.length===0)&&this.myMeta.gridConfig.filterSetABC){for(b in _SM.objConv(["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"])){a={};a.property=this.myMeta.gridConfig.filterSetABC;a.filterStmt="^"+b;c.push({name:b,filter:[a]})}c.push({name:" *",filter:{}})}for(g in c){f=c[g];d.push(new Ext.Action({name:f.name,text:f.menuText||f.name,iconCls:f.icon,maxWidth:100,protoFilter:f.customFilter,scope:this,handler:h}))}if(d.length>0){e.tbFilters=Ext.create("Ext.toolbar.Toolbar",{dock:"top",hidden:true,enableOverflow:true,items:[{xtype:"tbtext",text:"<strong>Filtrer par : </strong>"}]});e.tbFilters.add(d);e.myFilters=d;e.protoMasterGrid.addDocked(e.tbFilters)}function h(j){e.protoMasterGrid.filterTitle=' " '+j.text+' "';e.protoMasterGrid.setGridTitle(e.protoMasterGrid);e.mdGridLoadData(j.protoFilter)}}});Ext.define("ProtoUL.UI.MDSetSortersController",{extend:"Ext.Base",myMeta:null,constructor:function(a){Ext.apply(this,a||{});this.getCustomOptsBar()},getCustomOptsBar:function(){var a=[],c=this.__MasterDetail,b=this.myMeta.gridSets.sortersSet.concat(this.myMeta.custom.sortersSet);if(this.myMeta.gridConfig.initialSort&&(b.length>0)){e([{name:"Initial",icon:"soterIcon",customSort:this.myMeta.gridConfig.initialSort}]);e(b)}if(a.length>0){c.tbSortersSet=Ext.create("Ext.toolbar.Toolbar",{dock:"top",hidden:true,enableOverflow:true,items:[{xtype:"tbtext",text:"<strong>Sorters : </strong>"}]});c.tbSortersSet.add(a);c.mySortersSet=a;c.protoMasterGrid.addDocked(c.tbSortersSet)}function d(f){c.protoMasterStore.sort(f.sorter)}function e(f){var h;for(var g in f){h=f[g];a.push(new Ext.Action({maxWidth:100,text:h.name,iconCls:h.icon,sorter:h.customSort,scope:this,handler:d}))}}}});Ext.define("ProtoUL.UI.MDSetTabsController",{extend:"Ext.Base",myMeta:null,constructor:function(a){Ext.apply(this,a||{});this.getCustomOptsBar()},getCustomOptsBar:function(){var c=[],d=this.__MasterDetail,a=this.myMeta.gridSets.listDisplaySet.concat(this.myMeta.custom.listDisplaySet);if(a.length>0){var f=_SM.defineTabConfig(this.myMeta.gridConfig);e([f]);e(a)}if(c.length>0){d.tbTabs=Ext.create("Ext.toolbar.Toolbar",{dock:"top",hidden:true,enableOverflow:true,items:[{xtype:"tbtext",text:"<strong>Tabs : </strong>"}]});d.tbTabs.add(c);d.myTabs=c;d.protoMasterGrid.addDocked(d.tbTabs)}function b(g){d.protoMasterGrid.configureColumns(g.tabConfig)}function e(h){var g;for(var k in h){g=h[k];var j={name:g.name,listDisplay:g.listDisplay,hideRowNumbers:g.hideRowNumbers||false};c.push(new Ext.Action({text:g.name,iconCls:g.icon,maxWidth:100,tabConfig:j,scope:this,handler:b}))}}}});_SM.defineTabConfig=function(a){return{name:"Default",icon:"colSetIcon",listDisplay:a.listDisplay,hideRowNumbers:a.hideRowNumbers||false}};Ext.define("ProtoUL.UI.MDTbSortByController",{extend:"Ext.Base",myMeta:null,constructor:function(a){Ext.apply(this,a||{});this.getSortersBar()},getSortersBar:function(){var l=this,f=[],n=l.__MasterDetail;l.myFieldDict=n.protoMasterGrid.myFieldDict;for(var e in l.myMeta.gridConfig.sortFields){var b=l.myMeta.gridConfig.sortFields[e];var k=l.myFieldDict[b];if(!k){k={name:b,header:b}}f.push({name:k.name,header:k.header})}if(f.length>0){var a=Ext.create("Ext.ux.BoxReorderer",{listeners:{scope:l,Drop:function(p,q,o){j(o,false)}}});n.tbSorters=Ext.create("Ext.toolbar.Toolbar",{dock:"top",hidden:true,items:[{iconCls:"sort",xtype:"tbtext",text:"<strong>"+_SM.__language.Grid_Sort_Title+"</strong>",reorderable:false}],plugins:[a]});for(var e in f){var k=f[e];var d=l.myFieldDict[b];if(!d){continue}n.tbSorters.add(h({text:k.header,tooltip:k.header,maxWidth:100,sortData:{property:k.name,direction:"ASC"}}))}n.protoMasterGrid.addDocked(n.tbSorters);this.mySortCols=f}function h(c){c=c||{};Ext.applyIf(c,{listeners:{click:function(o,p){j(o,true)}},iconCls:"sort-"+c.sortData.direction.toLowerCase(),reorderable:true,xtype:"button"});return c}function j(q,o){var c=q.sortData,p=q.iconCls;if(c){if(o!==false){q.sortData.direction=Ext.String.toggle(q.sortData.direction,"ASC","DESC");q.setIconCls(Ext.String.toggle(p,"sort-asc","sort-desc"))}m()}}function m(){n.protoMasterStore.myLoadData(null,g())}function g(){var c=[];Ext.each(n.tbSorters.query("button"),function(o){c.push(o.sortData)},l);return c.slice(0,3)}}});Ext.define("ProtoUL.UI.TbMasterDetail",{extend:"Ext.Toolbar",alias:"widget.tbMasterDetail",autoEdit:true,initComponent:function(){var d=this;var e=this.protoMeta;var c=this.__MasterDetail;this.searchBG=Ext.create("ProtoUL.ux.ProtoSearchBG",{myMeta:e});Ext.apply(this,{dock:"top",defaults:{scope:d},items:[this.searchBG,{iconCls:"icon-edit",itemId:"edit",tooltip:_SM.__language.Grid_Edit_Ttip,text:_SM.__language.Grid_Edit_Title,hidden:true,handler:b},{text:_SM.__language.Text_Clasify_Button,tooltip:_SM.__language.Tooltip_Clasify_Button,iconCls:"icon-order",itemId:"sorters",hidden:true,enableToggle:true,handler:a},{xtype:"splitbutton",text:_SM.__language.Text_Actions_Button,tooltip:_SM.__language.Tooltip_Actions_Button,iconCls:"icon-action",itemId:"protoActions",hidden:true,enableToggle:true,handler:a,menu:Ext.create("Ext.menu.Menu",{})},{xtype:"splitbutton",text:_SM.__language.Grid_Detail_Title,tooltip:_SM.__language.Tooltip_Details_Button,iconCls:"icon-details",itemId:"details",hidden:true,enableToggle:true,handler:a,menu:Ext.create("Ext.menu.Menu",{})},{xtype:"splitbutton",text:_SM.__language.Text_Filters_Button,tooltip:_SM.__language.Tooltip_Filters_Button,iconCls:"icon-filters",itemId:"filterSet",hidden:true,enableToggle:true,handler:a,menu:Ext.create("Ext.menu.Menu",{})},{xtype:"splitbutton",text:_SM.__language.Text_Tabs_Button,tooltip:_SM.__language.Tooltip_Tabs_Button,iconCls:"icon-tabs",itemId:"tabSet",hidden:true,enableToggle:true,handler:a,menu:Ext.create("Ext.menu.Menu",{})},{xtype:"splitbutton",text:_SM.__language.Text_Sorters_Button,tooltip:_SM.__language.Tooltip_Sorters_Button,iconCls:"icon-sorters",itemId:"sorterSet",hidden:true,enableToggle:true,handler:a,menu:Ext.create("Ext.menu.Menu",{})},{xtype:"splitbutton",text:_SM.__language.Text_Print,tooltip:_SM.__language.Tooltip_Printing_Options,iconCls:"icon-print",itemId:"printerOpts",hidden:true,enableToggle:true,handler:a,menu:Ext.create("Ext.menu.Menu",{})},{xtype:"splitbutton",text:_SM.__language.Text_Config,tooltip:_SM.__language.Tooltip_Config_Button,iconCls:"icon-config",itemId:"configOpts",hidden:true,enableToggle:true,handler:a,menu:Ext.create("Ext.menu.Menu",{})},"->",{iconCls:"icon-editoff",itemId:"editOff",text:_SM.__language.Text_Exit_Edit_Mode_Button,tooltip:_SM.__language.Tooltip_Exit_Edit_Mode_Button,hidden:true,handler:b},{xtype:"splitbutton",iconCls:"icon-help",handler:a,itemId:"tbHelp"}]});this.callParent();d.perms=_SM._UserInfo.perms[this.protoMeta.viewCode];this.setEditMode(this.autoEdit);if(!d.autoEdit&&(d.perms.add||d.perms.change||d.perms["delete"])){this.getComponent("edit").setVisible(true)}this.searchBG.on({qbeLoadData:{fn:function(j,g,f,h){c.mdGridLoadData(g,h);c.protoMasterGrid.filterTitle=f;c.protoMasterGrid.setGridTitle(c.protoMasterGrid)},scope:this}});function a(f){if(f.itemId=="sorters"){if(c.tbSorters){c.tbSorters.setVisible(f.pressed)}}else{if(f.itemId=="filterSet"){if(c.tbFilters){c.tbFilters.setVisible(f.pressed)}}else{if(f.itemId=="tabSet"){if(c.tbTabs){c.tbTabs.setVisible(f.pressed)}}else{if(f.itemId=="sorterSet"){if(c.tbSortersSet){c.tbSortersSet.setVisible(f.pressed)}}else{if(f.itemId=="printerOpts"){if(c.tbPrinterOpts){c.tbPrinterOpts.setVisible(f.pressed)}}else{if(f.itemId=="configOpts"){if(c.tbConfigOpts){c.tbConfigOpts.setVisible(f.pressed)}}else{if(f.itemId=="details"){if(c.tbDetails){c.showDetailPanel(!f.pressed)}}else{if(f.itemId=="protoActions"){if(c.tbProtoActions){c.tbProtoActions.setVisible(f.pressed)}}else{if(f.itemId=="tbHelp"){window.open(_SM._HELPpath,"protoHelp","left=50,top=20,width=1000,height=600,resizable=0,scrollbars=yes")}}}}}}}}}}function b(f){if(f.itemId=="edit"){d.setEditMode(true)}else{if(f.itemId=="editOff"){d.setEditMode(false)}}}},setAutoSync:function(a){},setEditMode:function(d){var c=this;if(!(c.perms.add||c.perms.change||c.perms["delete"])){return}Ext.suspendLayouts();if(!this.autoEdit){this.getComponent("edit").setVisible(!d);this.getComponent("editOff").setVisible(d);this.searchBG.setVisible(!d);b(this,"printerOpts",d);b(this,"configOpts",d);b(this,"sorters",d);b(this,"filterSet",d);b(this,"protoActions",d);b(this,"sorterSet",d)}var a=this.__MasterDetail.autoSync;this.__MasterDetail.setEditMode(d);function b(g,f,h){var e=g.getComponent(f);e.setVisible((!h)&&(e.protoEnable))}Ext.resumeLayouts(true)},addActions:function(){if(this.__MasterDetail.myDetails){var a=this.getComponent("details");a.menu.add(this.__MasterDetail.myDetails);a.protoEnable=true;a.show()}if(this.__MasterDetail.myFilters){var a=this.getComponent("filterSet");a.menu.add(this.__MasterDetail.myFilters);a.protoEnable=true;a.show()}if(this.__MasterDetail.myPrinterOpts){var a=this.getComponent("printerOpts");a.menu.add(this.__MasterDetail.myPrinterOpts);a.protoEnable=true;a.show()}if(this.__MasterDetail.myConfigOpts){var a=this.getComponent("configOpts");a.menu.add(this.__MasterDetail.myConfigOpts);a.protoEnable=true;a.show()}if(this.__MasterDetail.myProtoActions){var a=this.getComponent("protoActions");a.menu.add(this.__MasterDetail.myProtoActions);a.protoEnable=true;a.show()}if(this.__MasterDetail.tbSorters){var a=this.getComponent("sorters");a.protoEnable=true;a.show()}if(this.__MasterDetail.myTabs){var a=this.getComponent("tabSet");a.menu.add(this.__MasterDetail.myTabs);a.protoEnable=true;a.show()}if(this.__MasterDetail.mySortersSet){var a=this.getComponent("sorterSet");a.menu.add(this.__MasterDetail.mySortersSet);a.protoEnable=true;a.show()}}});Ext.define("ProtoUL.proto.ProtoDesigner",{extend:"Ext.container.Container",alias:"widget.protoDesigner",myMeta:null,initComponent:function(){var a=this;Ext.apply(this,{layout:"border",defaults:{lauyout:"fit"},items:this.getPanelItems()});a.callParent(arguments);myObj=_SM.DesignerPanels;this.doFormatLayout(myObj);this.updateFormTree()},updateFormTree:function(){var a=Meta2Tree(this.myMeta.formConfig,"formConfig","formConfig");a.expanded=true;this.formTree.getStore().setRootNode(a)},onClickRedraw:function(c){this.formPreview.removeAll(true);var b=Tree2Meta(this.formTree.store.getRootNode());this.myMeta.formConfig=b;this.formController.myMeta.formConfig=b;var a=this.formController.newProtoForm();a.setFormReadOnly(true);this.formPreview.add(a)},doFormatLayout:function(a){var s=this;this.toolsPanel=s.down("#toolsPanel");this.toolsTabs=s.down("#toolsTabs");this.formTree=s.down("#formTree");this.formPreview=s.down("#formPreview");this.formController=Ext.create("ProtoUL.UI.FormController",{myMeta:s.myMeta});var e=this.formController.newProtoForm();function g(w,v){for(var t in w){var u=w[t];if(u.text==v){return u}}return{}}e.setFormReadOnly(true);this.formPreview.add(e);this.tBar=this.toolsPanel.addDocked({xtype:"toolbar",dock:"top",items:a.tbar})[0];this.toolsTabs.add(a.toolsTabs);this.toolsTree=this.toolsTabs.down("#toolsTree");var o=Ext.create("ProtoUL.ux.ProtoProperty",{});this.properties=this.toolsTabs.down("#properties");this.properties.add(o);this.properties=o;o.on({edit:function(u,w,t){if(w.value==w.originalValue){return}var x=s.treeRecord.data.__ptConfig;var v=w.record.data.name;if(_SM.typeOf(x)=="object"){x[v]=w.value}s.onClickRedraw()},scope:s});_SM.defineProtoPclTreeModel();var r=_SM.clone(a.toolsTree),c,k,f,b,q;c=g(r,"Fields");for(b in this.myMeta.fields){q=this.myMeta.fields[b];f=_SM.getFormFieldDefinition(q);f.name=q.name;k={text:q.name,qtip:q.cellToolTip,__ptType:"formField",leaf:true,__ptConfig:f};c.children.push(k)}c=g(r,"Details");for(b in this.myMeta.detailsConfig){q=this.myMeta.detailsConfig[b];k={text:q.menuText,qtip:q.toolTip,__ptType:"protoGrid",leaf:true,__ptConfig:{menuText:q.menuText,viewCode:q.conceptDetail,xtype:"protoGrid",__ptType:"protoGrid"}};c.children.push(k)}var n=Ext.create("Ext.data.TreeStore",{model:"Proto.PclTreeNode",root:{expanded:true,children:r}});var m=Ext.create("Ext.tree.Panel",{layout:"fit",itemId:"baseTree",store:n,rootVisible:false,viewConfig:{plugins:{ptype:"treeviewdragdrop",enableDrop:false}}});this.toolsTree.add(m);this.toolsTree=m;var n=Ext.create("Ext.data.TreeStore",{model:"Proto.PclTreeNode",root:{expanded:true,text:_SM.__language.Title_Main_Panel,children:[]}});var d=Ext.create("Ext.tree.Panel",{layout:"fit",store:n,autoScroll:true,rootVisible:true,viewConfig:{plugins:{ptype:"treeviewdragdrop"}}});this.formTree.add(d);this.formTree=d;var h=this.formTree.getView();this.formTreeViewId=h.id;h.on({beforedrop:{fn:function(v,y,C,D,u,A){if(y.view.id!=this.formTreeViewId){var x=y.records[0];var w=x.get("text");if(w in _SM.objConv(["Fields","Containers","Grids"])){return false}if(w in _SM.objConv(["htmlset","fieldset"])){var B=C.store.getById(C.data.parentId);var t=C.data.index;if(!B){B=C}if(D=="after"){t+=1}u.cancelDrop();var z=getNodeBase(w,w,{__ptType:w});B.insertChild(t,z)}y.copy=true}}},drop:{fn:function(){this.onClickRedraw()}},scope:this});this.formTree.on({select:function(w,t,v,u){s.treeRecord=t;prepareProperties(t,s.myMeta,s.properties)},scope:s});var p=this.tBar.down("#redraw");p.on("click",function(u,v,t){this.onClickRedraw()},s);var l=this.tBar.down("#save");l.on("click",function(u,v,t){var w=Tree2Meta(this.formTree.store.getRootNode());this.myMeta.formConfig=w;_SM.savePclCache(this.myMeta.viewCode,this.myMeta,true);_SM.savePci(this.myMeta)},s);var j=this.tBar.down("#delete");j.on("click",function(u,v,t){s.treeRecord.remove()},s)},getPanelItems:function(){return[{region:"center",layout:"fit",itemId:"formPreview",flex:2,minSize:200},{region:"west",collapsible:true,split:true,flex:1,title:_SM.__language.Title_Form_Panel,itemId:"toolsPanel",layout:"border",defaults:{lauyout:"fit"},items:[{region:"center",layout:"fit",itemId:"formTree",autoScroll:true,minHeight:150},{region:"south",layout:"fit",itemId:"toolsTabs",collapsible:true,split:true,flex:1,title:_SM.__language.Title_Panel_Tools}]}]}});Ext.define("ProtoUL.proto.ProtoDetailSelector",{extend:"Ext.panel.Panel",alias:"widget.detailsSelector",viewCode:null,myMeta:null,initComponent:function(){var f=this;var e=Ext.create("ProtoUL.proto.ProtoToolBar",{dock:"top"});var c=Ext.create("ProtoUL.proto.ProtoDetailTree",{viewCode:f.viewCode,myMeta:f.myMeta});var a=Ext.create("ProtoUL.ux.ProtoList",{checkStyle:false,idTitle:"SelectedDetails"});c.on({loadComplete:function(k,h,l,j){b()},checkModif:function(l,k,j){var h=l.get("id");a.addOrRemove(h,k)},scope:f});e.on({preview:function(){g()},save:function(){g();_SM.savePclCache(f.myMeta.viewCode,f.myMeta,true);_SM.savePci(f.myMeta)},scope:f});var d=getSelectorsPanels(c,a);Ext.apply(this,{layout:"border",items:d,dockedItems:[e]});this.callParent(arguments);function b(){for(var h in f.myMeta.detailsConfig){var j=f.myMeta.detailsConfig[h];a.addDataItem(j.menuText,true)}}function g(){var m=a.getList(),k={},j=[];for(var h in m){k=n(m[h]);if(!k){k=l(m[h])}if(k){j.push(k)}else{}}f.myMeta.detailsConfig=j;function n(p){for(var o in f.myMeta.detailsConfig){var q=f.myMeta.detailsConfig[o];if(q.menuText==p){return q;break}}}function l(o){var p=c.treeStore.getNodeById(o);return{menuText:p.get("id"),conceptDetail:p.get("conceptDetail"),masterField:"pk",detailField:p.get("detailField")}}}}});Ext.define("ProtoUL.proto.ProtoDetailTree",{extend:"Ext.tree.Panel",alias:"widget.detailDefTree",viewCode:null,myMeta:null,initComponent:function(){var d=this;d.addEvents("checkModif","loadComplete");b(d.viewCode,d.myMeta.protoEntityId);this.treeStore=Ext.create("Ext.data.TreeStore",{autoLoad:true,model:"Proto.DetailsTreeModel",root:{text:_SM.__language.Grid_Detail_Title,expanded:true},listeners:{load:function(g,e,h,f){c();d.fireEvent("loadComplete",g,e,h,f)}}});var a=Ext.apply(this,{store:this.treeStore,useArrows:true,rootVisible:false,minWidth:400,columns:[{xtype:"treecolumn",text:_SM.__language.Tree_Concept_Details_Text,flex:2,sortable:true,minWidth:200,dataIndex:"id"},{text:_SM.__language.Tree_Concept_Details_Detail,dataIndex:"conceptDetail"},{flex:2,text:_SM.__language.Tree_Details_Field,dataIndex:"detailField"}]});a.on({checkchange:{fn:function(g,f,e){d.fireEvent("checkModif",g,f,e)}},scope:d});d.callParent(arguments);function c(){d.getRootNode().cascadeBy(function(g){var e={conceptDetail:g.get("conceptDetail"),detailField:g.get("detailField")};if(e.conceptDetail){for(var f in d.myMeta.detailsConfig){var h=d.myMeta.detailsConfig[f];if((h.conceptDetail==e.conceptDetail)&&(h.detailField==e.detailField)){g.set("checked",true);g.set("id",h.menuText);break}}}})}function b(e,f){Ext.define("Proto.DetailsTreeModel",{extend:"Ext.data.Model",proxy:{type:"ajax",url:_SM._PConfig.urlGetDetailsTree,actionMethods:{read:"POST"},extraParams:{viewCode:e,protoEntityId:f}},fields:[{name:"id",type:"string"},{name:"menuText",type:"string"},{name:"masterField",type:"string"},{name:"detailField",type:"string"},{name:"conceptDetail",type:"string"},{name:"checked",type:"boolean"},{name:"leaf",type:"boolean"}]})}}});Ext.define("ProtoUL.proto.ProtoFieldSelector",{extend:"Ext.panel.Panel",alias:"widget.protoFieldSelector",viewCode:null,myMeta:null,initComponent:function(){me=this;var d=Ext.create("ProtoUL.proto.ProtoToolBar",{dock:"top"});d.setButton("add",true,true,"add UDP");var b=Ext.create("ProtoUL.proto.ProtoFieldTree",{viewCode:me.viewCode,myMeta:me.myMeta});var a=Ext.create("ProtoUL.ux.ProtoList",{checkStyle:false,idTitle:"SelectedFields"});b.on({loadComplete:function(j,g,k,h){e()},checkModif:function(k,j,h){var g=k.get("id");a.addOrRemove(g,j)},scope:me});d.on({preview:function(){f()},save:function(){f();_SM.savePclCache(me.myMeta.viewCode,me.myMeta,true);_SM.savePci(me.myMeta)},add:function(){var g=_SM.__language.Msg_Window_New_Folder;Ext.Msg.prompt(_SM.__language.MetaConfig_Add_Fields,g,function(j,h){if(j!="ok"){return}b.addUdpField({name:h,checked:false})},me,false,"udp__")},scope:me});var c=getSelectorsPanels(b,a);Ext.apply(this,{layout:"border",items:c,dockedItems:[d]});this.callParent(arguments);function e(){for(var g in me.myMeta.fields){var j=me.myMeta.fields[g];a.addDataItem(j.name,true);var h=b.treeStore.getNodeById(j.name);if(h){h.set("checked",true)}else{j.checked=true;b.addUdpField(j)}}}function f(){var k=_SM.getFieldDict(me.myMeta),m=a.getList(),l={},g=[];for(var h in m){l=k[m[h]];if(!l){l=j(m[h])}if(l){g.push(_SM.clearProps(l))}}me.myMeta.fields=g;function j(n){var o=b.treeStore.getNodeById(n);return{name:o.get("id"),type:o.get("type"),readOnly:o.get("readOnly"),required:o.get("required"),tooltip:o.get("tooltip"),header:o.get("header"),cpFromZoom:o.get("cpFromZoom"),cpFromField:o.get("cpFromField"),zoomModel:o.get("zoomModel"),fkField:o.get("fkField"),fkId:o.get("fkId"),vType:o.get("vType"),prpDefault:o.get("prpDefault"),choices:o.get("choices")}}}}});Ext.define("ProtoUL.proto.ProtoFieldTree",{extend:"Ext.tree.Panel",alias:"widget.protoFieldTree",viewCode:null,myMeta:null,initComponent:function(){me=this;me.addEvents("checkModif","loadComplete");b(me.viewCode,me.myMeta.protoEntityId);this.treeStore=Ext.create("Ext.data.TreeStore",{autoLoad:true,folderSort:false,sorters:[{property:"text",direction:"ASC"}],model:"Proto.FieldSelectionModel",root:{text:_SM.__language.Protofield_Fields,expanded:true},listeners:{load:function(e,c,f,d){me.fireEvent("loadComplete",e,c,f,d)}}});var a=Ext.apply(this,{store:this.treeStore,useArrows:true,rootVisible:false,minWidth:400,columns:[{xtype:"treecolumn",text:_SM.__language.Protofield_Text,flex:2,sortable:true,minWidth:200,dataIndex:"text"},{xtype:"booleancolumn",trueText:"req",falseText:"",width:50,text:_SM.__language.Protofield_Req,dataIndex:"required"},{xtype:"booleancolumn",trueText:"rOnly",width:50,falseText:"",text:_SM.__language.Protofield_ROnly,dataIndex:"readOnly"},{text:_SM.__language.Protofield_Field_Type,dataIndex:"type"},{text:_SM.__language.Protofield_Zoom_Model,dataIndex:"zoomModel"},{text:_SM.__language.Protofield_fk_Field,dataIndex:"fkField"},{text:_SM.__language.Protofield_fk_Id,dataIndex:"fkId"},{flex:2,text:_SM.__language.Protofield_Ix,dataIndex:"id"},{flex:2,text:"cpFromZoom",dataIndex:"cpFromZoom"},{flex:2,text:"cpFromField",dataIndex:"cpFromField"},{hidden:true,text:_SM.__language.Protofield_Header,dataIndex:"header"},{hidden:true,text:_SM.__language.Protofield_Tooltip,dataIndex:"tooltip"},{hidden:true,text:_SM.__language.Protofield_Default_Value,dataIndex:"prpDefault"},{hidden:true,text:_SM.__language.Protofield_vType,dataIndex:"vType"},{hidden:true,text:_SM.__language.Protofield_choices,dataIndex:"choices"}]});a.on({checkchange:{fn:function(e,d,c){me.fireEvent("checkModif",e,d,c)}},scope:me});me.callParent(arguments);function b(c,d){Ext.define("Proto.FieldSelectionModel",{extend:"Ext.data.Model",proxy:{type:"ajax",url:_SM._PConfig.urlGetFieldTree,actionMethods:{read:"POST"},extraParams:{viewCode:c,protoEntityId:d}},fields:[{name:"id",type:"string"},{name:"text",type:"string"},{name:"type",type:"string"},{name:"readOnly",type:"boolean"},{name:"required",type:"boolean"},{name:"tooltip",type:"string"},{name:"header",type:"string"},{name:"zoomModel",type:"string"},{name:"fkField",type:"string"},{name:"fkId",type:"string"},{name:"vType",type:"string"},{name:"prpDefault",type:"string"},{name:"choices",type:"string"},{name:"cpFromZoom",type:"string"},{name:"cpFromField",type:"string"},{name:"checked",type:"boolean"},{name:"leaf",type:"boolean"}]})}},addUdpField:function(a){tNode={id:a.name,text:a.name,type:"udp",checked:a.checked,required:false,leaf:true};this.getRootNode().appendChild(tNode)}});Ext.define("ProtoUL.proto.ProtoPcl",{extend:"Ext.panel.Panel",alias:"widget.protoPcl",myMeta:null,myFieldDict:null,editable:true,initComponent:function(){var r=this;if(!this.myMeta){_SM.__StBar.showError("not loaded???","protoPcl.init");return}this.myFieldDict=_SM.getFieldDict(this.myMeta);_SM.defineProtoPclTreeModel();var e=Ext.create("ProtoUL.proto.ProtoToolBar",{dock:"top"});var p=Ext.create("Ext.form.Label",{text:_SM.__language.ProtoPcl_Edition_Tool});var q=o(r);var t=Ext.create("Ext.data.TreeStore",{model:"Proto.PclTreeNode",root:q});this.treeGridStore=t;var u=Ext.create("Ext.tree.Panel",{store:t,sortableColumns:false,useArrows:true,rootVisible:true,multiSelect:false,singleExpand:true,stripeRows:true,rowLines:true,columns:[{xtype:"treecolumn",text:"text",flex:3,dataIndex:"text"},{text:"__ptType",dataIndex:"__ptType"}],listeners:{itemmouseenter:function(x,w,y){Ext.fly(y).set({"data-qtip":m(w.data.text),"data-qtitle":w.data.text})},scope:r}});this.treeGrid=u;var h=Ext.create("ProtoUL.ux.ProtoProperty",{source:{name:""}});var v=Ext.create("ProtoUL.ux.ProtoList",{idTitle:"SelectedFields"});var k=Ext.create("Ext.form.TextArea",{autoScroll:true,labelAlign:"top"});var s=[{region:"center",flex:3,layout:"fit",minSize:50,items:u,border:false},{region:"east",collapsible:false,split:true,flex:2,layout:"fit",minSize:200,items:[h,v,k],border:false}];Ext.apply(this,{layout:"border",items:s,dockedItems:[e],bbar:[p]});this.callParent(arguments);v.hide();k.hide();e.on({preview:function(){r.myMeta=Tree2Meta(r.treeGridStore.getRootNode());_SM.savePclCache(r.myMeta.viewCode,r.myMeta,true)},save:function(){var w=Tree2Meta(r.treeGridStore.getRootNode());if(r.custom){if(r.metaConfig){r.myMeta.gridConfig.listDisplay=w.listDisplay;delete w.listDisplay;r.myMeta.gridSets=w}else{r.myMeta.custom=w}}else{w.fields=w.fieldsBase.concat(w.fieldsAdm);r.metaConfig=true;r.myMeta=w}r.myMeta.metaVersion=_versionMeta;_SM.savePclCache(r.myMeta.viewCode,r.myMeta,true);if(r.metaConfig){_SM.savePci(r.myMeta)}else{w={viewCode:"_custom."+r.myMeta.viewCode,metaVersion:_versionMeta,custom:w};_SM.savePci(w)}},reload:function(){},cancel:function(){r.cancelChanges()},show1:function(){_SM.showConfig("Meta",r.myMeta)},add:function(w){n(w)},del:function(w){d(w)},scope:this});u.on({select:function(z,w,y,x){g();j();r.treeRecord=w;b(w)},scope:r});h.on({beforeedit:{fn:function(x,y,w){if(r.editable==false){return false}}},edit:{fn:function(x,z,w){if(z.value==z.originalValue){return}var A=r.treeRecord.data.__ptConfig;var y=z.record.data.name;if(_SM.typeOf(A)!="object"){if(!A.__ptConfig){A.__ptConfig={}}A.__ptConfig[y]=z.value}else{A[y]=z.value}}},scope:r});v.on({checked:{fn:function(w,x,y){j()}},reorder:{fn:function(){j()}},scope:r});function o(x){var z={};if(x.custom){if(x.metaConfig){var B={listDisplay:x.myMeta.gridConfig.listDisplay};B=Ext.apply(B,x.myMeta.gridSets);z=Meta2Tree(B,"custom","custom")}else{z=Meta2Tree(x.myMeta.custom,"custom","custom")}}else{var y=_SM.clone(x.myMeta,0,["fields"]);y.fieldsBase=y.fieldsBase.sort(_SM.sortObjByName);y.fieldsAdm=y.fieldsAdm.sort(_SM.sortObjByName);z=Meta2Tree(y,"pcl","pcl");for(var w in z.children){var A=z.children[w];if(A.text=="fields"){z.children.splice(w,1);break}}}z.expanded=true;x.treeData=_SM.clone(z);return z}function n(z){var w=z.data.__ptType;if(!w){return}var y=z.data.__ptConfig||{};var E=_MetaObjects[w];var A=_MetaObjects[E.listOf]||{};var C=_SM.ptPrompt(E.listOf,A.addPrompt);if(!C){return}var D=A.nodeName||"name";var B=getNodeBase(C,E.listOf,{__ptType:E.listOf});B.__ptConfig[D]=C;if(A.__ptStyle=="jsonText"){var F=A.addTemplate.replace("@name",C);B.__ptConfig.__ptValue=F}else{if(A.__ptStyle=="colList"){}else{var x=verifyMeta({},E.listOf,B)}}z.appendChild(B)}function d(x){var z=x.data.__ptType;var y=x.parentNode;x.remove();c();if(y){var w=r.treeGrid.getView();w.select(y)}}function m(w){var x=_MetaObjects[w]||{};return x.description||""}function g(){if(k.isVisible()){k.__ptConfig.__ptValue=k.getRawValue()}}function j(){if(v.isVisible()){v.__ptConfig.__ptList=Ext.encode(v.getChecked())}}function c(){k.hide();h.hide();v.hide();f()}function f(){e.setButton("add",bVisible=false,true);e.setButton("del",bVisible=false,true)}function b(x){var C=x.data;var A=C.__ptType;var y=C.__ptConfig||{};var z=_MetaObjects[A]||{};var w=m(x.data.text);if(w){w="<B>"+x.data.text+"</B> : "+w}else{w="<B>"+A+"</B>  [ "+x.data.text+" ]"}p.setText(w,false);c();if(z.__ptStyle=="jsonText"){k.__ptConfig=y;k.setRawValue(y.__ptValue);k.setFieldLabel(C.text);k.show()}else{if(z.__ptStyle=="colList"){v.show();v.__ptConfig=y;l(C)}else{h.show();prepareProperties(x,r.myMeta,h)}}var B=_MetaObjects[A]||{};if(B.allowAdd){e.setButton("add",true,true,_SM.__language.ProtoPcl_Add_Instance+A,x)}if(B.allowDel){e.setButton("del",true,true,_SM.__language.ProtoPcl_Del_Current+A+" ["+C.text+"]",x)}}var a;function l(A){if(!a){a=[];for(var w in r.myMeta.fieldsBase){var z=r.myMeta.fieldsBase[w];a.push(z.name)}}var y=Ext.decode(A.__ptConfig.__ptList);var x=[];for(var w in y){var z=y[w];if(r.myFieldDict[z]){x.push(z)}}v.removeAll();v.addDataSet(x,true);v.addDataSet(a)}},cancelChanges:function(){}});function prepareProperties(a,g,c){var d={};var b=_SM.clone(a.data.__ptConfig),f=a.data.__ptType,h=a.data.text,e=_SM.getFieldDict(g);if(f in _SM.objConv(["field","formField"])){d=getTemplate(f,false,e[h]);b.name=h}else{d=getTemplate(f,false)}b=Ext.apply(d.__ptConfig,b);b=clearPhantonProps(b,f);c.setSource(b);c.setCombos(d.__ppChoices);c.setTypes(d.__ppTypes);c.readOnlyProps=["__ptType","name"].concat(d.__roProperties);c.sourceInfo=d.__ptHelp}function getTemplate(d,o,c){var h={},m={},q={},f={};var e,k,j,l,g,p;var a=_MetaObjects[d]||{};for(var b in a.properties){var n=a.properties[b];if(_SM.typeOf(n)=="object"){e=n.name;k=n.value}else{e=n;k=_MetaProperties[e]||null}j=_MetaProperties[e+".help"];l=_MetaProperties[e+".choices"];p=_MetaProperties[e+".type"];if(o){if(k){h[e]=k}}else{h[e]=k||"";m[e]=j;if(l){q[e]=l}if(p){f[e]=p}}}if(c){g=_SM.getFormFieldDefinition(c);h=Ext.apply(h,g)}if(o&&(!h.xtype)){h.xtype=d}if((h.xtype=="formField")&&(d=="formField")){h.xtype="textfield"}return{__ptConfig:h,__ptHelp:m,__ppChoices:q,__ppTypes:f,__roProperties:a.roProperties||[]}}Ext.define("ProtoUL.proto.ProtoToolBar",{extend:"Ext.Toolbar",alias:"widget.protoToolBar",initComponent:function(){var a=this;a.addEvents("save","preview","add","del","help","show1");Ext.apply(this,{items:[{tooltip:_SM.__language.ProtoToolbar_Upd_Def,iconCls:"icon-save",itemId:"save",scope:this,handler:function(){a.fireEvent("save")}}," ",{tooltip:_SM.__language.ProtoToolbar_Add_Node,iconCls:"icon-nodeInsert",hidden:true,itemId:"add",scope:this,handler:function(b){a.fireEvent("add",b.oData)}},{tooltip:_SM.__language.ProtoToolbar_Del_Current_Node,iconCls:"icon-nodeDelete",hidden:true,itemId:"del",scope:this,handler:function(b){a.fireEvent("del",b.oData)}}]});a.callParent(arguments)},setButton:function(d,a,e,b,f){var c=this.getComponent(d);c.setVisible(a);c.setDisabled(!e);c.setTooltip(b);c.oData=f}});function getSelectorsPanels(b,a){return[{region:"center",layout:"fit",minSize:200,items:b,border:false,flex:5},{region:"east",collapsible:true,collapsed:false,split:true,layout:"fit",minSize:200,items:a,border:false,flex:2}]}function getSimpleProperties(g,c){if(_SM.typeOf(g)=="array"){return[]}var b={};if(c){b.__ptType=c}for(var d in g){var a=g[d];if(_SM.typeOf(a) in _SM.objConv(["object","array"])){continue}if(d in _SM.objConv(["__ptValue","__ptList"])){try{b=Ext.decode(a)}catch(f){}}else{a=verifyPrpType(d,a);if(a){b[d]=a}}}return b}function Meta2Tree(b,m,f){var n=_MetaObjects[f];if(!n){return}function a(q){q.text=b.name||b.menuText||b.property||b.viewEntity||f;return q}function c(q){var t=[];for(var v in q){var w=q[v],s;var r=getSimpleProperties(w,u);var u=r.__ptType;if(u in _SM.objConv(["htmlset","fieldset","tabpanel","accordeon","panel"])){s=getNodeBase(u,u,r);s.children=c(w.items);t.push(s)}else{if(u in _SM.objConv(["formField","protoGrid"])){if(u=="protoGrid"){s=getNodeBase(r.menuText,u,r)}else{s=getNodeBase(r.name,u,r)}s.leaf=true;t.push(s)}}}return t}function e(r,s,q){if(r.hideItems){if(q.items){s.children=c(q.items)}else{s.children=c(q)}return true}if(r.__ptStyle=="jsonText"){if(q.name){s.__ptConfig.name=q.name}s.__ptConfig.__ptValue=Ext.encode(q);return true}if(r.__ptStyle=="colList"){s.__ptConfig.__ptList=Ext.encode(q);return true}}function g(w,r,t){var s=_MetaObjects[r];for(var u in w){var v=w[u];var q=Meta2Tree(v,m,r);t.children.push(q)}}function p(s){if(s.lists){if(_SM.typeOf(s.lists)!="array"){s.lists=[]}else{for(var r in s.lists){var t=s.lists[r];if(typeof(t)!="string"){delete s.lists[r];continue}var q=_MetaObjects[t];if(q.__ptStyle=="colList"||q.__ptStyle=="jsonText"){continue}if(!q.listOf){continue}}}}if(s.objects){if(_SM.typeOf(s.objects)!="array"){s.lists=[]}else{for(var r in s.objects){var t=s.objects[r];if(typeof(t)!="string"){continue}}}}}var j=getSimpleProperties(b,f);var l=getNodeBase(f,f,j);if(e(n,l,b)){return a(l)}if(n.listOf){g(b,f,l)}p(n);for(var d in n.lists){var o=n.lists[d];var h=_MetaObjects[o],k;k=getNodeBase(o,o,{__ptType:o});if(!e(h,k,b[o])){g(b[o],h.listOf,k)}l.children.push(k)}for(var d in n.objects){var o=n.objects[d];var k=Meta2Tree(b[o],o,o);l.children.push(k)}return a(l)}function Tree2Meta(c){var d,f;var e=g(c);if(!e.__ptConfig){return}var h=_MetaObjects[e.__ptType];if(h.listOf){f=[];b(e.tChilds,f,"array")}else{if(h.__ptStyle in _SM.objConv(["colList","jsonText"])){f=getSimpleProperties(e.__ptConfig,e.__ptType)}else{if(h.properties||h.lists||h.objects){f=getSimpleProperties(e.__ptConfig,e.__ptType);if(e.tChilds.length>0){if(h.hideItems){f.items=[];b(e.tChilds,f.items,"array")}else{b(e.tChilds,f,"object")}}}}}return f;function b(l,n,o){for(var j in l){var k=l[j];var m=Tree2Meta(k);if(o=="object"){n[a(k)]=m}else{n.push(m)}}}function g(j){var k,l={};if(j.data){k=j.data;l.tChilds=j.childNodes}else{k=j;l.tChilds=j.children}l.__ptType=k.__ptType;if(!k.__ptConfig){l.__ptConfig={};return l}l.__ptConfig=clearPhantonProps(k.__ptConfig,l.__ptType);return l}function a(j){if(j.__ptType){return j.__ptType}else{if(j.data&&j.data.__ptType){return j.data.__ptType}}}}function getNodeBase(a,c,b){return{id:Ext.id(),text:a,__ptType:c,__ptConfig:b,children:[]}}Ext.define("ProtoUL.ux.FieldHtmlEditor",{extend:"Ext.form.HtmlEditor",alias:"widget.htmlfield",initComponent:function(){Ext.apply(this,{plugins:a()});this.callParent();function a(){return[new ProtoUL.ux.HtmlEditor.Word(),new ProtoUL.ux.HtmlEditor.Table(),new ProtoUL.ux.HtmlEditor.HR(),new ProtoUL.ux.HtmlEditor.SpecialCharacters(),new ProtoUL.ux.HtmlEditor.MidasFormat()]}},setReadOnly:function(c){var b=this;if(b.initialized&&c!=undefined){var a=b.getToolbar();a.setVisible(!c)}b.superclass.setReadOnly(c)}});Ext.define("ProtoUL.ux.HtmlEditor.HR",{extend:"Ext.util.Observable",langTitle:"Horizontal Rule",langToolTip:"Insert horizontal rule with configurable lenght",langHelp:"Enter the width of the Rule in percentage<br/> followed by the % sign at the end, or to<br/> set a fixed width ommit the % symbol.",langInsert:"Insert",langCancel:"Cancel",langWidth:"Width",defaultHRWidth:"100%",cmd:"hr",init:function(a){this.cmp=a;this.cmp.on("render",this.onRender,this)},onRender:function(){var b=this.cmp.getToolbar().add("-",{iconCls:"x-edit-hr",handler:a,scope:this,tooltip:{title:this.langTitle,text:this.langToolTip},overflowText:this.langTitle});function a(){if(!this.hrWindow){this.hrWindow=Ext.create("Ext.window.Window",{title:this.langTitle,width:250,closeAction:"hide",items:[{xtype:"form",itemId:"insert-hr",border:false,plain:true,bodyStyle:"padding: 10px;",labelWidth:60,labelAlign:"right",items:[{xtype:"label",html:this.langHelp+"<br/>&nbsp;"},{xtype:"textfield",maskRe:/[0-9]|%/,regex:/^[1-9][0-9%]{1,3}/,fieldLabel:this.langWidth,name:"hrwidth",anchor:"-20px;",value:this.defaultHRWidth,listeners:{specialkey:function(c,d){if((d.getKey()==d.ENTER||d.getKey()==d.RETURN)&&c.isValid()){this.doInsertHR()}},scope:this}}]}],buttons:[{text:this.langInsert,handler:function(){var c=this.hrWindow.getComponent("insert-hr").getForm();if(c.isValid()){this.doInsertHR()}else{c.findField("hrwidth").getEl().frame()}},scope:this},{text:this.langCancel,handler:function(){this.hrWindow.hide()},scope:this}],listeners:{render:(Ext.isGecko)?this.focusHRLong:this.focusHR,show:this.focusHR,move:this.focusHR,scope:this}})}this.hrWindow.show()}},focusHRLong:function(a){this.focus(a,600)},focusHR:function(a){this.focus(a,100)},focus:function(b,a){b.getComponent("insert-hr").getForm().findField("hrwidth").focus(true,a)},doInsertHR:function(){var b=this.hrWindow.getComponent("insert-hr").getForm();if(b.isValid()){var a=b.findField("hrwidth").getValue();if(a){this.insertHR(a)}else{this.insertHR(this.defaultHRWidth)}b.reset();this.hrWindow.hide()}},insertHR:function(a){this.cmp.insertAtCursor('<hr width="'+a+'">')}});Ext.define("ProtoUL.ux.HtmlEditor.SpecialCharacters",{extend:"Ext.util.Observable",langTitle:"Insert Special Character",langToolTip:"Insert special languaje character ",langInsert:"Insert",langCancel:"Cancel",specialChars:[153],charRange:[160,256],chars:[],init:function(a){this.cmp=a;this.cmp.on("render",this.onRender,this)},onRender:function(){var a=this.cmp.getToolbar().add({iconCls:"x-edit-char",handler:b,scope:this,tooltip:{title:this.langTitle,text:this.langToolTip},overflowText:this.langTitle});function b(){if(!this.chars.length){if(this.specialChars.length){Ext.each(this.specialChars,function(f,e){this.chars[e]=["&#"+f+";"]},this)}for(var c=this.charRange[0];c<this.charRange[1];c++){this.chars.push(["&#"+c+";"])}}var d=Ext.create("Ext.data.ArrayStore",{fields:["char"],data:this.chars});this.charWindow=Ext.create("Ext.window.Window",{title:this.langTitle,width:436,height:245,layout:"fit",plain:true,items:[{xtype:"dataview",store:d,itemId:"charView",autoHeight:true,multiSelect:true,tpl:new Ext.XTemplate('<tpl for="."><div class="char-item">{char}</div></tpl><div class="x-clear"></div>'),overItemCls:"char-over",itemSelector:"div.char-item",trackOver:true,listeners:{itemdblclick:function(h,g,k,j,l,f){this.insertChar(g.get("char"));this.charWindow.close()},scope:this}}],buttons:[{text:this.langInsert,handler:function(){var e=this.charWindow.down("#charView");Ext.each(e.getSelectedNodes(),function(f){var g=e.getRecord(f).get("char");this.insertChar(g)},this);this.charWindow.close()},scope:this},{text:this.langCancel,handler:function(){this.charWindow.close()},scope:this}]});this.charWindow.show()}},insertChar:function(a){if(a){this.cmp.insertAtCursor(a)}}});Ext.define("ProtoUL.ux.HtmlEditor.Table",{extend:"Ext.util.Observable",langTitle:"Insert Table",langToolTip:"Insert table de NxN with configurable border",langInsert:"Insert",langCancel:"Cancel",langRows:"Rows",langColumns:"Columns",langBorder:"Border",langCellLabel:"Label Cells",cmd:"table",showCellLocationText:true,cellLocationText:"{0}&nbsp;-&nbsp;{1}",tableBorderOptions:[["1px dotted #000","Dotted"],["1px solid #000","Sold Thin"],["2px solid #000","Solid Thick"]],init:function(a){this.cmp=a;this.cmp.on("render",this.onRender,this)},onRender:function(){var b=this.cmp.getToolbar().add("-",{iconCls:"x-edit-table",handler:a,scope:this,tooltip:{title:this.langTitle,text:this.langToolTip},overflowText:this.langTitle});function a(){if(!this.tableWindow){this.tableWindow=Ext.create("Ext.window.Window",{title:this.langTitle,closeAction:"hide",width:300,items:[{itemId:"insert-table",xtype:"form",border:false,plain:true,bodyStyle:"padding: 10px;",labelWidth:65,labelAlign:"right",items:[{xtype:"numberfield",allowBlank:false,allowDecimals:false,fieldLabel:this.langRows,name:"row",width:150,minValue:1,value:1},{xtype:"numberfield",allowBlank:false,allowDecimals:false,fieldLabel:this.langColumns,name:"col",width:150,minValue:1,value:1},{xtype:"combo",fieldLabel:this.langBorder,name:"border",forceSelection:true,mode:"local",store:Ext.create("Ext.data.ArrayStore",{autoDestroy:true,fields:["spec","val"],data:this.tableBorderOptions}),triggerAction:"all",value:"1px dotted #000",displayField:"val",valueField:"spec",anchor:"-15",editable:false}]}],buttons:[{text:this.langInsert,handler:function(){var h=this.tableWindow.getComponent("insert-table").getForm();if(h.isValid()){var e=h.findField("border").getValue();var c=[h.findField("row").getValue(),h.findField("col").getValue()];if(c.length==2&&c[0]>0&&c[1]>0){var k=Math.floor(100/c[1]);var g="<table style='border-collapse: collapse'>";var f="&nbsp;";for(var j=0;j<c[0];j++){g+="<tr>";for(var d=0;d<c[1];d++){g+="<td width='"+k+"%' style='border: "+e+";'>";g+=f;g+="</td>"}g+="</tr>"}g+="</table>";this.cmp.insertAtCursor(g)}this.tableWindow.hide()}else{if(!h.findField("row").isValid()){h.findField("row").getEl().frame()}else{if(!h.findField("col").isValid()){h.findField("col").getEl().frame()}}}},scope:this},{text:this.langCancel,handler:function(){this.tableWindow.hide()},scope:this}]})}this.tableWindow.show()}}});Ext.define("ProtoUL.ux.HtmlEditor.Word",{extend:"Ext.util.Observable",langTitle:"Word Paste",langToolTip:"Cleanse text pasted from Word or other Rich Text applications",wordPasteEnabled:true,curLength:0,lastLength:0,lastValue:"",init:function(a){this.cmp=a;this.cmp.on("render",this.onRender,this);this.cmp.on("initialize",this.onInit,this,{delay:100,single:true})},onInit:function(){Ext.EventManager.on(this.cmp.getDoc(),{keyup:this.checkIfPaste,scope:this});this.lastValue=this.cmp.getValue();this.curLength=this.lastValue.length;this.lastLength=this.lastValue.length},checkIfPaste:function(c){var a=0;this.curLength=this.cmp.getValue().length;if(c.V==c.getKey()&&c.ctrlKey&&this.wordPasteEnabled){this.cmp.suspendEvents();a=this.findValueDiffAt(this.cmp.getValue());var b=[this.cmp.getValue().substr(0,a),this.fixWordPaste(this.cmp.getValue().substr(a,(this.curLength-this.lastLength))),this.cmp.getValue().substr((this.curLength-this.lastLength)+a,this.curLength)];this.cmp.setValue(b.join(""));this.cmp.resumeEvents()}this.lastLength=this.cmp.getValue().length;this.lastValue=this.cmp.getValue()},findValueDiffAt:function(b){for(var a=0;a<this.curLength;a++){if(this.lastValue[a]!=b[a]){return a}}},fixWordPaste:function(a){var b=[/&nbsp;/ig,/[\r\n]/g,/<(xml|style)[^>]*>.*?<\/\1>/ig,/<\/?(meta|object|span)[^>]*>/ig,/<\/?[A-Z0-9]*:[A-Z]*[^>]*>/ig,/(lang|class|type|href|name|title|id|clear)=\"[^\"]*\"/ig,/style=(\'\'|\"\")/ig,/<![\[-].*?-*>/g,/MsoNormal/g,/<\\?\?xml[^>]*>/g,/<\/?o:p[^>]*>/g,/<\/?v:[^>]*>/g,/<\/?o:[^>]*>/g,/<\/?st1:[^>]*>/g,/&nbsp;/g,/<\/?SPAN[^>]*>/g,/<\/?FONT[^>]*>/g,/<\/?STRONG[^>]*>/g,/<\/?H1[^>]*>/g,/<\/?H2[^>]*>/g,/<\/?H3[^>]*>/g,/<\/?H4[^>]*>/g,/<\/?H5[^>]*>/g,/<\/?H6[^>]*>/g,/<\/?P[^>]*><\/P>/g,/<!--(.*)-->/g,/<!--(.*)>/g,/<!(.*)-->/g,/<\\?\?xml[^>]*>/g,/<\/?o:p[^>]*>/g,/<\/?v:[^>]*>/g,/<\/?o:[^>]*>/g,/<\/?st1:[^>]*>/g,/style=\"[^\"]*\"/g,/style=\'[^\"]*\'/g,/lang=\"[^\"]*\"/g,/lang=\'[^\"]*\'/g,/class=\"[^\"]*\"/g,/class=\'[^\"]*\'/g,/type=\"[^\"]*\"/g,/type=\'[^\"]*\'/g,/href=\'#[^\"]*\'/g,/href=\"#[^\"]*\"/g,/name=\"[^\"]*\"/g,/name=\'[^\"]*\'/g,/ clear=\"all\"/g,/id=\"[^\"]*\"/g,/title=\"[^\"]*\"/g,/<span[^>]*>/g,/<\/?span[^>]*>/g,/<title>(.*)<\/title>/g,/class=/g,/<meta[^>]*>/g,/<link[^>]*>/g,/<style>(.*)<\/style>/g,/<w:[^>]*>(.*)<\/w:[^>]*>/g];Ext.each(b,function(c){a=a.replace(c,"")});a=a.replace(/<div[^>]*>/g,"<p>");a=a.replace(/<\/?div[^>]*>/g,"</p>");return a},onRender:function(){this.cmp.getToolbar().add("-",{iconCls:"x-edit-wordpaste",pressed:true,handler:function(a){a.toggle(!a.pressed);this.wordPasteEnabled=!this.wordPasteEnabled},scope:this,tooltip:{text:this.langToolTip,title:this.langTitle},overflowText:this.langTitle})}});Ext.define("ProtoUL.ux.HtmlEditor.MidasCommand",{extend:"Ext.util.Observable",init:function(a){this.cmp=a;this.btns=[];this.cmp.on("render",this.onRender,this);this.cmp.on("initialize",this.onInit,this,{delay:100,single:true})},onInit:function(){Ext.EventManager.on(this.cmp.getDoc(),{mousedown:this.onEditorEvent,dblclick:this.onEditorEvent,click:this.onEditorEvent,keyup:this.onEditorEvent,buffer:100,scope:this})},onRender:function(){var d,a=this.cmp.getToolbar(),c,b;Ext.each(this.midasBtns,function(e){if(Ext.isObject(e)){b=(e.iconCls)?e.iconCls:"x-edit-"+e.cmd;if(e.value){b=b+"-"+e.value.replace(/[<>\/]/g,"")}d={iconCls:b,handler:function(){this.cmp.relayCmd(e.cmd,e.value)},scope:this,tooltip:e.tooltip||{title:e.title},overflowText:e.overflowText||e.title}}else{d=Ext.create("Ext.toolbar.Separator")}c=a.add(d);if(e.enableOnSelection){c.disable()}this.btns.push(c)},this)},onEditorEvent:function(){var a=this.cmp.getDoc();Ext.each(this.btns,function(c,d){if(this.midasBtns[d].enableOnSelection||this.midasBtns[d].disableOnSelection){if(a.getSelection){if((this.midasBtns[d].enableOnSelection&&a.getSelection()!=="")||(this.midasBtns[d].disableOnSelection&&a.getSelection()==="")){c.enable()}else{c.disable()}}else{if(a.selection){if((this.midasBtns[d].enableOnSelection&&a.selection.createRange().text!=="")||(this.midasBtns[d].disableOnSelection&&a.selection.createRange().text==="")){c.enable()}else{c.disable()}}}}if(this.midasBtns[d].monitorCmdState){c.toggle(a.queryCommandState(this.midasBtns[d].cmd))}},this)}});Ext.define("ProtoUL.ux.HtmlEditor.MidasFormat",{extend:"ProtoUL.ux.HtmlEditor.MidasCommand",midasBtns:["|",{enableOnSelection:true,cmd:"removeFormat",tooltip:{text:"Remove Formatting"},overflowText:"Remove Formatting"}]});Ext.define("ProtoUL.ux.CheckColumn",{extend:"Ext.grid.column.Column",alias:"widget.mycheckcolumn",stopSelection:true,tdCls:Ext.baseCSSPrefix+"grid-cell-checkcolumn",constructor:function(){this.addEvents("beforecheckchange","checkchange");this.callParent(arguments)},processEvent:function(g,j,n,b,h,d){var f=this,m=g==="keydown"&&d.getKey(),a=g=="mousedown";if(a||(m==d.ENTER||m==d.SPACE)){if(this.readOnly){return false}if(this.inGrid){if(!this.ownerCt.ownerCt.ownerCt.editable){return false}}var c=j.panel.store.getAt(b),k=f.dataIndex,l=!c.get(k);if(f.fireEvent("beforecheckchange",c,b,l)!==false){c.set(k,l);f.fireEvent("checkchange",c,b,l);if(a){d.stopEvent()}if(!f.stopSelection){j.selModel.selectByPosition({row:b,column:h})}return false}else{return !f.stopSelection}}else{return f.callParent(arguments)}},renderer:function(b){var c=Ext.baseCSSPrefix,a=[c+"grid-checkheader"];if(b){a.push(c+"grid-checkheader-checked")}return'<div class="'+a.join(" ")+'">&#160;</div>'}});Ext.define("ProtoUL.ux.GridHeaderToolTip",{alias:"plugin.headertooltip",init:function(a){var b=a.headerCt;if(!b){return}a.headerCt.on("afterrender",function(c){a.tip=Ext.create("Ext.tip.ToolTip",{target:b.el,delegate:".x-column-header",trackMouse:true,renderTo:Ext.getBody(),listeners:{beforeshow:function(d){var e=b.down("gridcolumn[id="+d.triggerElement.id+"]");if(e&&e.tooltip){d.update(e.tooltip)}else{return false}}}})})}});Ext.define("ProtoUL.ux.protoMenu",{extend:"Ext.menu.Menu",alias:"widget.protoMenu",afterRender:function(){this.superclass.afterRender.apply(this,arguments);var a=this;this.tip=new Ext.ToolTip({target:this.getEl().getAttribute("id"),renderTo:document.body,trackMouse:true,delegate:".x-menu-item",title:"",listeners:{beforeshow:function(b){var d=a.activeItem.initialConfig;if(d&&d.qtip){b.setTitle(d.text);b.update(d.qtip)}else{b.update(d.text)}}}})}});Ext.define("Ext.ux.HelpQbe",{extend:"Ext.form.field.Trigger",alias:"widget.HelpQbe",triggerCls:Ext.baseCSSPrefix+"form-search-trigger",autoWidth:true,isLoaded:false,initComponent:function(){var a=this;a.myMeta=_SM._cllPCI[a.viewCode];a.createHelpWindow(a);this.callParent(arguments);this.on("specialkey",function(b,c){if(c.getKey()==c.ENTER){this.enterKey()}},this)},createHelpWindow:function(c){Ext.define("Model_"+c.fieldLabel,{extend:"Ext.data.Model",fields:[""+c.name]});this.myStore=Ext.create("Ext.data.Store",{model:"Model_"+c.fieldLabel,proxy:{type:"ajax",url:_SM._PConfig.urlHelpQbe,reader:{type:"json",root:"data",totalProperty:"totalCount"},actionMethods:{read:"POST"},extraParams:{query:c.myMeta.sql,field:c.name}},autoLoad:false});var a=Ext.create("Ext.grid.Panel",{region:"center",store:this.myStore,columns:[{text:c.fieldLabel,dataIndex:c.name,flex:1}],height:400,width:400,bbar:Ext.create("Ext.PagingToolbar",{store:this.myStore,displayInfo:true,displayMsg:_SM.__language.HelpQBE_GridNav_DisplayMsg,emptyMsg:_SM.__language.HelpQBE_GridNav_EmptyMsg})});a.on({itemdblclick:{fn:function(h,d,j,f,k,g){c.selectValue()},scope:c}});c.win=Ext.widget("window",{title:_SM.__language.HelpQBE_Window_Title+" : ",closeAction:"hide",modal:true,width:400,minWidth:400,height:400,minHeight:400,resizable:true,layout:{type:"border"},items:[{xtype:"toolbar",items:[{height:25,xtype:"textfield",flex:1,validator:function(d){if(d==""){this.up("toolbar").down("container[name=_TOOLS_]").disable()}else{this.up("toolbar").down("container[name=_TOOLS_]").enable()}return true}},{xtype:"container",name:"_TOOLS_",disabled:true,items:[{xtype:"button",width:25,text:">",tooltip:_SM.__language.HelpQBE_Tooltip_PlusThan_Button,handler:function(){this.up("window").addText(this)}},{xtype:"button",width:25,text:"<",tooltip:_SM.__language.HelpQBE_Tooltip_LessThan_Button,handler:function(){this.up("window").addText(this)}},{xtype:"button",width:25,text:">=",tooltip:_SM.__language.HelpQBE_Tooltip_PlusEqualThan_Button,handler:function(){this.up("window").addText(this)}},{xtype:"button",width:25,text:"<=",tooltip:_SM.__language.HelpQBE_Tooltip_LessEqualThan_Button,handler:function(){this.up("window").addText(this)}},{xtype:"button",width:25,text:"<>",tooltip:_SM.__language.HelpQBE_Tooltip_Different_Button,handler:function(){this.up("window").addText(this)}},{xtype:"button",width:25,text:":",tooltip:_SM.__language.HelpQBE_Tooltip_Between_Button,handler:function(){this.up("window").addText(this)}},{xtype:"button",width:25,text:"*",tooltip:_SM.__language.HelpQBE_Tooltip_Containing_Button,handler:function(){this.up("window").addText(this)}}]}],region:"north"},a],dockedItems:[{xtype:"toolbar",dock:"bottom",ui:"footer",defaults:{minWidth:75},items:[{xtype:"tbtext",text:"",id:c.idStBar},{xtype:"component",flex:1},{xtype:"button",text:_SM.__language.Text_Accept_Button,scope:c,handler:c.doReturn,iconCls:"icon-accept"},{xtype:"button",text:_SM.__language.Text_Cancel_Button,scope:c,handler:b,iconCls:"icon-cancel"}]}],addText:function(e){var g=this.down("textfield").getValue();var f="";for(var d=0;d<g.length;d++){var h=g.substring(d,d+1);if(!(h==">"||h=="<"||h=="="||h=="*")){if(h==":"){break}else{f=f+h}}}switch(e.text){case":":this.down("textfield").setValue(f+""+e.text);break;case"*":this.down("textfield").setValue(e.text+""+f+""+e.text);break;default:this.down("textfield").setValue(e.text+""+f)}}});c.isLoaded=true;function b(){c.win.hide()}},onTriggerClick:function(){this.showHelpForm(this)},showHelpForm:function(a){if(!a.isLoaded){return a.win.show()}a.win.down("textfield").setValue(a.getValue());a.myStore.load()},selectValue:function(){var b=this.win.down("gridpanel").getSelectionModel().getSelection();var a=b[0];var c=this.win.down("textfield").getValue();var d=c.substring(c.length-1,c.length);if(d==":"){this.win.down("textfield").setValue(c+a.data[this.name])}else{this.win.down("textfield").setValue(a.data[this.name])}},doReturn:function(){this.setValue(this.win.down("textfield").getValue());this.win.hide()}});Ext.define("ProtoUL.ux.HtmlSet",{extend:"Ext.panel.Panel",alias:"widget.htmlset",border:false,layout:{type:"vbox",align:"stretch"},htlmFields:[],htmlPanels:{},height:200,flex:1,initComponent:function(){var d=this,f=[],c=this.myConfig;if(this.title){d.setTitle(this.title)}for(var a in this.htlmFields){var e=this.htlmFields[a];var b=Ext.create("Ext.panel.Panel",{__ptConfig:e,layout:{padding:5},autoScroll:true,html:"",title:e.fieldLabel||e.name,tools:[{type:"formUpd",itemId:"edithtml",tooltip:_SM.__language.Tooltip_Open_HtmlEditor,scope:this,handler:function(j,k,g,h){var l=g.ownerCt;openHtmlEditorWin(l)}}],collapsible:true,flex:1,setReadOnly:function(g){var h=this.getHeader();if(h){h=h.child("#edithtml")}if(h){h.setVisible(!g)}}});f.push(b);this.htmlPanels[e.name]=b}Ext.apply(this,{items:f});this.callParent(arguments)}});function openHtmlEditorWin(e){var a=Ext.create("ProtoUL.ux.FieldHtmlEditor",{value:e.rawHtml,border:false});var d=Ext.create("Ext.window.Window",{title:e.title,height:300,width:720,modal:true,layout:"fit",minHeight:200,minWidth:300,resizable:true,items:a,dockedItems:[{xtype:"toolbar",dock:"bottom",ui:"footer",items:["->",{iconCls:"icon-save",itemId:"save",text:_SM.__language.Text_Save_Button,scope:this,handler:b},{iconCls:"icon-reset",text:_SM.__language.Text_Return_Button,scope:this,handler:c}]}]});function b(){var f=a.getValue();e.update(f);e.rawHtml=f;d.close()}function c(){d.close()}d.show()}Ext.define("ProtoUL.ux.Login",{extend:"Ext.form.Panel",alias:"widget.protoLogin",bodyStyle:"padding:10px",labelWidth:120,labelAlign:"right",redirectUrl:false,username:"",defaults:{xtype:"textfield",anchor:"100%",enableKeyEvents:true},initComponent:function(){this.submitButton=new Ext.Button({text:_SM.__language.Text_Validate_Login_Button,iconCls:"st-user-go",scope:this,handler:this.submitLogin});this.resetButton=new Ext.Button({id:"resetButton",text:_SM.__language.Text_Forgotten_Password,iconCls:"st-user-who",scope:this,handler:this.resetPassword});this.changeButton=new Ext.Button({text:_SM.__language.Text_change_Password_Button,iconCls:"st-key-go",scope:this,handler:this.changePassword});Ext.apply(this,{items:[{fieldLabel:_SM.__language.Textfield_User_Login,id:"loginField",name:"login",value:this.username,listeners:{scope:this,keydown:this.onKeyEnter}},{fieldLabel:_SM.__language.Textfield_Password_Login,inputType:"password",name:"password",listeners:{scope:this,keydown:this.onKeyEnter}}],dockedItems:[{xtype:"toolbar",dock:"bottom",ui:"footer",items:[{xtype:"tbtext",flex:1,itemId:"stLogin"},this.submitButton,this.resetButton,this.changeButton]}]});this.callParent(arguments);this.stLogin=this.dockedItems.items[0].getComponent("stLogin");this.on("afterlayout",function(){if(this.username==""){this.getForm().findField("login").focus()}else{this.getForm().findField("password").focus()}})},onKeyEnter:function(a,b){if(b.getKey()==b.ENTER){this.submitLogin()}},submitLogin:function(a){if(!a){a=this.submitButton}a.disable();var c=this.getForm(),b=this;Ext.applyIf(this.options,{scope:this,success:Ext.emptyFn,failure:Ext.emptyFn});if(c.isValid()){a.setIconCls("st-loading");c.submit({method:"POST",url:_SM._PConfig.urlGetUserRights,scope:b,success:function(d,e){_SM._UserInfo=e.result.userInfo;_SM.__language=e.result.language;_SM._UserInfo.perms={};b.options.success.call(b.options.scope,d,e)},failure:function(d,f){try{b.showFormError(f.result.message)}catch(g){b.showFormError(f.response.responseText)}b.options.failure.call(b.options.scope,d,f)}})}else{a.enable()}},showFormError:function(a){var b=window.Ext.create("Ext.tip.ToolTip",{html:a,autoShow:true,autoScroll:true,focusOnToFront:true,autoHide:true,stateful:false,getTargetXY:function(){var d=Ext.getCmp("resetButton");var c=d.getPosition()[0];var e=d.getPosition()[1];return[c,e]},listeners:{hide:function(){b.destroy();b=null}}});b.show();this.submitButton.enable();this.submitButton.setIconCls("st-user-go");this.getForm().findField("login").focus()},resetPassword:function(a){var b=Ext.create("ProtoUL.view.password.ForgotPasswordForm");b.show()},changePassword:function(a){Ext.create("ProtoUL.view.password.PasswordReset").show()}});Ext.define("ProtoUL.ux.parameterWin",{extend:"Ext.window.Window",alias:"widget.parameterWin",parameters:[],width:400,minWidth:300,title:"Parameters form",layout:"fit",acceptText:"Accept",cancelText:"Cancel",options:{acceptFn:null,cancelFn:null},initComponent:function(){var d=this;var b=[];for(var a in this.parameters){var c=_SM.getFormFieldDefinition(this.parameters[a]);b.push(c)}Ext.applyIf(this.options,{scope:this,acceptFn:Ext.emptyFn,cancelFn:Ext.emptyFn});Ext.apply(this,{items:[{xtype:"form",autoScroll:true,monitorValid:true,items:[{xtype:"fieldset",defaultType:"textfield",layout:"column",defaults:{padding:"2 2",columnWidth:1},fieldDefaults:{labelAlign:"left",labelWidth:150,msgTarget:"side"},items:b}],buttons:[{text:this.cancelText,iconCls:"icon-cancel",scope:this,handler:this.cancel},{text:this.acceptText,iconCls:"icon-accept",scope:this,handler:this.accept,disabled:true,formBind:true}]}]});d.callParent(arguments)},accept:function(){var e=this.down("form").getForm();if(e.isValid()){var b=e.getFields().items;var d=[];for(var a in b){var c=b[a];d.push({parameter:c.getName(),value:c.getValue()})}this.options.acceptFn.call(this.options.scope,d);this.close()}},cancel:function(){this.options.cancelFn.call(this.options.scope);this.close()}});Ext.define("ProtoUL.ux.Printer",{requires:"Ext.XTemplate",statics:{gridPrint:function(c){var b=this.getGridColumns(c);var e=this.getGridData(c,b);var g=Ext.create("Ext.XTemplate",this.headerTpl).apply(b);var a=Ext.create("Ext.XTemplate",this.bodyTpl).apply(b);a=Ext.create("Ext.XTemplate",'<tpl for=".">'+a+"</tpl>").apply(e);var d=this.htmlTpl.toString();d=d.replace(/@gridTitle@/g,c.title);d=d.replace(/@siteTitle@/g,_SM._siteTitle);d=d.replace("@headings@",g);d=d.replace("@body@",a);var f=window.open("","printgrid");f.document.write(d);if(this.printAutomatically){f.document.close();f.focus();f.print()}},sheetPrint:function(b,d){var a="<hr>"+d;var c=this.htmlTpl.toString();c=c.replace(/@gridTitle@/g,b.title);c=c.replace(/@siteTitle@/g,_SM._siteTitle);c=c.replace("@headings@","");c=c.replace("@body@",a);var e=window.open("","printgrid");e.document.write(c);if(this.printAutomatically){e.print()}},reportPrint:function(b,a){b.document.write(a);b.document.close();b.focus();b.print()},getGridData:function(b,a){var c=[];b.store.data.each(function(e){var g=[];for(var d in e.data){var f=e.data[d];Ext.each(a,function(h){if(h.dataIndex==d){g[d]=h.renderer?h.renderer(f):f}},this)}c.push(g)});return c},getGridColumns:function(d){var c=[];for(var a in d.columns){var b=d.columns[a];if(b.dataIndex){c.push(b)}}return c},printAutomatically:true,headerTpl:["<tr>",'<tpl for=".">',"<th>{text}</th>","</tpl>","</tr>","</thead>"],bodyTpl:["<tr>",'<tpl for=".">',"<td>{{dataIndex}}</td>","</tpl>","</tr>"],htmlTpl:'<!DOCTYPE html><html><head><meta content="text/html; charset=UTF-8" http-equiv="Content-Type" /><link href="/static/css/print.css" rel="stylesheet" type="text/css" media="screen,print" /><title>@gridTitle@</title></head><body><h1>@siteTitle@</h1><h2>@gridTitle@</h2><table><thead>@headings@</thead><tbody>@body@</tbody></table></body></html>'}});Ext.define("ProtoUL.ux.ProtoList",{extend:"Ext.grid.Panel",alias:"widget.protoList",columnList:["data"],idColumn:"id",dataList:[],dataSelected:[],idTitle:"",checkStyle:true,initComponent:function(){var f=this;f.addEvents("checked","reorder");var c=["__Checked"];for(var b in this.columnList){var g=this.columnList[b];if(_SM.typeOf(g)=="string"){c.push(g)}else{if(g.dataIndex){c.push(g.dataIndex)}}}this.gridStore=Ext.create("Ext.data.Store",{fields:c,idProperty:this.idColumn,data:[]});var a=[];if(f.checkStyle){a=[{xtype:"mycheckcolumn",dataIndex:"__Checked",menuDisabled:true,width:33,listeners:{checkchange:function(h,j,k){f.fireEvent("checked",h,j,k)}},scope:f}]}for(var b in this.columnList){var g=this.columnList[b];if(_SM.typeOf(g)=="string"){var d={menuDisabled:true,flex:1,text:this.idTitle,dataIndex:g}}else{if(g.dataIndex){var d=Ext.apply(g,{menuDisabled:true})}}a.push(d)}var e=Ext.apply(this,{store:this.gridStore,stripeRows:true,columns:a,viewConfig:{plugins:{ptype:"gridviewdragdrop",ddGroup:Ext.id(),dragText:_SM.__language.ProtoList_DD_Text},listeners:{drop:function(k,m,l,h,j){f.fireEvent("reorder")},scope:f}}});this.callParent(arguments);e.on({sortchange:function(j,k,l,h){f.fireEvent("reorder")},scope:f});this.addDataSet(this.dataList,false);this.addDataSet(this.dataSelected,true)},addDataSet:function(b,c){for(var a in b){var d=b[a];this.addDataItem(d,c)}},addDataItem:function(f,d){var c="data",g=f,b={};if(_SM.typeOf(f)=="array"){g=f[0];h=this.columnList[0];if(_SM.typeOf(h)=="string"){c=h}else{if(h.dataIndex){c=h.dataIndex}else{return}}}var e=_SM.getRecordByDataIx(this.gridStore,c,g);if(!e){if(_SM.typeOf(f)=="string"){b={data:f}}else{for(var a in this.columnList){var h=this.columnList[a];if(_SM.typeOf(h)=="string"){b[h]=f[a]}else{if(h.dataIndex){b[h.dataIndex]=f[a]}}}}if(d==true||d==false){b.__Checked=d}this.gridStore.add(b)}else{if(d){e.set("__Checked",d)}}},removeAll:function(){this.gridStore.removeAll()},getList:function(){var a=[];this.gridStore.each(function(b){a.push(b.get("data"))});return a},getChecked:function(){var a=[];this.gridStore.each(function(b){if(b.get("__Checked")){a.push(b.get("data"))}});return a},setChecked:function(c,a){var b=_SM.getRecordByDataIx(this.gridStore,"data",c);if(b){b.set("__Checked",a)}else{this.gridStore.add({data:c,__Checked:a})}},addOrRemove:function(c,a){if(a){this.setChecked(c,true)}else{var b=_SM.getRecordByDataIx(this.gridStore,"data",c);if(b){this.gridStore.remove(b)}}}});Ext.define("ProtoUL.ux.ProtoProperty",{extend:"Ext.grid.property.Grid",alias:"widget.protoProperty",source:{},readOnlyProps:[],editable:true,sourceInfo:{},initComponent:function(){var a=this;Ext.apply(this,{stripeRows:true,clicksToEdit:2,source:this.source,listeners:{beforeedit:function(c,d,b){if((!a.editable)||d.record.data.name in _SM.objConv(a.readOnlyProps)){return false}},itemmouseenter:function(c,b,d){var e=b.get("name");var f=a.sourceInfo[e];if(e&&e in _SM.objConv(a.readOnlyProps)){e+=" [RO]"}if(f){Ext.fly(d).set({"data-qtip":f,"data-qtitle":e})}},scope:a}});this.callParent(arguments)},setCombos:function(a){if(!a){return}for(var c in a){if(this.customEditors[c]){continue}var b=a[c];if(_SM.typeOf(b)=="array"){this.customEditors[c]=new Ext.grid.CellEditor({field:new Ext.form.field.ComboBox({editable:false,store:b})})}}},setTypes:function(a){if(!a){return}for(var d in a){if(this.customEditors[d]){continue}var b=a[d];var c=this.editors[b];if(c){this.customEditors[d]=c}}}});Ext.define("Ext.ux.protoQBE",{extend:"Ext.window.Window",alias:"widget.protoqbe",iconCls:"icon-filter",viewCode:null,defaultType:"textfield",autoHeigth:true,resizable:false,plain:true,modal:true,titulo:"",campos:{},aceptar:function(){},cancelPress:function(){},initComponent:function(){me=this;var a=new Array();if(me.titulo!==""){me.titulo="-"+me.titulo}var d=me.campos;for(i=0;i<d.length;i++){var b="";if(d[i].required==true){var c=_SM._requiredField;b="<b>"+d[i].name+"</b>"}else{b=d[i].name;var c=""}a.push({fieldLabel:Ext.util.Format.capitalize(b),afterLabelTextTpl:c,name:d[i].name,allowBlank:!d[i].required,width:300,viewCode:me.viewCode,editable:true,xtype:"HelpQbe",hideTrigger:!d[i].qbeHelp,enterKey:this.accept})}Ext.applyIf(me,{title:me.viewCode+me.titulo,items:[{xtype:"form",items:a,autoScroll:true,labelWidth:150,autoHeigth:true,maxHeight:400,width:350,flex:1,monitorValid:true,frame:true,bodyStyle:"padding:5px 10px 0",buttons:[{xtype:"button",width:10,text:_SM.__language.Text_Accept_Button,formBind:true,iconCls:"icon-accept",handler:this.accept},{xtype:"button",text:_SM.__language.Text_Cancel_Button,iconCls:"icon-cancel",width:10,handler:this.cancel}]}]});me.callParent(arguments)},accept:function(){var d=me.down("form").getForm();if(d.isValid()){var a=me.down("form").items.items;arrFilterQbe=new Array();var c="";for(i=0;i<a.length;i++){if(a[i].getValue().trim()!==""){var b={property:a[i].getName(),filterStmt:a[i].getValue()};arrFilterQbe.push(b)}}me.aceptar(arrFilterQbe);me.close()}},cancel:function(){me.cancelPress();me.close()}});Ext.define("ProtoUL.ux.ProtoSearchBG",{extend:"Ext.toolbar.Toolbar",alias:"widget.protoSearch",myMeta:null,initComponent:function(){var e=this;var a=this.myMeta;var d=new Ext.button.Button({tooltip:_SM.__language.Tooltip_Filter_Grid_Button,iconCls:"icon-filter",handler:f});var h=new Ext.button.Button({tooltip:_SM.__language.Text_Toolbar_Remove_Filters,handler:j,iconCls:"icon-filterdelete"});var c=new Ext.form.TextField({emptyText:_SM.__language.Text_Toolbar_Search_Field,enableKeyEvents:true,width:200,listeners:{keydown:function(k,l){if(l.getKey()==l.ENTER){f(d)}}}});e.protoEnable=(e.myMeta.gridConfig.searchFields.length>0);Ext.apply(e,{border:false,disabled:!e.protoEnable,items:[c,d,h]});e.addEvents("qbeLoadData");e.callParent();g();function f(l){var m=c.getValue();var k='" '+c.getValue()+' "';e.fireEvent("qbeLoadData",e,[{property:"_allCols",filterStmt:m}],k)}function j(k){g();e.fireEvent("qbeLoadData",e,[],"",[])}function b(l){data=e.myMeta;resp=data.fields;var k=Ext.create("Ext.ux.protoQBE",{campos:data.fields,viewCode:data.viewCode,titulo:data.shortTitle,aceptar:function(m){console.log("ok");e.fireEvent("qbeLoadData",e,m,"** qbe")}}).show()}function g(){c.setValue("")}}});Ext.define("ProtoUL.ux.protoZoom",{extend:"Ext.form.field.Trigger",alias:"widget.protoZoom",zoomModel:null,zommFilter:"",zoomGrid:null,zoomRecord:null,zoomRecords:null,zoomMultiple:false,triggerCls:Ext.baseCSSPrefix+"form-search-trigger",isLoaded:false,handleMouseEvents:true,initComponent:function(){var a=this;this.callParent(arguments);this.on("specialkey",function(b,c){if(c.getKey()==c.ENTER){this.onTriggerClick()}},this)},listeners:{render:function(a){a.getEl().on("click",this.onClickLink,this)}},onClickLink:function(a,b){if(!this.readOnly){return}if(b.nodeName=="LABEL"){return}this._loadZoom(this.doClickLink)},_loadZoom:function(b,d){var c=this,a={scope:c,success:function(g,e,f){c.createZoomWindow(c);b.call(c,c,d)},failure:function(g,e,f){return}};if(_SM.loadPci(c.zoomModel,true,a)){c.createZoomWindow(c);b.call(c,c,d)}},doClickLink:function(a){var b=Ext.create("ProtoUL.UI.FormController",{});b.openProtoForm.call(b,a.zoomModel,a.fkIdValue,false)},createZoomWindow:function(f){function e(){f.resetZoom();f.win.hide()}function d(){var j=Ext.create("ProtoUL.UI.FormController",{myMeta:f.myMeta});j.openNewForm(this.zoomGrid.store)}function h(){if(!this.zoomGrid.selected){_SM.errorMessage(_SM.__language.Title_Form_Panel,_SM.__language.GridAction_NoRecord);return}var j=Ext.create("ProtoUL.UI.FormController",{myMeta:f.myMeta});j.openLinkedForm(this.zoomGrid.selected)}if(f.isLoaded){return}f.myMeta=_SM._cllPCI[f.zoomModel];f.idStBar=Ext.id();var g="single";if(f.zoomMultiple&&f.newForm){g="multi"}this.zoomGrid=Ext.create("ProtoUL.view.ProtoGrid",{gridSelectionMode:g,viewCode:f.zoomModel,initialFilter:[],hideSheet:true,listDisplay:"__str__"});var b=Ext.create("ProtoUL.ux.ProtoSearchBG",{myMeta:f.myMeta});this.zoomGrid.on({selectionChange:{fn:function(k,j,m,l){f.setSelected(m,j,k)},scope:this}});this.zoomGrid.on({rowDblClick:{fn:function(j,k){f.setSelected(k,j);f.doReturn()},scope:f}});b.on({qbeLoadData:{fn:function(k,l,j,m){f.resetZoom();this.zoomGrid.gridLoadData(this.zoomGrid,l,m)},scope:this}});var c=_SM._UserInfo.perms[f.myMeta.viewCode],a=[{xtype:"tbtext",text:"",id:f.idStBar,flex:1,readOnly:true},{xtype:"button",text:_SM.__language.Text_Cancel_Button,scope:f,handler:e},{xtype:"button",text:"Ok",scope:f,handler:f.doReturn}];f.win=Ext.widget("window",{title:"Zoom : "+f.myMeta.shortTitle,iconCls:f.myMeta.viewIcon,closeAction:"hide",layout:"fit",modal:true,width:800,minWidth:400,height:600,minHeight:400,resizable:true,tbar:b,items:this.zoomGrid,dockedItems:[{xtype:"toolbar",dock:"bottom",ui:"footer",defaults:{minWidth:75},items:a}]});f.isLoaded=true;this.zoomGrid.setEditMode(true)},onTriggerClick:function(){this._loadZoom(this.doTriggerClick)},doTriggerClick:function(a){a.showZoomForm(a)},showZoomForm:function(c){if(!c.isLoaded){return}var d=a();if(d){if(d.length>0){this.zoomGrid.store.mySetBaseFilter(d)}}c.win.show();function a(){var g=c.zoomFilter;if(!c.zoomFilter){return g}if(!c.idProtoGrid){return g}var j=c.zoomFilter.match(/\(([^()]+)\)/g);if(j){if(j.length>0){var f=Ext.getCmp(c.idProtoGrid);for(var h in j){var m=j[h].replace("(","").replace(")","").split(",");for(var e in m){var k=m[e],l=b(f,k);g=g.replace("{0}".format(k),"{0}".format(l))}}}}g=g.split(";");for(h=0;h<g.length;h++){var n=g[h].split(":");g[h]={property:n[0].trim(),filterStmt:n[1].trim()}}return g}function b(f,h){var g;try{if(f.rowData){g=f.rowData[h.trim()]}else{g=f.myFieldDict[h.trim()]["prpDefault"]}}catch(j){g="-1"}return g}},setSelected:function(j,c,d){var b=Ext.getCmp(this.idStBar),h=this,a;function k(l){var m;if(!l){return}if(h.myMeta.returnField){m=l.get(h.myMeta.returnField)}else{m=l.get("__str__")||h.myMeta.viewCode+".str?"}return{name:h.name,fkId:h.fkId,recId:l.get("id"),recStr:m}}if(h.zoomMultiple&&h.newForm&&d){h.zoomRecords=[];var e=d.getSelection();for(a in e){h.zoomRecords.push(k(e[a]))}var f="";for(a in h.zoomRecords){f+=h.zoomRecords[a].recStr+";"}b.setText(f);h.retField=f}else{if(c){var g=k(c);h.zoomRecord=c;h.retField=g.recStr;b.setText("["+g.recId.toString()+"]  "+g.recStr)}else{h.zoomRecord=null;h.zoomRecords=null;b.setText("")}}},doReturn:function(){this.setValue(this.retField);this.win.hide()},resetZoom:function(){this.setSelected()}});if(!String.prototype.format){String.prototype.format=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(b,c){return typeof a[c]!="undefined"?a[c]:b})}}Ext.define("ProtoUL.ux.StatusBar",{extend:"Ext.toolbar.Toolbar",alternateClassName:"Ext.ux.StatusBar",alias:"widget.statusbar",requires:["Ext.toolbar.TextItem"],cls:"x-statusbar",busyIconCls:"x-status-busy",busyText:_SM.__language.StatusBar_Message_Loading,autoClear:5000,emptyText:"&#160;",activeThreadId:0,defaultText:"",text:_SM.__language.StatusBar_Message_Ready,iconCls:"ready-icon",busyCount:0,initComponent:function(){var a=this.statusAlign==="right";this.callParent(arguments);this.currIconCls=this.iconCls||this.defaultIconCls;this.statusEl=Ext.create("Ext.toolbar.TextItem",{cls:"x-status-text "+(this.currIconCls||""),text:this.text||this.defaultText||""});if(a){this.cls+=" x-status-right";this.add("->");this.add(this.statusEl)}else{this.insert(0,this.statusEl);this.insert(1,"->")}this.add([{itemId:"errBt",xtype:"splitbutton",text:_SM.__language.StatusBar_Text_Clean_Button,tooltip:_SM.__language.StatusBar_Tooltip_Clean_Button,scope:this,iconCls:"comment_delete",handler:this.clearErrCount,menu:new Ext.menu.Menu({items:[{text:"ClearTabs",tooltip:"clear all tabs",iconCls:"icon-4",handler:function(){_SM.__TabContainer.closeAllTabs();_SM._cllPCI={}}}]})},{itemId:"openTaskForm",xtype:"button",text:_SM.__language.StatusBar_Text_Task_Button,hidden:true,scope:this,iconCls:"taskManager",handler:this.openTaskForm},"-",{xtype:"splitbutton",text:_SM._UserInfo.fullName||_SM._UserInfo.userName,iconCls:"icon-user",menu:new Ext.menu.Menu({items:[{text:_SM.__language.StatusBar_Text_Close_Session,handler:this.closeSession,iconCls:"icon-logout"}]})}]);this.errBt=this.getComponent("errBt")},command:function(){Ext.MessageBox.prompt("Comando","Digite El Comando",function(a,b){if(a=="ok"){}},this,false,ValorPrompt)},closeSession:function(){Ext.Ajax.request({url:_SM._PConfig.urlLogOut,success:function(a){location.reload(true)},failure:function(){location.reload(true)}})},clearErrCount:function(){this.errBt.tooltip="";this.busyCount=0;this.clearStatus({useDefaults:true})},setStatus:function(g){var d=this;g=g||{};var b=d.isLayoutSuspended();Ext.suspendLayouts();if(Ext.isString(g)){g={text:g}}if(g.text!==undefined){d.setText(g.text)}if(g.iconCls!==undefined){d.setIcon(g.iconCls)}if(g.clear){var h=g.clear,f=d.autoClear,e={useDefaults:true,anim:true};if(Ext.isObject(h)){h=Ext.applyIf(h,e);if(h.wait){f=h.wait}}else{if(Ext.isNumber(h)){f=h;h=e}else{if(Ext.isBoolean(h)){h=e}}}h.threadId=this.activeThreadId;Ext.defer(d.clearStatus,f,d,[h])}Ext.resumeLayouts(true);return d},clearStatus:function(e){e=e||{};var c=this,b=c.statusEl;if(e.threadId&&e.threadId!==c.activeThreadId){return c}var d=e.useDefaults?c.defaultText:c.emptyText,a=e.useDefaults?(c.defaultIconCls?c.defaultIconCls:""):"";if(e.anim){b.el.puff({remove:false,useDisplay:true,callback:function(){b.el.show();c.setStatus({text:d,iconCls:a})}})}else{c.setStatus({text:d,iconCls:a})}return c},setText:function(b){var a=this;a.activeThreadId++;a.text=b||"";if(a.rendered){a.statusEl.setText(a.text)}return a},getText:function(){return this.text},setIcon:function(a){var b=this;b.activeThreadId++;a=a||"";if(b.rendered){if(b.currIconCls){b.statusEl.removeCls(b.currIconCls);b.currIconCls=null}if(a.length>0){b.statusEl.addCls(a);b.currIconCls=a}}else{b.currIconCls=a}return b},showBusyI:function(a){if(Ext.isString(a)){a={text:a}}a=Ext.applyIf(a||{},{text:this.busyText,iconCls:this.busyIconCls});return this.setStatus(a)},showBusy:function(c,b,a){this.showBusyI(c);if(a){Ext.defer(function(){this.clearStatus({useDefaults:true})},a,this)}else{this.busyCount++}},showMessage:function(d,b,a){var c={text:b+" "+d,iconCls:this.iconCls};if(a){Ext.defer(function(){this.clearStatus({useDefaults:true})},a,this)}return this.setStatus(c)},showError:function(b,a){this.setStatus({text:"Oops! "+b,iconCls:"x-status-error",clear:true})},showWarning:function(b,a){this.setStatus({text:b,iconCls:"x-status-warning",clear:true})},clear:function(b,a){this.busyCount--;if(this.busyCount<=0){this.busyCount=0;this.clearStatus({useDefaults:true})}},openTaskForm:function(){var a=Ext.create("ProtoUL.protoOrg.tasks.TaskController");a.openTaskForm()}});Ext.define("Ext.ux.TabCloseMenu",{alias:"plugin.tabclosemenu",mixins:{observable:"Ext.util.Observable"},closeTabText:_SM.__language.Text_Close_Tab,showCloseOthers:true,closeOthersTabsText:_SM.__language.Text_Close_Other_Tabs,showCloseAll:true,closeAllTabsText:_SM.__language.Text_Close_All_Tabs,extraItemsHead:null,extraItemsTail:null,constructor:function(a){this.addEvents("aftermenu","beforemenu");this.mixins.observable.constructor.call(this,a)},init:function(a){this.tabPanel=a;this.tabBar=a.down("tabbar");this.mon(this.tabPanel,{scope:this,afterlayout:this.onAfterLayout,single:true})},onAfterLayout:function(){this.mon(this.tabBar.el,{scope:this,contextmenu:this.onContextMenu,delegate:"div.x-tab"})},onBeforeDestroy:function(){Ext.destroy(this.menu);this.callParent(arguments)},onContextMenu:function(d,f){var c=this,g=c.createMenu(),e=true,h=true,b=c.tabBar.getChildByElement(f),a=c.tabBar.items.indexOf(b);c.item=c.tabPanel.getComponent(a);g.child('*[text="'+c.closeTabText+'"]').setDisabled(!c.item.closable);if(c.showCloseAll||c.showCloseOthers){c.tabPanel.items.each(function(j){if(j.closable){e=false;if(j!=c.item){h=false;return false}}return true});if(c.showCloseAll){g.child('*[text="'+c.closeAllTabsText+'"]').setDisabled(e)}if(c.showCloseOthers){g.child('*[text="'+c.closeOthersTabsText+'"]').setDisabled(h)}}d.preventDefault();c.fireEvent("beforemenu",g,c.item,c);g.showAt(d.getXY())},createMenu:function(){var b=this;if(!b.menu){var a=[{text:b.closeTabText,scope:b,handler:b.onClose}];if(b.showCloseAll||b.showCloseOthers){a.push("-")}if(b.showCloseOthers){a.push({text:b.closeOthersTabsText,scope:b,handler:b.onCloseOthers})}if(b.showCloseAll){a.push({text:b.closeAllTabsText,scope:b,handler:b.onCloseAll})}if(b.extraItemsHead){a=b.extraItemsHead.concat(a)}if(b.extraItemsTail){a=a.concat(b.extraItemsTail)}b.menu=Ext.create("Ext.menu.Menu",{items:a,listeners:{hide:b.onHideMenu,scope:b}})}return b.menu},onHideMenu:function(){var a=this;a.item=null;a.fireEvent("aftermenu",a.menu,a)},onClose:function(){this.tabPanel.remove(this.item)},onCloseOthers:function(){this.doClose(true)},onCloseAll:function(){this.doClose(false)},doClose:function(b){var a=[];this.tabPanel.items.each(function(c){if(c.closable){if(!b||c!=this.item){a.push(c)}}},this);Ext.each(a,function(c){this.tabPanel.remove(c)},this)}});Ext.define("Ext.ux.TabScrollerMenu",{alias:"plugin.tabscrollermenu",uses:["Ext.menu.Menu"],pageSize:10,maxText:15,menuPrefixText:"Items",constructor:function(a){a=a||{};Ext.apply(this,a)},init:function(b){var a=this;Ext.apply(b,a.parentOverrides);a.tabPanel=b;b.on({render:function(){a.tabBar=b.tabBar;a.layout=a.tabBar.layout;a.layout.overflowHandler.handleOverflow=Ext.Function.bind(a.showButton,a);a.layout.overflowHandler.clearOverflow=Ext.Function.createSequence(a.layout.overflowHandler.clearOverflow,a.hideButton,a)},single:true})},showButton:function(){var b=this,a=Ext.getClass(b.layout.overflowHandler).prototype.handleOverflow.apply(b.layout.overflowHandler,arguments);if(!b.menuButton){b.menuButton=b.tabBar.body.createChild({cls:Ext.baseCSSPrefix+"tab-tabmenu-right"},b.tabBar.body.child("."+Ext.baseCSSPrefix+"box-scroller-right"));b.menuButton.addClsOnOver(Ext.baseCSSPrefix+"tab-tabmenu-over");b.menuButton.on("click",b.showTabsMenu,b)}b.menuButton.show();a.reservedSpace+=b.menuButton.getWidth();return a},hideButton:function(){var a=this;if(a.menuButton){a.menuButton.hide()}},getPageSize:function(){return this.pageSize},setPageSize:function(a){this.pageSize=a},getMaxText:function(){return this.maxText},setMaxText:function(a){this.maxText=a},getMenuPrefixText:function(){return this.menuPrefixText},setMenuPrefixText:function(a){this.menuPrefixText=a},showTabsMenu:function(d){var a=this;if(a.tabsMenu){a.tabsMenu.removeAll()}else{a.tabsMenu=Ext.create("Ext.menu.Menu");a.tabPanel.on("destroy",a.tabsMenu.destroy,a.tabsMenu)}a.generateTabMenuItems();var c=Ext.get(d.getTarget());var b=c.getXY();b[1]+=24;a.tabsMenu.showAt(b)},generateTabMenuItems:function(){var j=this,g=j.tabPanel,a=g.getActiveTab(),o=g.items.getCount(),k=j.getPageSize(),d=Math.floor(o/k),m=o%k,e,h,b,l,n,c,f;if(o>k){for(e=0;e<d;e++){h=(e+1)*k;b=[];for(l=0;l<k;l++){f=l+h-k;n=g.items.get(f);b.push(j.autoGenMenuItem(n))}j.tabsMenu.add({text:j.getMenuPrefixText()+" "+(h-k+1)+" - "+h,menu:b})}if(m>0){c=d*k;b=[];for(e=c;e<o;e++){n=g.items.get(e);b.push(j.autoGenMenuItem(n))}j.tabsMenu.add({text:j.menuPrefixText+" "+(c+1)+" - "+(c+b.length),menu:b})}}else{g.items.each(function(p){if(p.id!=a.id&&!p.hidden){j.tabsMenu.add(j.autoGenMenuItem(p))}})}},autoGenMenuItem:function(b){var a=this.getMaxText(),c=Ext.util.Format.ellipsis(b.title,a);return{text:c,handler:this.showTabFromMenu,scope:this,disabled:b.disabled,tabToShow:b,iconCls:b.iconCls}},showTabFromMenu:function(a){this.tabPanel.setActiveTab(a.tabToShow)}});Ext.define("Ext.ux.statusbar.ValidationStatus",{extend:"Ext.Component",requires:["Ext.util.MixedCollection"],errorIconCls:"x-status-error",errorListCls:"x-status-error-list",validIconCls:"x-status-valid",showText:_SM.__language.Text_Validation_Form,hideText:_SM.__language.Text_Hide_Errors_Validation_Form,submitText:_SM.__language.Text_Submit_Validation_Form,init:function(a){a.on("render",function(){this.statusBar=a;this.monitor=true;this.errors=Ext.create("Ext.util.MixedCollection");this.listAlign=(a.statusAlign==="right"?"br-tr?":"bl-tl?");if(this.form){this.formPanel=Ext.getCmp(this.form);this.basicForm=this.formPanel.getForm();this.startMonitoring();this.basicForm.on("beforeaction",function(d,c){if(c.type==="submit"){this.monitor=false}},this);var b=function(){this.monitor=true};this.basicForm.on("actioncomplete",b,this);this.basicForm.on("actionfailed",b,this)}},this,{single:true});a.on({scope:this,afterlayout:{single:true,fn:function(){a.statusEl.getEl().on("click",this.onStatusClick,this,{buffer:200})}},beforedestroy:{single:true,fn:this.onDestroy}})},startMonitoring:function(){this.basicForm.getFields().each(function(a){a.on("validitychange",this.onFieldValidation,this)},this)},stopMonitoring:function(){this.basicForm.getFields().each(function(a){a.un("validitychange",this.onFieldValidation,this)},this)},onDestroy:function(){this.stopMonitoring();this.statusBar.statusEl.un("click",this.onStatusClick,this);this.callParent(arguments)},onFieldValidation:function(a,b){if(!this.monitor){return false}var c=a.getErrors()[0];if(c){this.errors.add(a.id,{field:a,msg:c})}else{this.errors.removeAtKey(a.id)}this.updateErrorList();if(this.errors.getCount()>0){if(this.statusBar.getText()!==this.showText){this.statusBar.setStatus({text:this.showText,iconCls:this.errorIconCls})}}else{this.statusBar.clearStatus().setIcon(this.validIconCls)}},updateErrorList:function(){if(this.errors.getCount()>0){var a="<ul>";this.errors.each(function(b){a+=('<li id="x-err-'+b.field.id+'"><a href="#">'+b.msg+"</a></li>")},this);this.getMsgEl().update(a+"</ul>")}else{this.getMsgEl().update("")}this.getMsgEl().setSize("auto","auto")},getMsgEl:function(){if(!this.msgEl){this.msgEl=Ext.DomHelper.append(Ext.getBody(),{cls:this.errorListCls},true);this.msgEl.hide();this.msgEl.on("click",function(b){var a=b.getTarget("li",10,true);if(a){Ext.getCmp(a.id.split("x-err-")[1]).focus();this.hideErrors()}},this,{stopEvent:true})}return this.msgEl},showErrors:function(){this.updateErrorList();this.getMsgEl().alignTo(this.statusBar.getEl(),this.listAlign).slideIn("b",{duration:300,easing:"easeOut"});this.statusBar.setText(this.hideText);this.formPanel.el.on("click",this.hideErrors,this,{single:true})},hideErrors:function(){var a=this.getMsgEl();if(a.isVisible()){a.slideOut("b",{duration:300,easing:"easeIn"});this.statusBar.setText(this.showText)}this.formPanel.el.un("click",this.hideErrors,this)},onStatusClick:function(){if(this.getMsgEl().isVisible()){this.hideErrors()}else{if(this.errors.getCount()>0){this.showErrors()}}}});Ext.define("Ext.ux.BoxReorderer",{mixins:{observable:"Ext.util.Observable"},itemSelector:".x-box-item",animate:100,constructor:function(){this.addEvents("StartDrag","Drag","ChangeIndex","Drop");this.mixins.observable.constructor.apply(this,arguments)},init:function(a){var b=this;b.container=a;b.animatePolicy={};b.animatePolicy[a.getLayout().names.x]=true;b.container.on({scope:b,boxready:b.afterFirstLayout,beforedestroy:b.onContainerDestroy})},onContainerDestroy:function(){var a=this.dd;if(a){a.unreg();this.dd=null}},afterFirstLayout:function(){var c=this,b=c.container.getLayout(),d=b.names,a;a=c.dd=Ext.create("Ext.dd.DD",b.innerCt,c.container.id+"-reorderer");Ext.apply(a,{animate:c.animate,reorderer:c,container:c.container,getDragCmp:this.getDragCmp,clickValidator:Ext.Function.createInterceptor(a.clickValidator,c.clickValidator,c,false),onMouseDown:c.onMouseDown,startDrag:c.startDrag,onDrag:c.onDrag,endDrag:c.endDrag,getNewIndex:c.getNewIndex,doSwap:c.doSwap,findReorderable:c.findReorderable});a.dim=d.width;a.startAttr=d.beforeX;a.endAttr=d.afterX},getDragCmp:function(a){return this.container.getChildByElement(a.getTarget(this.itemSelector,10))},clickValidator:function(b){var a=this.getDragCmp(b);return !!(a&&a.reorderable!==false)},onMouseDown:function(g){var f=this,a=f.container,d,b,c;f.dragCmp=f.getDragCmp(g);if(f.dragCmp){b=f.dragCmp.getEl();f.startIndex=f.curIndex=a.items.indexOf(f.dragCmp);c=b.getBox();f.lastPos=c[this.startAttr];d=a.el.getBox();if(f.dim==="width"){f.minX=d.left;f.maxX=d.right-c.width;f.minY=f.maxY=c.top;f.deltaX=g.getPageX()-c.left}else{f.minY=d.top;f.maxY=d.bottom-c.height;f.minX=f.maxX=c.left;f.deltaY=g.getPageY()-c.top}f.constrainY=f.constrainX=true}},startDrag:function(){var b=this,a=b.dragCmp;if(a){a.setPosition=Ext.emptyFn;a.animate=false;if(b.animate){b.container.getLayout().animatePolicy=b.reorderer.animatePolicy}b.dragElId=a.getEl().id;b.reorderer.fireEvent("StartDrag",b,b.container,a,b.curIndex);a.suspendEvents();a.disabled=true;a.el.setStyle("zIndex",100)}else{b.dragElId=null}},findReorderable:function(c){var d=this,a=d.container.items,b;if(a.getAt(c).reorderable===false){b=a.getAt(c);if(c>d.startIndex){while(b&&b.reorderable===false){c++;b=a.getAt(c)}}else{while(b&&b.reorderable===false){c--;b=a.getAt(c)}}}c=Math.min(Math.max(c,0),a.getCount()-1);if(a.getAt(c).reorderable===false){return -1}return c},doSwap:function(g){var d=this,c=d.container.items,a=d.container,b=d.container._isLayoutRoot,e,f,j,h;g=d.findReorderable(g);if(g===-1){return}d.reorderer.fireEvent("ChangeIndex",d,a,d.dragCmp,d.startIndex,g);e=c.getAt(d.curIndex);f=c.getAt(g);c.remove(e);j=Math.min(Math.max(g,0),c.getCount()-1);c.insert(j,e);c.remove(f);c.insert(d.curIndex,f);a._isLayoutRoot=true;a.updateLayout();a._isLayoutRoot=b;d.curIndex=g},onDrag:function(c){var b=this,a;a=b.getNewIndex(c.getPoint());if((a!==undefined)){b.reorderer.fireEvent("Drag",b,b.container,b.dragCmp,b.startIndex,b.curIndex);b.doSwap(a)}},endDrag:function(d){if(d){d.stopEvent()}var c=this,b=c.container.getLayout(),a;if(c.dragCmp){delete c.dragElId;delete c.dragCmp.setPosition;c.dragCmp.animate=true;c.dragCmp.lastBox[b.names.x]=c.dragCmp.getPosition(true)[b.names.widthIndex];c.container._isLayoutRoot=true;c.container.updateLayout();c.container._isLayoutRoot=undefined;a=Ext.fx.Manager.getFxQueue(c.dragCmp.el.id)[0];if(a){a.on({afteranimate:c.reorderer.afterBoxReflow,scope:c})}else{Ext.Function.defer(c.reorderer.afterBoxReflow,1,c)}if(c.animate){delete b.animatePolicy}c.reorderer.fireEvent("drop",c,c.container,c.dragCmp,c.startIndex,c.curIndex)}},afterBoxReflow:function(){var a=this;a.dragCmp.el.setStyle("zIndex","");a.dragCmp.disabled=false;a.dragCmp.resumeEvents()},getNewIndex:function(h){var g=this,a=g.getDragEl(),b=Ext.fly(a).getBox(),l,f,k,d=0,c=g.container.items.items,e=c.length,j=g.lastPos;g.lastPos=b[g.startAttr];for(;d<e;d++){l=c[d].getEl();if(l.is(g.reorderer.itemSelector)){f=l.getBox();k=f[g.startAttr]+(f[g.dim]>>1);if(d<g.curIndex){if((b[g.startAttr]<j)&&(b[g.startAttr]<(k-5))){return d}}else{if(d>g.curIndex){if((b[g.startAttr]>j)&&(b[g.endAttr]>(k+5))){return d}}}}}}});Ext.define("Ext.ux.ToolbarDroppable",{constructor:function(a){Ext.apply(this,a)},init:function(a){this.toolbar=a;this.toolbar.on({scope:this,render:this.createDropTarget})},createDropTarget:function(){this.dropTarget=Ext.create("Ext.dd.DropTarget",this.toolbar.getEl(),{notifyOver:Ext.Function.bind(this.notifyOver,this),notifyDrop:Ext.Function.bind(this.notifyDrop,this)})},addDDGroup:function(a){this.dropTarget.addToGroup(a)},calculateEntryIndex:function(h){var k=0,l=this.toolbar,j=l.items.items,f=j.length,b=h.getXY()[0],g=0,c,d,a,m;for(;g<f;g++){c=j[g].getEl();d=c.getXY()[0];a=c.getWidth();m=d+a/2;if(b<m){k=g;break}else{k=g+1}}return k},canDrop:function(a){return true},notifyOver:function(a,b,c){return this.canDrop.apply(this,arguments)?this.dropTarget.dropAllowed:this.dropTarget.dropNotAllowed},notifyDrop:function(a,d,e){var c=this.canDrop(a,d,e),f=this.toolbar;if(c){var b=this.calculateEntryIndex(d);f.insert(b,this.createItem(e));f.doLayout();this.afterLayout()}return c},createItem:function(a){Ext.Error.raise("The createItem method must be implemented in the ToolbarDroppable plugin")},afterLayout:Ext.emptyFn});Ext.define("ProtoUL.view.MenuTree",{extend:"Ext.tree.Panel",alias:"widget.menuTree",viewConfig:{plugins:{ptype:"treeviewdragdrop",dragText:"Drag to reorder",ddGroup:"menu"}},rootVisible:false,lines:true,minWidth:200,initComponent:function(){Ext.define("Proto.MenuModel",{extend:"Ext.data.Model",proxy:{type:"ajax",url:_SM._PConfig.urlMenu,extraParams:{forceDefault:0},actionMethods:{read:"POST"}},fields:[{name:"id",type:"string"},{name:"viewCode",type:"string"},{name:"text",type:"string"},{name:"leaf",type:"boolean"}]});this.store=Ext.create("Ext.data.TreeStore",{autoLoad:true,model:"Proto.MenuModel",root:{text:"menu",expanded:true},listeners:{datachanged:function(a,b){this.treeRecord=undefined}}});if(_SM._UserInfo.isStaff){Ext.apply(this,{dockedItems:[{xtype:"toolbar",dock:"bottom",items:[{id:"newFolder",scope:this,handler:this.newFolder,iconCls:"menu_new_folder",tooltip:_SM.__language.Tooltip_New_Folder},{id:"newOption",hidden:true,scope:this,handler:this.newOption,iconCls:"menu_new_option",tooltip:_SM.__language.Tooltip_New_Option},{id:"editNode",scope:this,handler:this.editNode,iconCls:"icon-nodeEdit",tooltip:_SM.__language.Tooltip_Edit_Node},{id:"deleteNode",scope:this,handler:this.deleteNode,iconCls:"icon-nodeDelete",tooltip:_SM.__language.Tooltip_Del_Node},"->",{id:"saveMenu",scope:this,handler:this.saveMenu,iconCls:"menu_save",tooltip:_SM.__language.Tooltip_Save_Menu},{id:"reloadMenu",scope:this,handler:this.reloadMenu,iconCls:"menu_reload",tooltip:_SM.__language.Tooltip_Reload_Menu},{id:"resetMenu",scope:this,handler:this.resetMenu,iconCls:"menu_reset",tooltip:_SM.__language.Tooltip_Reset_Menu}]}]})}this.callParent(arguments);this.addEvents("menuSelect");if(_SM._UserInfo.isSuperUser){Ext.getCmp("newOption").show()}},listeners:{itemclick:function(a,f,e,c,b,d){this.treeRecord=f},itemdblclick:function(b,g,f,d,c,e){this.treeRecord=g;if(g.get("leaf")){var a=g.data.viewCode||g.data.id;this.fireEvent("menuSelect",this,a);this.ownerCt.loadPciFromMenu(a)}}},editNode:function(a){if(this.treeRecord){var b=this,c=_SM.__language.Msg_Window_New_Folder;Ext.Msg.prompt(_SM.__language.Title_Window_New_Folder,c,function(e,d){if((e!="ok")||(!d)||(d.length==0)){return}b.treeRecord.set("text",d)},b,false,b.treeRecord.get("text"))}},deleteNode:function(a){if(this.treeRecord){this.treeRecord.remove();this.treeRecord=undefined}},newFolder:function(a){var b=this,c=_SM.__language.Msg_Window_New_Folder;Ext.Msg.prompt(_SM.__language.Title_Window_New_Folder,c,function(f,e){if(f!="ok"){return}var g={text:e,children:[]},d;if(b.treeRecord&&(!b.treeRecord.get("leaf"))){d=b.treeRecord}else{d=b.store.getRootNode()}d.appendChild(g)},b,false)},newOption:function(a){if(!this.treeRecord||this.treeRecord.get("leaf")){_SM.errorMessage("AddMenuOption",_SM.__language.Msg_Select_Folder);return}var b=Ext.widget("menuOption",{treeRecord:this.treeRecord,title:_SM.__language.Title_Window_Add_Option});b.show()},reloadMenu:function(a){this.store.getProxy().extraParams.forceDefault=0;this.store.load()},resetMenu:function(a){this.store.getProxy().extraParams.forceDefault=1;this.store.load()},saveMenu:function(b){var a=Ext.encode(c(this.store.getRootNode()));_SM.saveProtoObj("__menu",a);function c(f){var g=f.data,e=f.childNodes,h={};if(g.root){h=d(e)}else{h={text:g.text,qtip:g.qtip,qtitle:g.qtitle,iconCls:g.iconCls,id:"protoMenu-"+Ext.id(),index:g.index};if(e.length>0){h.expanded=g.expanded;h.children=d(e);h.leaf=false;h.viewCode=g.viewCode||g.id}else{h.expanded=false;h.children=[];h.leaf=g.leaf;h.viewCode=g.viewCode||g.id}}if(!h.text||h.text.length==0){h.text="null"}return h;function d(l){var m=[];for(var j in l){var k=l[j];var n=c(k);m.push(n)}return m}}}});Ext.define("ProtoUL.view.form.MenuOption",{extend:"Ext.window.Window",alias:"widget.menuOption",constructor:function(b){var a={xtype:"form",frame:true,constrain:true,bodyPadding:"5 5 0",width:400,fieldDefaults:{msgTarget:"side",labelWidth:75},defaults:{anchor:"100%"},items:[{xtype:"fieldset",title:_SM.__language.MenuTree_Title_Fieldset,defaultType:"textfield",layout:"anchor",defaults:{anchor:"100%"},items:[{fieldLabel:"text",afterLabelTextTpl:_SM._requiredField,name:"text",allowBlank:false},{fieldLabel:"option",afterLabelTextTpl:_SM._requiredField,name:"viewCode",allowBlank:false,__ptType:"formField",editable:true,xtype:"protoZoom",zoomModel:"protoLib.ProtoDefinition"}]},{xtype:"fieldset",defaultType:"textfield",layout:"anchor",defaults:{anchor:"100%"},items:[{fieldLabel:"iconCls",name:"iconCls"},{fieldLabel:"qtip",name:"qtip"},{fieldLabel:"qtitle",name:"qtitle"}]}],buttons:[{text:_SM.__language.Text_Cancel_Button,scope:this,handler:this.onCancel},{text:_SM.__language.Text_Save_Button,scope:this,handler:this.onSave}]};this.callParent([Ext.apply({titleTextAdd:_SM.__language.MenuTree_Text_Add_Event,titleTextEdit:_SM.__language.MenuTree_Text_Edit_Event,width:600,autocreate:true,border:true,closeAction:"hide",modal:false,resizable:false,buttonAlign:"left",savingMessage:_SM.__language.Msg_Saved,deletingMessage:_SM.__language.Msg_Deleted_Event,layout:"fit",items:a},b)])},initComponent:function(){this.callParent();this.formPanel=this.items.items[0]},onCancel:function(){this.close()},onSave:function(){if(!this.formPanel.form.isValid()){return}var a=this.formPanel.getForm().getValues();a.leaf=true;this.treeRecord.appendChild(a);this.close()}});Ext.define("ProtoUL.view.ProtoForm",{extend:"Ext.form.Panel",alias:"widget.protoform",requires:["Ext.form.field.Text","Ext.form.*","Ext.data.*","Ext.tip.QuickTipManager"],myMeta:null,newForm:false,formConfig:null,prFormLayout:[],idMaster:-1,masterRecord:null,masterDetail:false,isReadOnly:false,store:null,cllDetails:[],htmlPanels:{},zoomReturnDef:null,zoomMultiReturn:[],initComponent:function(){this.addEvents("create","close","hide");var b=this;var d=this.myMeta;var e=this;this.btSave=Ext.create("Ext.Button",{iconCls:"icon-saveMs",text:_SM.__language.Text_SaveMs_Button,scope:this,handler:this.onSave});this.btSaveDet=Ext.create("Ext.Button",{iconCls:"icon-saveDt",text:_SM.__language.Text_SaveDt_Button,hidden:true,disabled:true,scope:this,handler:this.onSaveDet});this.btCancelFormEdt=Ext.create("Ext.Button",{iconCls:"icon-cancel",text:_SM.__language.Text_Cancel_Button,scope:this,handler:this.onReset});this.stMsg=Ext.create("Ext.toolbar.TextItem");Ext.apply(this,{frame:true,autoScroll:true,bodyStyle:"padding:5px 5px",bodyPadding:10,masterRecord:null,items:this.prFormLayout,dockedItems:[{xtype:"toolbar",dock:"bottom",ui:"footer",items:[this.stMsg,"->",this.btSave,this.btSaveDet,this.btCancelFormEdt]}]});this.callParent();this.getHtmlPanels();this.cllDetails=c(this.items.items,b);if(this.cllDetails.length>0){this.masterDetail=true;this.btSaveDet.show();a(b)}this.doLayout();function c(h,j){var g=[];for(var k in h){var f=h[k];if(f.__ptType=="protoGrid"){if(f.myMeta){g.push(f)}}else{if(f.items&&f.items.items){g=g.concat(c(f.items.items,j))}}}return g}function a(j){for(var f in j.cllDetails){var k=j.cllDetails[f];for(var g in j.myMeta.detailsConfig){var h=j.myMeta.detailsConfig[g];if(k.viewCode==h.conceptDetail){k.detailDefinition=h}}}}},setDetailsTilte:function(){for(var b in this.cllDetails){var a=this.cllDetails[b];a.embededGrid=true;a.setGridTitle(a)}},showProtoForm:function(){_SM.showConfig("Form Config",this.myMeta.formConfig)},showLayoutConfig:function(){_SM.showConfig("LayoutConfig",this.prFormLayout)},updateHtmlPanels:function(b){var d;for(var a in this.htmlPanels){var c=this.htmlPanels[a];if(b){d=b.get(a)}else{d=""}c.update(d);c.rawHtml=d}},readHtmlPanels:function(b){for(var a in this.htmlPanels){var c=this.htmlPanels[a];b.set(a,c.rawHtml)}},setText:function(a){this.stMsg.setText(a)},onReset:function(){this.idMaster=null;this.fireEvent("close",this)},updateZoomIds:function(){var c=this,b=c.getForm().getFields().items;c.zoomMultiReturn=null;for(var a in b){var d=b[a];if(!d.zoomModel){continue}if(d.zoomMultiple&&c.newForm){if(!c.zoomMultiReturn){c.zoomMultiReturn=[]}c.zoomMultiReturn.push(d.zoomRecords)}else{if(d.zoomRecord){d.fkIdValue=this.masterRecord.get(d.fkId);c.updateFormField(d.fkId,d.zoomRecord.data.id)}}}},updateFormField:function(b,c){var a={};a[b]=c;this.getForm().setValues(a);var a=this.masterRecord;a.data[b]=c;if(!a.modified[b]){a.modified[b]=a.data[b]}},onCreate:function(){var a=this.getForm();if(a.isValid()){this.fireEvent("create",this,a.getValues());a.reset()}},setFormReadOnly:function(a){this.isReadOnly=a;this.btSave.setDisabled(a);this.btSaveDet.setDisabled(a);this.btCancelFormEdt.setDisabled(a);this.setReadOnlyFields(a);this.setDetailsReadOnly(a)},setDetailsReadOnly:function(b){for(var c in this.cllDetails){var a=this.cllDetails[c];a.setEditMode(!b)}},setReadOnlyFields:function(a,f){var c=this.getForm().getFields();for(var b in c.items){var e=c.items[b];if(e.readOnly){e.setReadOnly(true)}else{if(!f||(e.name in _SM.objConv(f))){e.setReadOnly(a)}}}for(var b in this.htmlPanels){var e=this.htmlPanels[b];var d=e.__ptConfig;if(d.readOnly){e.setReadOnly(true)}else{if(!f||(d.name in _SM.objConv(f))){e.setReadOnly(a)}}}},getHtmlPanels:function(){a(this.items.items,this);function a(c,d){for(var b in c){var e=c[b];if(e.xtype=="htmlset"){Ext.apply(d.htmlPanels,e.htmlPanels)}else{if(e.xtype=="fieldset"){a(e.items.items,d)}}}}},setActiveRecord:function(a){var b=this;this.masterRecord=a;this.store=a.store;if(a&&!a.phantom){this.idMaster=a.get("id")}if(a){this.getForm().loadRecord(a)}else{this.getForm().reset()}this.linkDetail(a);this.updateHtmlPanels(a);this.store.on({update:function(e,c,d,f){if(c&&this.masterDetail){this.idMaster=c.get("id");this.myFormController.newForm=false;this.linkDetail(c);this.setDetailsReadOnly(false)}},scope:b})},linkDetail:function(b){if(!this.masterDetail){return}for(var e in this.cllDetails){var a=this.cllDetails[e];var d=a.detailDefinition.detailField,f={};var c=[{property:d,filterStmt:this.idMaster}];a.store.myLoadData(c,null,this.idMaster);if(this.idMaster>=0&&(!this.isReadOnly)){a.setEditMode(!this.isReadOnly);g(this,a,b)}}function g(n,p,k){var j=p.detailDefinition;var m=j.detailField.replace(/__pk$/,"_id");var h=p.myFieldDict[m];if(!h){_SM.__StBar.showError("parent key not found: "+m,"MasterDetail");p.setEditMode(false);return}h.prpDefault=n.idMaster;m=j.masterTitleField||m.replace(/_id$/,"");var l=p.myFieldDict[m];if(l&&k){var o=j.masterTitleField||"__str__";l.prpDefault=k.get(o);l.readOnly=true;p.detailTitle=l.prpDefault;p.setGridTitle(p)}}},_doSyncMasterStore:function(){this.store.sync({success:function(a,d){var c=a.operations[0].response;var b=Ext.decode(c.responseText);if(b.message){_SM.errorMessage(_SM.__language.Msg_Error_Save_Form,b.message)}else{}},failure:function(a,b){_SM.errorMessage(_SM.__language.Msg_Error_Save_Form,_SM.__language.Msg_Failed_Operation)}})},onSaveDet:function(){this.onSave();this.fireEvent("close",this)},onSave:function(){var g=this,h=g.store.autoSync,b=g.getForm();g.updateZoomIds();if(!b.isValid()){g.setText(_SM.__language.Msg_Invalid_Form);return}if(!g.masterRecord){return}b.updateRecord(g.masterRecord);g.readHtmlPanels(g.masterRecord);if(g.myFormController.newForm){if(!g.zoomMultiReturn){g.store.add(g.masterRecord)}else{g.store.autoSync=false;var e=_SM.Product(g.zoomMultiReturn);for(var f in e){var a=e[f],d=g.masterRecord.copy();for(var c in a){var j=a[c];d.data[j.name]=j.recStr;d.data[j.fkId]=j.recId}g.store.add(d)}}}if(g.store.autoSync!==true){g._doSyncMasterStore()}g.store.autoSync=h;if(g.masterDetail){g.btSave.setDisabled(true);g.btSaveDet.setDisabled(false)}else{g.fireEvent("close",g)}},setZoomEditMode:function(c){var b=c.getForm().getFields().items;for(var a in b){if(b[a].xtype="protoZoom"){b[a].newForm=c.newForm}}}});Ext.define("ProtoUL.view.ProtoGrid",{extend:"Ext.Panel",alias:"widget.protoGrid",requires:["Ext.grid.*","Ext.data.*","Ext.util.*","Ext.state.*","Ext.form.*","Ext.selection.CheckboxModel","Ext.toolbar.TextItem"],height:200,viewCode:null,myMeta:null,selModel:null,rowData:null,isDetail:false,isPromoted:false,mdFilter:[],initialFilter:null,embededGrid:false,colDictDefinition:{},colSetName:"",colSetDefinition:[],colSetCache:{},autoEdit:true,editable:true,initComponent:function(){var o=this;if(!_SM.loadPci(this.viewCode,false)){Ext.apply(this,{title:this.viewCode+" Not found!"});this.callParent(arguments);_SM.errorMessage("initGrid",this.viewCode+" not found!!");return}var b=_SM.clone(_SM._cllPCI[this.viewCode]);this.myMeta=b;this.myMeta.idProtoGrid=this.id;this.myFieldDict=_SM.getFieldDict(b);var n=[];var f=[];if(this.isDetail){n=b.gridConfig.baseFilter;f=[{property:this.detailDefinition.detailField,filterStmt:-1}]}else{if(this.isPromoted){n=b.gridConfig.baseFilter;n=n.concat(this.mdFilter)}else{n=b.gridConfig.baseFilter;f=this.initialFilter||b.gridConfig.initialFilter}}var j={viewCode:this.viewCode,autoLoad:this.autoLoad||true,pageSize:b.pageSize||_SM._PAGESIZE,localSort:b.localSort,baseFilter:n,protoFilter:f,sorters:b.gridConfig.initialSort,sProtoMeta:_SM.getSafeMeta(b)};if(o.detailDefinition){b.pciStyle="grid";var p=o.detailDefinition.detailField.replace(/__pk$/,"_id");var h=o.myFieldDict[p];var c=p;if(h){c=o.detailDefinition.masterTitleField||h.fkField}}k();var e,d;d=_SM.defineTabConfig(b.gridConfig);if(b.custom.listDisplay.length>0){d.listDisplay=b.custom.listDisplay}e=this.getViewColumns(d);if(!this.gridSelectionMode){this.gridSelectionMode=b.gridConfig.gridSelectionMode||"multi"}var g="last";if(this.gridSelectionMode!="multi"){g=false}this.selModel=Ext.create("Ext.selection.CheckboxModel",{injectCheckbox:g,mode:this.gridSelectionMode});this.editable=this.autoEdit;var a;if(b.pciStyle=="tree"){}else{o.store=_SM.getStoreDefinition(j);a=Ext.create("Ext.grid.Panel",{border:false,region:"center",flex:1,layout:"fit",minSize:50,plugins:["headertooltip"],selModel:this.selModel,columns:e,store:this.store,stripeRows:true,tools:[],viewConfig:{listeners:{cellclick:function(z,A,x,t,B,y,w){var u=(w.target.tagName=="A");var r=z.panel.headerCt.getHeaderAtIndex(x).dataIndex;if(u&&r){var q=o.myFieldDict[r];if(!q){return}if(q.zoomModel&&q.fkId){if((q.zoomModel==o.myMeta.viewEntity)&&(q.fkId=o.myMeta.idProperty)){var s=Ext.create("ProtoUL.UI.FormController",{myMeta:o.myMeta});s.openLinkedForm.call(s,o.selected,!o.editable)}else{var s=Ext.create("ProtoUL.UI.FormController",{});s.openProtoForm.call(s,q.zoomModel,t.get(q.fkId),false)}}else{if(q.zoomModel=="@cellValue"){var v=t.get(q.name);_SM._mainWin.loadPciFromMenu(v)}else{_SM.errorMessage("LinkedForm definition error : "+r,"zoomModel : "+q.zoomModel+"<br>fkId : "+q.fkId)}}}}},getRowClass:function(q,u,s,r){var t=q.get("_ptStatus");if(t){if(t===_SM._ROW_ST.NEWROW){return t}else{if(t===_SM._ROW_ST.REFONLY){return""}else{return _SM._ROW_ST.ERROR}}}else{return""}}}})}this._extGrid=a;this.setGridTitle(this);if(this.gridController){this.gridController.myGrid=this;this.gridController.store=this.store}else{this.gridController=Ext.create("ProtoUL.UI.GridController",{myMeta:b,myGrid:this,store:this.store})}this.gridController.addGridTools(this.autoEdit);this.sheetCrl=Ext.create("ProtoUL.UI.GridSheetController",{myGrid:this});var m=[a];var l=this.sheetCrl.getSheetConfig();if(l){m.push(l)}Ext.apply(this,{layout:"border",border:false,defaults:{collapsible:false,split:false},items:m});this.addEvents("selectionChange","rowDblClick","promoteDetail","startEdition");this.callParent(arguments);this.gridController.addNavigationPanel();a.on({selectionchange:{fn:function(q,s,r){this.selected=s[0]||null;if(this.selected){o.rowData=this.selected.data;o.fireSelectionChange(q,this.selected,this.selected.index+1,r)}else{o.rowData=null;o.fireSelectionChange(q,null,null,r)}},scope:this},itemmouseenter:{fn:function(r,q,s){var t=q.get("_ptStatus");if(t==_SM._ROW_ST.NEWROW||t==_SM._ROW_ST.REFONLY){t=""}Ext.fly(s).set({"data-qtip":t})},scope:this},celldblclick:{fn:function(w,t,r,q,u,x,v,s){if(o.editable){return}o.fireEvent("rowDblClick",q,x)},scope:o}});function k(){var s,q,r;for(q in b.fields){r=b.fields[q];if(r.crudType=="storeOnly"){continue}s=_SM.getColDefinition(r);if(s.dataIndex in _SM.objConv([p,c])){s.readOnly=true;delete s.editor}o.colDictDefinition[s.dataIndex]=s}s={xtype:"rownumberer",width:37,draggable:false,sortable:false};o.colDictDefinition.___numberCol=s}},fireSelectionChange:function(e,a,d,c){this.fireEvent("selectionChange",e,a,d,c);var b=_SM._UserInfo.perms[this.myMeta.viewCode];if(this.editable&&a&&b.refallow){this.verifyEdition(a,b)}if(this.IdeSheet){this.sheetCrl.prepareSheet()}},verifyEdition:function(b,c){var e=this,d=b.get("_ptStatus"),a=(d&&d===_SM._ROW_ST.REFONLY);e.gridController.setEditToolBar(e.editable,!a,c)},fireStartEdition:function(a){},getSelectedIds:function(){var c=[],b,a;if(!this.selected){return c}if(!this.selModel){return[this.selected.get("id")]}a=this.selModel.getSelection();for(b in a){c.push(a[b].get("id"))}return c},getViewColumns:function(c){if(this.colSetName==c.name){return this.colSetDefinition}this.colSetName=c.name;this.colSetDefinition=[];var d,a,b;if(!c.hideRowNumbers){d=this.colDictDefinition.___numberCol;this.colSetDefinition.push(d)}for(b in c.listDisplay){a=c.listDisplay[b];d=this.colDictDefinition[a];if(d){this.colSetDefinition.push(d)}}return this.colSetDefinition},configureColumns:function(g){if(this.colSetName==g.name){return this.colSetDefinition}var a=this.getViewColumns(g);this._extGrid.view.refresh();var f=this._extGrid.headerCt,d=f.items.items.slice(),c=d.length-1,e,b;this.suspendLayouts();for(b=0;b<c;b++){e=d[b];f.remove(e,true)}f.add(0,a);this.resumeLayouts(true);this._extGrid.view.refresh()},setGridTitle:function(b){var a="";if(b.detailTitle){a='" '+b.detailTitle+' "'}else{if(b.mdFilter!==undefined){a=Ext.encode(b.mdFilter)}}if(b.filterTitle){if(a){a+=" ; "}a+=b.filterTitle}if(a){a="; filtrage par "+a+""}if(b.embededGrid){a=""}a=b.myMeta.shortTitle+a;b._extGrid.setTitle(a)},addNewRecord:function(a){if(!(this.editable||a)){return}this.insertNewRecord(_SM.getNewRecord(this.myMeta,this.store))},duplicateRecord:function(){if((!this._extGrid)||(!this.editable)){return}var a=this.selected;if(a){this.insertNewRecord(a.copy())}},insertNewRecord:function(a){a.data._ptStatus=_SM._ROW_ST.NEWROW;a.data._ptId=a.get("id");a.data.id=undefined;a.phantom=true;this.store.insert(0,a);var b=this._extGrid.getSelectionModel();b.select(0)},getRowIndex:function(){var b=this._extGrid.getSelectionModel(),a=this.store.indexOf(b.getSelection()[0]);if(a<0){a=0}return a},deleteCurrentRecord:function(){if((!this._extGrid)||(!this.editable)){return}var b=this.getRowIndex();var a=this._extGrid.getSelectionModel();this.store.remove(a.getSelection());if(this.store.getCount()<=b){b=0}if(this.store.getCount()>0){a.select(b)}},setEditMode:function(a){this.store.editMode=a;this.gridController.setEditMode(a)},saveChanges:function(a){this.store.sync();if(a!==undefined){this.store.autoSync=a}},reload:function(){this.store.load()},cancelChanges:function(){this.store.load()},gridLoadData:function(a,b,c){a.store.myLoadData(b,c);if(a.store.currentPage!=1){a.store.loadPage(1)}},addTools:function(a){if(typeof a!=="undefined"){this._extGrid.addTool(a)}}});Ext.define("ProtoUL.view.ProtoMasterDetail",{extend:"Ext.Panel",alias:"widget.protoMasterDetail",requires:["ProtoUL.view.ProtoGrid","ProtoUL.UI.TbMasterDetail"],editable:false,autoSync:true,autoEdit:true,isPromoted:false,mdFilter:[],initComponent:function(){this.myMeta=_SM._cllPCI[this.viewCode];var b=this;if(this.mdFilter){this.isPromoted=true}_SM.__StBar.showBusy("loading "+this.viewCode+"...","prMD.init",2000);this.protoMasterGrid=Ext.create("ProtoUL.view.ProtoGrid",{border:false,viewCode:this.viewCode,mdFilter:this.mdFilter,detailTitle:this.detailTitle,isPromoted:this.isPromoted,region:"center",flex:1,layout:"fit",collapsible:false});this.protoMasterStore=this.protoMasterGrid.store;this.pciStyle=this.protoMasterGrid.myMeta.pciStyle||"grid";var a=Ext.create("ProtoUL.UI.TbMasterDetail",{protoMeta:this.myMeta,__MasterDetail:b});this.protoMasterGrid._toolBar=a;this.protoTabs=Ext.create("Ext.panel.Panel",{layout:"card"});this.IDdetailPanel=Ext.id();Ext.apply(this,{layout:"border",border:false,defaults:{collapsible:true,border:false,split:true},tbar:a,items:[this.protoMasterGrid,{id:this.IDdetailPanel,collapseMode:"mini",hideCollapseTool:true,region:"south",header:false,border:false,flex:1,collapsed:true,layout:"fit",minSize:75,defaults:{border:false},items:this.protoTabs}]});this.ixActiveDetail=-1;this.idMasterGrid=-1;this.cllStoreDet=[];this.callParent();Ext.create("ProtoUL.UI.MDDetailsController",{__MasterDetail:b});Ext.create("ProtoUL.UI.MDTbSortByController",{myMeta:this.myMeta,__MasterDetail:b});Ext.create("ProtoUL.UI.MDPrintOptsController",{myMeta:this.myMeta,__MasterDetail:b});Ext.create("ProtoUL.UI.MDActionsController",{myMeta:this.myMeta,__MasterDetail:b});Ext.create("ProtoUL.UI.MDSetFiltersController",{myMeta:this.myMeta,__MasterDetail:b});Ext.create("ProtoUL.UI.MDSetSortersController",{myMeta:this.myMeta,__MasterDetail:b});Ext.create("ProtoUL.UI.MDSetTabsController",{myMeta:this.myMeta,__MasterDetail:b});Ext.create("ProtoUL.UI.ConfigController",{myMeta:this.myMeta,__MasterDetail:b});a.addActions();this.protoMasterGrid.on({selectionChange:{fn:function(f,c,e,d){if(c){this.idMasterGrid=c.get("id")}else{this.idMasterGrid=-1}this.linkDetail()},scope:b}})},linkDetail:function(){var c=this;if(c.ixActiveDetail<0){return}if(c.protoTabs.items.length===0){return}var e=c.cllStoreDet[c.ixActiveDetail];var a=e.detailDefinition;if(e.protoMasterId==c.idMasterGrid){return}var b;if(!c.protoMasterGrid.rowData){b=[{property:a.detailField,filterStmt:-1}]}else{var h=c.idMasterGrid;if(a.masterField!="pk"){h=c.protoMasterGrid.rowData[a.masterField]}b=[{property:a.detailField,filterStmt:h}]}e.myLoadData(b,null,c.idMasterGrid);var g=c.protoTabs.items.items[c.ixActiveDetail];var f=a.masterTitleField||"__str__";var d=c.protoMasterGrid.rowData;if(d){g.detailTitle=d[f]}g.protoFilter=b;g.setGridTitle(g);c.setDetDefaults(c,g)},mdGridReload:function(){this.protoMasterGrid.reload()},mdGridLoadData:function(a,b){this.protoMasterGrid.gridLoadData(this.protoMasterGrid,a,b)},showDetailPanel:function(b){var a=Ext.getCmp(this.IDdetailPanel);if(b){this.ixInactiveDetail=this.ixActiveDetail;this.ixActiveDetail=-1;a.collapse()}else{if(a.collapsed){if(this.ixActiveDetail<0){this.ixActiveDetail=this.ixInactiveDetail||0}this.linkDetail();a.expand()}}},hideDetailPanel:function(a){this.showDetailPanel(true)},isDetailCollapsed:function(){var a=Ext.getCmp(this.IDdetailPanel);if(!a){return true}return(a.collapsed)},setEditMode:function(g){var c=this;if(!c.autoEdit){d(c.tbFilters);d(c.tbPrinterOpts);d(c.tbConfigOpts);d(c.tbSorters);d(c.tbSortersSet);d(c.tbProtoActions)}else{g=c.autoEdit}c.protoMasterGrid.setEditMode(g);var b=null;try{b=c.protoTabs.items.items}catch(f){}if(b){for(var a in b){var h=b[a];if(!h.detailDefinition){continue}h.setEditMode(g)}}function d(j,e){if(e===undefined){e=g}if(j){j.setDisabled(e)}}},setDetDefaults:function(e,h){var b=h.detailDefinition,f=e.protoMasterGrid.rowData,d=b.detailField.replace(/__pk$/,"_id");var a=h.myFieldDict[d];if(!a||!f){return}a.prpDefault=e.idMasterGrid;d=b.masterTitleField||d.replace(/_id$/,"");var c=h.myFieldDict[d];if(c){var g=b.masterTitleField||"__str__";c.prpDefault=f[g];c.readOnly=true}},setAutoSync:function(a){this.autoSync=a},saveChanges:function(b){var d=this;if(this.isDetailCollapsed()){d.protoMasterGrid.saveChanges(b)}else{var c=d.protoTabs.items.items;for(var a in c){var e=c[a];e.saveChanges(b)}}},cancelChanges:function(){var c=this;if(this.isDetailCollapsed()){c.protoMasterGrid.cancelChanges()}else{var b=c.protoTabs.items.items;for(var a in b){var d=b[a];d.cancelChanges()}}}});Ext.define("ProtoUL.view.ProtoTabContainer",{extend:"Ext.tab.Panel",alias:"widget.protoTabContainer",border:false,initComponent:function(){_SM.__TabContainer=this;this.callParent()},addTabPanel:function(b,c,a){var e=_SM._cllPCI[b];var f=e.shortTitle;if(c){f="*"+f}var d=this.add({title:f,viewCode:b,border:false,tabConfig:{tooltip:f,width:120},iconCls:e.viewIcon,closable:true,layout:"fit",items:[this.createProtoMasterDetail(b,c,a)]});this.setActiveTab(d);Ext.resumeLayouts(true)},createProtoMasterDetail:function(b,c,a){var d=Ext.create("widget.protoMasterDetail",{viewCode:b,mdFilter:c,detailTitle:a});return d},closeProtoTab:function(b){for(var a=this.items.items.length;a--;){var c=this.items.items[a];if(c.viewCode==b){this.remove(c,true)}}},closeAllTabs:function(){for(var a=this.items.items.length;a--;){var b=this.items.items[a];this.remove(b,true)}Ext.destroy(Ext.ComponentQuery.query("protoZoom"));Ext.destroy(Ext.ComponentQuery.query("protoForm"));Ext.destroy(Ext.ComponentQuery.query("protoGrid"));Ext.destroy(Ext.ComponentQuery.query("protoMasterDetail"));Ext.destroy(Ext.ComponentQuery.query("protoLogin"));Ext.destroy(Ext.ComponentQuery.query("protoSearch"))}});_SM.closeTabListener=function(){var a="TODO:  liberar la memoria"};Ext.define("ProtoUL.view.Viewport",{extend:"Ext.Viewport",layout:"fit",initComponent:function(){Ext.apply(this,{layout:"border",autoRender:true,padding:5,defaults:{split:true},items:[this.createHeaderPanel(),this.createMenuPanel(),this.createProtoTabContainer(),this.createFooterPanel()]});this.callParent(arguments)},createFooterPanel:function(){_SM.__StBar=Ext.create("Ext.ux.StatusBar",{split:false,collapsible:false});var a=Ext.create("Ext.panel.Panel",{html:_SM.footerExtraContent,margins:"0 0 0 0",border:false,align:"middle",collapsible:true,split:true});var b=Ext.create("Ext.panel.Panel",{region:"south",header:false,collapsible:true,collapseMode:"mini",layout:{type:"vbox",align:"stretch"},defaults:{bodyStyle:"padding:15px",split:true},items:[_SM.__StBar,a]});return b},afterRender:function(){this.callParent(arguments);_SM.__StBar.showBusy("loading ... ","vPort",3000);for(var a in _SM._AUTOLOAD_PCI){this.loadPciFromMenu(_SM._AUTOLOAD_PCI[a])}_SM._mainWin=this},createHeaderPanel:function(){var a=Ext.create("Ext.panel.Panel",{html:'<div class="centre"><span class="title">'+_SM._siteTitle+'</span><br><span class="subtitle">'+_SM._versionProto+"</span></div>",margins:"0 0 0 0",border:false,align:"middle",split:true});var b=Ext.create("Ext.panel.Panel",{region:"north",header:false,collapsible:true,collapseMode:"mini",collapsed:_SM._siteTitleCollapsed,height:90,layout:{type:"vbox",align:"stretch"},defaults:{bodyStyle:"padding:15px",split:true},items:[a]});return b},createMenuPanel:function(){if(_SM._MENU_COLLAPSED==undefined){_SM._MENU_COLLAPSED=false}this.menuPanel={region:"west",width:300,title:_SM.__language.Title_Main_Menu,collapsible:true,collapsed:_SM._MENU_COLLAPSED,xtype:"menuTree"};return this.menuPanel},loadPciFromMenu:function(b){var a=b;var d=this;var c={scope:this,success:function(g,e,f){d.openProtoOption(a)},failure:function(g,e,f){return}};if(_SM.loadPci(a,true,c)){d.openProtoOption(a)}},openProtoOption:function(a){var b=this;var c=_SM._cllPCI[a];if(c.pciStyle=="form"){var d=Ext.create("ProtoUL.UI.FormController",{});d.openProtoForm.call(d,a,-1,true)}else{b.protoTabContainer.addTabPanel(a)}},createProtoTabContainer:function(){this.protoTabContainer=Ext.create("widget.protoTabContainer",{region:"center",border:false,minWidth:300});return this.protoTabContainer}});Ext.define("ProtoUL.view.password.PasswordReset",{extend:"Ext.form.Panel",alias:"widget.passwordForm",title:_SM.__language.Title_Window_Password_Change,floating:true,centered:true,closable:true,modal:true,width:400,height:200,bodyPadding:5,labelWidth:140,layout:"anchor",defaults:{anchor:"100%",enableKeyEvents:true},username:"",defaultType:"textfield",items:[{fieldLabel:_SM.__language.Textfield_User_Login,name:"login",value:this.username,listeners:{afterrender:function(a){a.focus(false,500)}}},{xtype:"textfield",fieldLabel:_SM.__language.Textfield_Password_Login,inputType:"password",name:"current",width:120},{fieldLabel:_SM.__language.Textfield_New_Password,name:"newPassword1",inputType:"password",allowBlank:false},{fieldLabel:_SM.__language.Textfield_Confirm_Password,name:"newPassword2",inputType:"password",allowBlank:false,listeners:{specialkey:function(b,c){if(c.getKey()==c.ENTER){var a=Ext.ComponentQuery.query("button[itemId=btChangePWD]")[0];a.fireEvent("click",a)}}}}],buttons:[{text:_SM.__language.Text_change_Password_Button,itemId:"btChangePWD",iconCls:"st-key-go",formBind:true,disabled:true,action:"changepassword"}],listeners:{afterlayout:function(){if(window.isPasswordReseted==="True"){setTimeout(function(){Ext.Msg.show({title:_SM.__language.Message_Success,msg:_SM.__language.Message_Email_New_Password,buttons:Ext.Msg.OK,icon:Ext.MessageBox.INFO})},1000)}}},renderTo:Ext.getBody()});Ext.define("ProtoUL.view.password.ForgotPasswordForm",{extend:"Ext.window.Window",alias:"widget.forgotPasswordForm",requires:["Ext.form.Panel","Ext.form.field.Text"],title:_SM.__language.Title_Window_Email_Request,height:160,width:400,layout:"fit",closable:true,initComponent:function(){this.items=[{xtype:"form",bodyPadding:25,centered:true,fieldDefaults:{anchor:"100%",labelAlign:"left",allowBlank:false,combineErrors:true,msgTarget:"side",labelWidth:80},items:[{xtype:"textfield",fieldLabel:_SM.__language.Textfield_User_Login,name:"login",allowBlank:false,flex:1,listeners:{afterrender:function(a){a.focus(false,500)},blur:function(){this.setValue(Ext.String.trim(this.getValue()))}}},{xtype:"textfield",fieldLabel:_SM.__language.Textfield_User_Email,name:"email",vtype:"email",allowBlank:false,flex:1,listeners:{specialkey:function(b,c){if(c.getKey()==c.ENTER){var a=Ext.ComponentQuery.query("button[itemId=btForgotPWDForm]")[0];a.fireEvent("click",a)}}}}]}];this.dockedItems=[{xtype:"toolbar",dock:"bottom",id:"buttons",ui:"footer",items:["->",{text:_SM.__language.Text_Send_Button,itemId:"btForgotPWDForm",iconCls:"st-key-go",action:"forgotpassword",}]}];this.callParent(arguments)}});Ext.define("ProtoUL.controller.PasswordManager",{extend:"Ext.app.Controller",views:["password.PasswordReset","password.ForgotPasswordForm"],init:function(){this.control({"passwordForm button[action=changepassword]":{click:this.changepassword},"forgotPasswordForm button[action=forgotpassword]":{click:this.forgotpassword},})},changepassword:function(a){var b=a.up("form").getForm();if(b.isValid()){a.setIconCls("st-loading");b.submit({url:_SM._PConfig.urlSubmitChangePassword,method:"POST",scope:this,success:function(c,d){Ext.Msg.alert("Success",_SM.__language.Message_Success_Password_Change,function(e){if(e=="ok"){Ext.destroy(Ext.ComponentQuery.query("passwordForm"));Ext.Ajax.request({url:"protoExt",success:function(){window.location="protoExt"}})}})},failure:function(c,d){Ext.Msg.alert("Failed",d.result.message)}})}},forgotpassword:function(a){var c=a.up("window"),b=c.down("form").getForm();if(b.isValid()){a.setIconCls("st-loading");b.submit({url:_SM._PConfig.urlGetPasswordRecovery,method:"POST",scope:this,success:function(d,e){Ext.Msg.alert(_SM.__language.Message_Success,_SM.__language.Message_Email_Forgotten_Password,function(f){if(f=="ok"){Ext.destroy(Ext.ComponentQuery.query("forgotPasswordForm"))}});a.setIconCls("st-key-go")},failure:function(d,e){Ext.Msg.show({title:_SM.__language.Message_Error,msg:e.response.statusText,buttons:Ext.Msg.OK,icon:Ext.MessageBox.WARNING});a.setIconCls("st-key-go")}})}}});Ext.Loader.setConfig({enabled:true});Ext.application({name:"ProtoUL",appFolder:"static/js",requires:["Ext.window.MessageBox","Ext.toolbar.Paging","Ext.layout.container.Border","Ext.util.Cookies","Ext.Ajax","ProtoUL.view.MenuTree","ProtoUL.view.ProtoTabContainer","ProtoUL.view.Viewport","ProtoUL.view.password.PasswordReset","ProtoUL.ux.Printer","ProtoUL.ux.GridHeaderToolTip","ProtoUL.ux.CheckColumn"],controllers:["PasswordManager"],launch:function(){var a=Ext.util.Cookies.get("csrftoken");if(!a){Ext.Error.raise("Missing csrftoken cookie")}else{Ext.Ajax.defaultHeaders=Ext.apply(Ext.Ajax.defaultHeaders||{},{"X-CSRFToken":a})}Ext.QuickTips.init();if(window.isPasswordReseted==="True"){this.showResetPasswordForm()}else{this.showLogin()}},showLogin:function(){var b=this;var a={scope:b,success:function(f,d,e){c.hide();Ext.grid.RowEditor.prototype.saveBtnText=_SM.__language.Text_Save_Button;Ext.grid.RowEditor.prototype.cancelBtnText=_SM.__language.Text_Cancel_Button;var g=new ProtoUL.view.Viewport();Ext.destroy(Ext.ComponentQuery.query("protoLogin"))}};var c=Ext.widget("window",{constrain:true,iconCls:"st-user-who",title:"ART - Identification",layout:"fit",width:450,height:135,modal:true,items:[{xtype:"protoLogin",options:a}]});c.show()},showResetPasswordForm:function(){var a=Ext.create("ProtoUL.view.password.PasswordReset");a.show()}});
